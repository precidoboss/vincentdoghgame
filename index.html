<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Erol's Martian Gambit</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --mars-red: #ff4d4d;
            --mars-dark: #1a0a0a;
            --mars-glow: rgba(255, 77, 77, 0.3);
        }
        body {
            background-color: var(--mars-dark);
            color: #e0e0e0;
            font-family: 'Rajdhani', sans-serif;
            background-image: radial-gradient(circle at 50% 50%, #2c1010 0%, #000 100%);
        }
        .orbitron { font-family: 'Orbitron', sans-serif; }
        .mars-border { border: 1px solid var(--mars-red); }
        .mars-button {
            background: linear-gradient(45deg, #8b0000, #ff4d4d);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .mars-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 0 15px var(--mars-glow);
        }
        .mars-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .card {
            background: rgba(40, 10, 10, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 77, 77, 0.2);
            border-radius: 12px;
        }
        .move-btn {
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .move-btn.selected {
            border-color: var(--mars-red);
            background: rgba(255, 77, 77, 0.2);
        }
        .status-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            text-transform: uppercase;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <!-- Header & Wallet -->
    <header class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center mb-12">
        <div class="text-center md:text-left mb-6 md:mb-0">
            <h1 class="orbitron text-4xl font-bold text-red-500 tracking-tighter">EROL'S MARTIAN GAMBIT</h1>
            <p class="text-gray-400 text-sm italic">High-Stakes Tactical Strategy on Martian L1</p>
        </div>
        <div id="wallet-section" class="flex flex-col items-end">
            <button id="connect-btn" class="mars-button orbitron px-6 py-2 rounded-full font-bold">Connect Uplink</button>
            <div id="account-info" class="hidden text-right">
                <p id="user-address" class="text-xs text-red-400 font-mono"></p>
                <p id="user-balance" class="text-lg font-bold">0.00 $EROL</p>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <!-- Create Game Section -->
        <section class="lg:col-span-4 flex flex-col gap-6">
            <div class="card p-6">
                <h2 class="orbitron text-xl mb-4 text-white border-b border-red-900 pb-2">Initialize Signal</h2>
                
                <label class="block text-xs uppercase text-gray-400 mb-1">Select Tactical Move</label>
                <div class="grid grid-cols-3 gap-2 mb-4">
                    <button onclick="selectMove(1)" id="move-1" class="move-btn p-3 bg-black/40 rounded flex flex-col items-center">
                        <span class="text-2xl">‚òÄÔ∏è</span>
                        <span class="text-[10px] mt-1 uppercase">Solar Flare</span>
                    </button>
                    <button onclick="selectMove(2)" id="move-2" class="move-btn p-3 bg-black/40 rounded flex flex-col items-center">
                        <span class="text-2xl">üå¨Ô∏è</span>
                        <span class="text-[10px] mt-1 uppercase">Oxygen Siphon</span>
                    </button>
                    <button onclick="selectMove(3)" id="move-3" class="move-btn p-3 bg-black/40 rounded flex flex-col items-center">
                        <span class="text-2xl">üå™Ô∏è</span>
                        <span class="text-[10px] mt-1 uppercase">Dust Storm</span>
                    </button>
                </div>

                <label class="block text-xs uppercase text-gray-400 mb-1">Wager Amount ($EROL)</label>
                <input id="wager-amount" type="number" step="0.1" value="1.0" class="w-full bg-black/60 border border-red-900 rounded p-2 mb-6 text-white focus:outline-none focus:border-red-500">
                
                <button id="create-btn" onclick="handleCreateGame()" class="mars-button w-full py-3 rounded font-bold orbitron">Deploy Signal</button>
            </div>

            <div class="card p-4 text-xs text-gray-400">
                <h3 class="text-red-400 font-bold mb-2 uppercase">The Tactical Triangle</h3>
                <p>‚òÄÔ∏è Solar Flare evaporates üå¨Ô∏è Oxygen Siphon</p>
                <p>üå¨Ô∏è Oxygen Siphon clears üå™Ô∏è Dust Storm</p>
                <p>üå™Ô∏è Dust Storm blocks ‚òÄÔ∏è Solar Flare</p>
            </div>
        </section>

        <!-- Active Lobby -->
        <section class="lg:col-span-8">
            <div class="card p-6 min-h-[400px]">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="orbitron text-xl text-white">Active Signals</h2>
                    <button onclick="refreshLobby()" class="text-xs text-red-400 hover:text-white transition">‚ü≥ Sync Lobby</button>
                </div>
                
                <div id="lobby-list" class="space-y-4">
                    <!-- Dynamic Game Items -->
                    <div class="text-center py-10 text-gray-500 italic">Scanning Martian frequencies for signals...</div>
                </div>
            </div>
        </section>
    </main>

    <!-- UI Feedback Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-red-600 text-white px-6 py-3 rounded shadow-2xl transform translate-y-20 transition-transform duration-300 pointer-events-none">
        Message Here
    </div>

    <script>
        const CHAIN_ID = "0x7EB"; // 2027
        const RPC_URL = "https://martian-rpc1.amichain.org/";
        const CONTRACT_ADDR = "0x0b912a321801B2f6062b4BdC3d9763e643584074";
        const TOKEN_ADDR = "0xcac4904e1db1589aa17a2ec742f5a6bcf4c4d037";

        const ABI = [
            "function createGame(bytes32 _hash) external payable",
            "function challengeGame(uint256 _gameId, uint8 _move) external payable",
            "function resolveGame(uint256 _gameId, uint8 _move, string calldata _salt) external",
            "function forceForfeit(uint256 _gameId) external",
            "function refundUnchallenged(uint256 _gameId) external",
            "function gameCounter() public view returns (uint256)",
            "function games(uint256) public view returns (address host, address challenger, bytes32 commitHash, uint8 hostMove, uint8 challengerMove, uint256 wager, uint256 timestamp, uint8 status)",
            "event GameCreated(uint256 indexed gameId, address indexed host, uint256 wager)",
            "event GameChallenged(uint256 indexed gameId, address indexed challenger)",
            "event GameResolved(uint256 indexed gameId, address winner, uint256 payout)"
        ];

        let provider, signer, contract, userAddress;
        let selectedMoveIdx = 0;

        // Initialize
        async function init() {
            if (window.ethereum) {
                provider = new ethers.BrowserProvider(window.ethereum);
                document.getElementById('connect-btn').addEventListener('click', connectWallet);
                refreshLobby();
            } else {
                showToast("Install MetaMask to access Martian Chain.");
            }
        }

        async function connectWallet() {
            try {
                // Request Network Switch
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: CHAIN_ID }],
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: CHAIN_ID,
                                chainName: 'Martian Chain',
                                nativeCurrency: { name: 'EROL', symbol: 'EROL', decimals: 18 },
                                rpcUrls: [RPC_URL],
                                blockExplorerUrls: ['https://explorer.martianchain.com/']
                            }],
                        });
                    }
                }

                const accounts = await provider.send("eth_requestAccounts", []);
                userAddress = accounts[0];
                signer = await provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDR, ABI, signer);

                document.getElementById('connect-btn').classList.add('hidden');
                document.getElementById('account-info').classList.remove('hidden');
                document.getElementById('user-address').innerText = userAddress;
                
                updateBalance();
                refreshLobby();
            } catch (err) {
                console.error(err);
                showToast("Connection Failed");
            }
        }

        async function updateBalance() {
            const balance = await provider.getBalance(userAddress);
            document.getElementById('user-balance').innerText = `${parseFloat(ethers.formatEther(balance)).toFixed(2)} $EROL`;
        }

        function selectMove(idx) {
            selectedMoveIdx = idx;
            document.querySelectorAll('.move-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById(`move-${idx}`).classList.add('selected');
        }

        function generateSalt() {
            return ethers.hexlify(ethers.randomBytes(16));
        }

        async function handleCreateGame() {
            if (!signer) return showToast("Connect wallet first!");
            if (selectedMoveIdx === 0) return showToast("Select a move!");
            
            const wager = document.getElementById('wager-amount').value;
            if (!wager || wager <= 0) return showToast("Enter valid wager");

            const salt = generateSalt();
            // Hash: keccak256(abi.encodePacked(_move, _salt, game.host))
            // We use Solitidy-tight packing logic via ethers
            const moveValue = selectedMoveIdx;
            
            // Note: The contract expects keccak256(abi.encodePacked(move, salt, msg.sender))
            const hash = ethers.solidityPackedKeccak256(
                ["uint8", "string", "address"],
                [moveValue, salt, userAddress]
            );

            try {
                showToast("Broadcasting Signal...");
                const tx = await contract.createGame(hash, { value: ethers.parseEther(wager) });
                
                // Store local secret
                const pendingGames = JSON.parse(localStorage.getItem('martian_gambits') || '{}');
                // We'll map the TX hash temporarily until we get the ID from logs
                pendingGames[tx.hash] = { move: moveValue, salt: salt };
                localStorage.setItem('martian_gambits', JSON.stringify(pendingGames));

                await tx.wait();
                showToast("Signal Deployed!");
                updateBalance();
                refreshLobby();
            } catch (err) {
                console.error(err);
                showToast("Deployment Failed");
            }
        }

        async function refreshLobby() {
            if (!contract) return;
            const lobby = document.getElementById('lobby-list');
            lobby.innerHTML = '<div class="text-center py-10 animate-pulse text-red-400">Scanning for signals...</div>';

            try {
                const counter = await contract.gameCounter();
                const gamePromises = [];
                // Load last 10 games for the demo
                const start = Number(counter) > 10 ? Number(counter) - 9 : 1;
                for (let i = Number(counter); i >= start; i--) {
                    gamePromises.push(contract.games(i).then(g => ({ ...g, id: i })));
                }

                const games = await Promise.all(gamePromises);
                lobby.innerHTML = "";

                if (games.length === 0) {
                    lobby.innerHTML = '<div class="text-center py-10 text-gray-500">Silence on all frequencies.</div>';
                    return;
                }

                games.forEach(game => {
                    if (game.status > 1 && game.host.toLowerCase() !== userAddress?.toLowerCase() && game.challenger.toLowerCase() !== userAddress?.toLowerCase()) return;
                    
                    const div = document.createElement('div');
                    div.className = "card p-4 flex flex-col md:flex-row justify-between items-center gap-4 border-l-4 " + getStatusColor(game.status);
                    
                    const wager = ethers.formatEther(game.wager);
                    const isHost = userAddress && game.host.toLowerCase() === userAddress.toLowerCase();
                    const isChallenger = userAddress && game.challenger.toLowerCase() === userAddress.toLowerCase();
                    
                    div.innerHTML = `
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="status-badge ${getStatusBg(game.status)}">${getStatusText(game.status)}</span>
                                <span class="text-xs text-gray-500">#${game.id}</span>
                            </div>
                            <p class="text-sm font-bold text-white">${wager} $EROL Pool</p>
                            <p class="text-[10px] text-gray-500 font-mono">${game.host.substring(0,12)}...</p>
                        </div>
                        <div class="flex gap-2">
                            ${getActionButtons(game, isHost, isChallenger)}
                        </div>
                    `;
                    lobby.appendChild(div);
                });

            } catch (err) {
                console.error(err);
                lobby.innerHTML = '<div class="text-center py-10 text-red-500">Error syncing with Martian Chain.</div>';
            }
        }

        function getActionButtons(game, isHost, isChallenger) {
            // Status: 0:Open, 1:Challenged, 2:Resolved, 3:Refunded, 4:Forfeited
            if (game.status == 0) {
                if (isHost) return `<button onclick="handleRefund(${game.id})" class="text-[10px] border border-gray-600 px-3 py-1 rounded hover:bg-white/10">Reclaim</button>`;
                return `<button onclick="handleChallenge(${game.id})" class="mars-button text-[10px] px-4 py-2 rounded font-bold">Accept Gambit</button>`;
            }
            if (game.status == 1) {
                if (isHost) return `<button onclick="handleResolve(${game.id})" class="bg-green-600 text-white text-[10px] px-4 py-2 rounded font-bold animate-bounce">Reveal Move</button>`;
                if (isChallenger) return `<span class="text-[10px] text-yellow-500 italic">Waiting for Reveal...</span>`;
                return `<span class="text-[10px] text-gray-600">Locked Combat</span>`;
            }
            return `<span class="text-[10px] text-gray-500">Archived</span>`;
        }

        async function handleChallenge(id) {
            if (!signer) return showToast("Connect wallet");
            const move = prompt("Enter Move: 1 (Solar Flare), 2 (Oxygen Siphon), 3 (Dust Storm)");
            if (![1, 2, 3].includes(Number(move))) return showToast("Invalid Move");

            try {
                const g = await contract.games(id);
                showToast("Entering the Gambit...");
                const tx = await contract.challengeGame(id, move, { value: g.wager });
                await tx.wait();
                showToast("Challenge Accepted!");
                refreshLobby();
            } catch (err) {
                showToast("Challenge Failed");
            }
        }

        async function handleResolve(id) {
            const secrets = JSON.parse(localStorage.getItem('martian_gambits') || '{}');
            // This is a simplified lookup. In production, we'd index the local storage by gameId
            // For now, we look for the most recent compatible secret or prompt the user.
            let mySecret = Object.values(secrets)[0]; // Placeholder logic
            
            if (!mySecret) {
                const move = prompt("Recovery: What was your move? (1, 2, or 3)");
                const salt = prompt("Recovery: Enter your Salt (found in local storage)");
                mySecret = { move, salt };
            }

            try {
                showToast("Revealing Truth...");
                const tx = await contract.resolveGame(id, mySecret.move, mySecret.salt);
                await tx.wait();
                showToast("Game Resolved!");
                refreshLobby();
            } catch (err) {
                showToast("Reveal Error - Check salt/move");
            }
        }

        async function handleRefund(id) {
            try {
                const tx = await contract.refundUnchallenged(id);
                await tx.wait();
                showToast("Funds Returned");
                refreshLobby();
            } catch (err) {
                showToast("Timeout not reached?");
            }
        }

        // Helper UI functions
        function getStatusText(s) { return ["Open", "Challenged", "Resolved", "Refunded", "Forfeited"][s]; }
        function getStatusBg(s) { return ["bg-blue-900", "bg-yellow-900", "bg-green-900", "bg-gray-800", "bg-red-900"][s]; }
        function getStatusColor(s) { return ["border-blue-500", "border-yellow-500", "border-green-500", "border-gray-500", "border-red-500"][s]; }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('translate-y-20');
            setTimeout(() => t.classList.add('translate-y-20'), 3000);
        }

        window.onload = init;
    </script>
</body>
</html>
