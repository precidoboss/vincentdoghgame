<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Grotto Gambit | Dark Sanctum</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300&display=swap" rel="stylesheet">
    <style>
        :root {
            --grotto-purple: #9333ea;
            --grotto-deep: #4c1d95;
            --grotto-dark: #1a0a2e;
            --grotto-darker: #0d0517;
            --grotto-glow: rgba(147, 51, 234, 0.4);
            --grotto-light: #c084fc;
            --heresy-gold: #fbbf24;
            --arcane-gold: #ffd700;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, var(--grotto-darker) 0%, var(--grotto-dark) 50%, #1e1b4b 100%);
            color: #e9d5ff;
            font-family: 'Cormorant Garamond', serif;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(147, 51, 234, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(168, 85, 247, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(109, 40, 217, 0.05) 0%, transparent 40%);
            pointer-events: none;
            z-index: 0;
        }

        .cinzel { font-family: 'Cinzel', serif; }
        
        .grotto-glass {
            background: rgba(13, 5, 23, 0.85);
            border: 1px solid rgba(147, 51, 234, 0.3);
            box-shadow: 0 8px 32px rgba(147, 51, 234, 0.15);
            backdrop-filter: blur(12px);
            position: relative;
        }

        .grotto-border-glow {
            border: 1px solid var(--grotto-purple);
            box-shadow: 0 0 20px var(--grotto-glow), inset 0 0 20px rgba(147, 51, 234, 0.1);
        }

        .btn-grotto {
            background: linear-gradient(135deg, var(--grotto-purple) 0%, var(--grotto-deep) 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(147, 51, 234, 0.5);
        }

        .btn-grotto::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-grotto:hover:not(:disabled)::before {
            width: 300px;
            height: 300px;
        }

        .btn-grotto:hover:not(:disabled) {
            box-shadow: 0 0 30px var(--grotto-glow), 0 0 60px rgba(147, 51, 234, 0.3);
            transform: translateY(-2px);
            border-color: var(--grotto-light);
        }

        .btn-grotto:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .move-select {
            border: 2px solid rgba(147, 51, 234, 0.2);
            background: rgba(13, 5, 23, 0.6);
            transition: all 0.4s ease;
            position: relative;
        }

        .move-select::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, transparent 0%, rgba(147, 51, 234, 0.1) 100%);
            opacity: 0;
            transition: opacity 0.4s;
        }

        .move-select:hover::after {
            opacity: 1;
        }

        .move-select.selected {
            border-color: var(--grotto-purple);
            background: rgba(147, 51, 234, 0.2);
            box-shadow: 0 0 30px var(--grotto-glow), inset 0 0 20px rgba(147, 51, 234, 0.2);
            transform: scale(1.05);
        }

        .move-select.selected::after {
            opacity: 1;
        }

        .mystical-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) translateX(0); opacity: 0.3; }
            50% { transform: translateY(-20px) translateX(10px); opacity: 0.6; }
        }

        .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: var(--grotto-purple);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--grotto-purple);
            animation: float linear infinite;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--grotto-darker); }
        ::-webkit-scrollbar-thumb { 
            background: linear-gradient(180deg, var(--grotto-purple) 0%, var(--grotto-deep) 100%);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover { background: var(--grotto-light); }

        .tab-btn {
            color: #6b7280;
            background: transparent;
            transition: all 0.3s;
            position: relative;
        }

        .tab-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 2px;
            background: var(--grotto-purple);
            transition: all 0.3s;
            transform: translateX(-50%);
        }

        .tab-btn:hover {
            color: var(--grotto-light);
        }

        .tab-btn.active {
            color: var(--grotto-purple);
            background: rgba(147, 51, 234, 0.1);
        }

        .tab-btn.active::after {
            width: 80%;
        }

        .lobby-filter {
            color: #6b7280;
            background: transparent;
            transition: all 0.3s;
        }

        .lobby-filter:hover {
            color: var(--grotto-light);
            background: rgba(147, 51, 234, 0.05);
        }

        .lobby-filter.active {
            color: var(--grotto-purple);
            background: rgba(147, 51, 234, 0.2);
            box-shadow: inset 0 0 10px rgba(147, 51, 234, 0.3);
        }

        .page-section {
            display: none;
            position: relative;
            z-index: 2;
        }

        .page-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header-banner {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-bottom: 3px solid var(--grotto-purple);
            box-shadow: 0 10px 40px rgba(147, 51, 234, 0.3);
        }

        .game-logo {
            width: 80px;
            height: 80px;
            object-fit: contain;
            border-radius: 12px;
            border: 2px solid var(--grotto-purple);
            box-shadow: 0 0 20px var(--grotto-glow);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px;
        }

        .chat-messages {
            height: 400px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .activity-feed {
            height: 500px;
            overflow-y: auto;
        }

        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px rgba(220, 38, 38, 0.5);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .notification-panel {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 350px;
            max-height: 500px;
            overflow-y: auto;
            display: none;
            z-index: 1001;
        }

        .notification-panel.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .notification-item {
            border-left: 3px solid var(--grotto-purple);
            transition: all 0.3s;
        }

        .notification-item:hover {
            background: rgba(147, 51, 234, 0.1);
            transform: translateX(5px);
        }

        .notification-item.win {
            border-left-color: #22c55e;
        }

        .notification-item.loss {
            border-left-color: #ef4444;
        }

        .notification-item.challenge {
            border-left-color: #f59e0b;
        }

        .stat-card {
            background: rgba(13, 5, 23, 0.6);
            border: 1px solid rgba(147, 51, 234, 0.3);
            transition: all 0.4s;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(147, 51, 234, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s;
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card:hover {
            border-color: var(--grotto-purple);
            box-shadow: 0 0 30px var(--grotto-glow);
            transform: translateY(-5px);
        }

        .achievement-card {
            background: rgba(13, 5, 23, 0.7);
            border: 2px solid rgba(147, 51, 234, 0.3);
            transition: all 0.3s;
            position: relative;
        }

        .achievement-card.completed {
            border-color: var(--heresy-gold);
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
        }

        .achievement-card.claimed {
            opacity: 0.6;
            border-color: rgba(107, 114, 128, 0.3);
        }

        /* PREMIUM PROFILE STYLES - ARCANE ASCENDANCE */
        .premium-profile {
            position: relative;
            border: 3px solid var(--arcane-gold) !important;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.05) 0%, rgba(147, 51, 234, 0.1) 100%) !important;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.4), inset 0 0 40px rgba(255, 215, 0, 0.1) !important;
            animation: arcaneGlow 3s ease-in-out infinite;
        }

        @keyframes arcaneGlow {
            0%, 100% { box-shadow: 0 0 40px rgba(255, 215, 0, 0.4), inset 0 0 40px rgba(255, 215, 0, 0.1); }
            50% { box-shadow: 0 0 60px rgba(255, 215, 0, 0.6), inset 0 0 60px rgba(255, 215, 0, 0.2); }
        }

        .premium-name {
            color: var(--arcane-gold) !important;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8), 0 0 20px rgba(255, 215, 0, 0.5);
            font-weight: 900 !important;
            animation: shimmer 2s linear infinite;
            background: linear-gradient(90deg, #ffd700 0%, #ffed4e 50%, #ffd700 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 200% 100%;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .arcane-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            border-radius: inherit;
        }

        .arcane-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--arcane-gold);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--arcane-gold);
            animation: floatGold linear infinite;
        }

        @keyframes floatGold {
            0% { transform: translateY(100%) translateX(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100%) translateX(20px); opacity: 0; }
        }

        .premium-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--arcane-gold) 0%, #ffed4e 100%);
            color: var(--grotto-darker);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 900;
            letter-spacing: 1px;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
            animation: badgePulse 2s ease-in-out infinite;
        }

        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .challenge-card {
            background: rgba(13, 5, 23, 0.8);
            border: 2px solid rgba(147, 51, 234, 0.3);
            transition: all 0.3s;
        }

        .challenge-card.pending {
            border-color: #f59e0b;
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
        }

        .challenge-card.accepted {
            border-color: #22c55e;
        }

        .challenge-card.declined {
            opacity: 0.5;
            border-color: #6b7280;
        }

        .marketplace-item {
            background: rgba(13, 5, 23, 0.8);
            border: 2px solid rgba(147, 51, 234, 0.3);
            transition: all 0.4s;
            position: relative;
            overflow: hidden;
        }

        .marketplace-item::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s;
        }

        .marketplace-item:hover::before {
            opacity: 1;
        }

        .marketplace-item:hover {
            border-color: var(--heresy-gold);
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.4);
            transform: translateY(-5px);
        }

        .cosmetic-item {
            background: rgba(13, 5, 23, 0.7);
            border: 2px solid rgba(147, 51, 234, 0.3);
            transition: all 0.3s;
            cursor: pointer;
        }

        .cosmetic-item:hover {
            border-color: var(--grotto-purple);
            box-shadow: 0 0 20px var(--grotto-glow);
            transform: scale(1.03);
        }

        .cosmetic-item.owned {
            border-color: #22c55e;
            opacity: 0.7;
        }

        .cosmetic-item.equipped {
            border-color: var(--arcane-gold);
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.4);
        }

        @media (max-width: 768px) {
            .header-banner { height: 150px; }
            .game-logo { width: 60px; height: 60px; }
            .chat-messages { height: 300px; }
            .notification-panel { 
                width: calc(100vw - 40px); 
                right: 20px; 
                left: 20px;
                top: 70px;
            }
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--grotto-purple) !important;
            box-shadow: 0 0 20px var(--grotto-glow);
        }

        /* Loading State */
        .loading {
            opacity: 0.5;
            pointer-events: none;
            position: relative;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            border: 2px solid var(--grotto-purple);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            transform: translate(-50%, -50%);
        }

        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen p-4">
    <!-- Continue in part 2 -->
<!-- PART 2: NAVIGATION + LOBBY STRUCTURE - Insert after <body> tag from part 1 -->

    <!-- Mystical Particles -->
    <div class="mystical-particles" id="particles"></div>

    <!-- Header Banner -->
    <div class="max-w-7xl mx-auto mb-6 relative z-10">
        <img src="https://raw.githubusercontent.com/precidoboss/my-game-sprites/main/photo_2026-02-11_07-20-57.jpg" 
             alt="The Grotto Gambit Header" 
             class="header-banner rounded-lg"
             onerror="this.style.display='none'">
    </div>

    <nav class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center mb-8 py-6 border-b border-purple-900/30 relative z-10">
        <div class="flex items-center gap-6">
            <img src="https://raw.githubusercontent.com/precidoboss/my-game-sprites/main/photo_2026-02-11_07-20-45.jpg" 
                 alt="Grotto Logo" 
                 class="game-logo"
                 onerror="this.style.display='none'">
            <div>
                <h1 class="cinzel text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-purple-600 tracking-wider">
                    THE GROTTO GAMBIT
                </h1>
                <p class="text-[11px] text-purple-500/60 uppercase tracking-[0.3em] mt-1">Dark Sanctum // Heresy Protocol V3</p>
            </div>
        </div>

        <div class="flex items-center gap-6 mt-4 md:mt-0 flex-wrap">
            <!-- Navigation Tabs -->
            <div class="flex gap-1 bg-black/40 p-1 border border-purple-900/30 rounded-lg flex-wrap">
                <button onclick="switchTab('lobby')" id="tab-lobby" class="tab-btn active px-4 py-2 text-[10px] uppercase transition rounded cinzel">Sanctum</button>
                <button onclick="switchTab('marketplace')" id="tab-marketplace" class="tab-btn px-4 py-2 text-[10px] uppercase transition rounded cinzel">Bazaar</button>
                <button onclick="switchTab('bloodrite')" id="tab-bloodrite" class="tab-btn px-4 py-2 text-[10px] uppercase transition rounded cinzel">Blood Rite</button>
                <button onclick="switchTab('leaderboard')" id="tab-leaderboard" class="tab-btn px-4 py-2 text-[10px] uppercase transition rounded cinzel">Pantheon</button>
                <button onclick="switchTab('profile')" id="tab-profile" class="tab-btn px-4 py-2 text-[10px] uppercase transition rounded cinzel">Chronicle</button>
                <button onclick="switchTab('howto')" id="tab-howto" class="tab-btn px-4 py-2 text-[10px] uppercase transition rounded cinzel">Doctrine</button>
            </div>

            <!-- Notification Bell -->
            <div class="relative">
                <button id="notification-btn" onclick="toggleNotifications()" class="relative p-3 rounded-full hover:bg-purple-900/20 transition">
                    <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                    <span id="notification-badge" class="notification-badge hidden">0</span>
                </button>
                
                <!-- Notification Panel -->
                <div id="notification-panel" class="notification-panel grotto-glass rounded-lg shadow-2xl">
                    <div class="p-4 border-b border-purple-900/30 flex justify-between items-center">
                        <h3 class="cinzel font-bold text-purple-400">Omens & Portents</h3>
                        <button onclick="markAllRead()" class="text-xs text-purple-500 hover:text-purple-300 transition uppercase tracking-wider">
                            Mark Read
                        </button>
                    </div>
                    <div id="notification-list" class="max-h-96 overflow-y-auto">
                        <div class="p-8 text-center text-purple-700/50 italic">
                            No omens to reveal...
                        </div>
                    </div>
                </div>
            </div>

            <div id="connection-interface">
                <button id="connect-btn" class="btn-grotto px-8 py-3 rounded-lg cinzel relative z-10">Summon Portal</button>
                <div id="account-info" class="hidden flex items-center gap-4">
                    <div class="text-right">
                        <div class="flex items-center gap-2">
                            <span id="user-address" class="text-[11px] text-purple-400/70 tracking-wider"></span>
                            <button id="copy-address" class="text-purple-400 hover:text-purple-300 transition text-sm" onclick="copyAddress()" title="Copy Address">
                                üìã
                            </button>
                        </div>
                        <div id="user-balance" class="cinzel text-purple-400 font-bold text-lg">0.00000 $HERESY</div>
                    </div>
                    <div class="h-12 w-1 bg-gradient-to-b from-purple-600 to-purple-900"></div>
                </div>
            </div>
        </div>
    </nav>

    <script>
        // Generate mystical particles
        function createParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
                particle.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(particle);
            }
        }
        createParticles();
    </script>

    <main class="max-w-7xl mx-auto relative z-10">
        <!-- LOBBY PAGE (SANCTUM) -->
        <div id="page-lobby" class="page-section active">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <aside class="lg:col-span-4 space-y-6">
                    <!-- Create Game Panel -->
                    <div class="grotto-glass p-6 rounded-xl">
                        <h2 class="cinzel text-sm text-purple-400 mb-6 flex items-center gap-3 tracking-widest">
                            <span class="w-3 h-3 bg-purple-500 rounded-full animate-pulse shadow-lg shadow-purple-500/50"></span>
                            INVOKE DARK RITUAL
                        </h2>

                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <button onclick="selectMove(1)" id="move-1" class="move-select p-5 rounded-lg flex flex-col items-center cursor-pointer group">
                                <img src="https://raw.githubusercontent.com/precidoboss/my-game-sprites/main/photo_3_2026-02-11_10-02-39.jpg" alt="Greg" class="w-16 h-16 mb-2 group-hover:scale-110 transition-transform object-contain">
                                <span class="text-[10px] uppercase tracking-wider text-purple-300">Greg</span>
                            </button>
                            <button onclick="selectMove(2)" id="move-2" class="move-select p-5 rounded-lg flex flex-col items-center cursor-pointer group">
                                <img src="https://raw.githubusercontent.com/precidoboss/my-game-sprites/main/photo_2_2026-02-11_10-02-39.jpg" alt="Bob" class="w-16 h-16 mb-2 group-hover:scale-110 transition-transform object-contain">
                                <span class="text-[10px] uppercase tracking-wider text-purple-300">Bob</span>
                            </button>
                            <button onclick="selectMove(3)" id="move-3" class="move-select p-5 rounded-lg flex flex-col items-center cursor-pointer group">
                                <img src="https://raw.githubusercontent.com/precidoboss/my-game-sprites/main/photo_1_2026-02-11_10-02-39.jpg" alt="Disco" class="w-16 h-16 mb-2 group-hover:scale-110 transition-transform object-contain">
                                <span class="text-[10px] uppercase tracking-wider text-purple-300">Disco</span>
                            </button>
                        </div>

                        <div class="space-y-5">
                            <div>
                                <label class="text-[11px] text-purple-400/70 uppercase mb-3 block tracking-widest cinzel">Heresy Wager</label>
                                <input id="wager-amount" type="number" step="0.00001" value="1.00000" 
                                    class="w-full bg-black/50 border border-purple-900/50 p-4 text-purple-300 rounded-lg cinzel text-lg transition">
                            </div>
                            <div>
                                <label class="text-[11px] text-purple-400/70 uppercase mb-3 block tracking-widest cinzel">Dark Timeout</label>
                                <select id="timeout-select" 
                                    class="w-full bg-black/50 border border-purple-900/50 p-4 text-purple-300 rounded-lg cinzel transition">
                                    <option value="300">5 Minutes</option>
                                    <option value="600">10 Minutes</option>
                                    <option value="900" selected>15 Minutes</option>
                                    <option value="1800">30 Minutes</option>
                                    <option value="3600">1 Hour</option>
                                    <option value="86400">1 Day</option>
                                    <option value="259200">3 Days</option>
                                    <option value="604800">7 Days</option>
                                </select>
                            </div>
                            <button id="create-btn" onclick="handleCreateGame()" class="btn-grotto w-full py-4 text-base rounded-lg cinzel relative z-10">
                                Invoke Ritual
                            </button>
                        </div>
                    </div>

                    <!-- Custom Challenge Panel -->
                    <div class="grotto-glass p-6 rounded-xl border-2 border-yellow-600/30">
                        <h2 class="cinzel text-sm text-yellow-400 mb-6 flex items-center gap-3 tracking-widest">
                            <span class="w-3 h-3 bg-yellow-500 rounded-full animate-pulse shadow-lg shadow-yellow-500/50"></span>
                            CHALLENGE SPECIFIC SOUL
                        </h2>

                        <div class="space-y-4">
                            <div>
                                <label class="text-[11px] text-yellow-400/70 uppercase mb-2 block tracking-widest cinzel">Target Address</label>
                                <input id="challenge-target" type="text" placeholder="0x..." 
                                    class="w-full bg-black/50 border border-yellow-900/50 p-3 text-yellow-300 rounded-lg text-sm transition">
                            </div>
                            <div>
                                <label class="text-[11px] text-yellow-400/70 uppercase mb-2 block tracking-widest cinzel">Challenge Message</label>
                                <textarea id="challenge-message" maxlength="200" rows="3" placeholder="Your challenge message..."
                                    class="w-full bg-black/50 border border-yellow-900/50 p-3 text-yellow-300 rounded-lg text-sm transition resize-none"></textarea>
                            </div>
                            <button onclick="createCustomChallenge()" class="btn-grotto w-full py-3 text-sm rounded-lg cinzel bg-gradient-to-r from-yellow-600 to-yellow-800">
                                Send Challenge
                            </button>
                        </div>
                    </div>

                    <!-- Global Chat -->
                    <div class="grotto-glass p-6 rounded-xl">
                        <h2 class="cinzel text-sm text-purple-400 mb-4 flex items-center gap-3 tracking-widest">
                            <span class="w-3 h-3 bg-purple-500 rounded-full animate-pulse shadow-lg shadow-purple-500/50"></span>
                            MYSTIC WHISPERS
                        </h2>
                        <div id="chat-messages" class="chat-messages mb-4 bg-black/40 border border-purple-900/30 rounded-lg p-4 space-y-3"></div>
                        <div class="flex gap-2">
                            <input id="chat-input" type="text" placeholder="Whisper into the void..." maxlength="200" 
                                class="flex-1 bg-black/50 border border-purple-900/50 p-3 text-sm text-purple-300 rounded-lg transition" 
                                onkeypress="if(event.key==='Enter') sendMessage()">
                            <button onclick="sendMessage()" class="btn-grotto px-5 py-2 text-xs rounded-lg cinzel">Send</button>
                        </div>
                    </div>
                </aside>

                <section class="lg:col-span-8 space-y-6">
                    <!-- Game Lobby -->
                    <div class="grotto-glass p-6 rounded-xl min-h-[500px]">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 border-b border-purple-900/20 pb-4 gap-4">
                            <h2 class="cinzel text-xl text-purple-300 tracking-widest flex items-center gap-3">
                                DARK FREQUENCIES
                                <span class="text-[10px] bg-purple-900/30 px-3 py-1 text-purple-500 rounded-full">LIVE</span>
                            </h2>
                            
                            <div class="flex items-center gap-3 flex-wrap">
                                <div class="flex gap-1 bg-black/40 p-1 border border-purple-900/30 rounded-lg">
                                    <button onclick="setLobbyFilter('all')" id="filter-all" class="lobby-filter active px-4 py-2 text-[10px] uppercase transition rounded">All</button>
                                    <button onclick="setLobbyFilter('open')" id="filter-open" class="lobby-filter px-4 py-2 text-[10px] uppercase transition rounded">Open</button>
                                    <button onclick="setLobbyFilter('intercepted')" id="filter-intercepted" class="lobby-filter px-4 py-2 text-[10px] uppercase transition rounded">Active</button>
                                    <button onclick="setLobbyFilter('resolved')" id="filter-resolved" class="lobby-filter px-4 py-2 text-[10px] uppercase transition rounded">Sealed</button>
                                </div>
                                
                                <button onclick="refreshLobby()" class="text-[11px] text-purple-400 hover:text-purple-300 border border-purple-500/30 px-4 py-2 uppercase transition rounded-lg hover:bg-purple-900/20">
                                    Refresh
                                </button>
                            </div>
                        </div>
                        <div id="lobby-list" class="space-y-4"></div>
                    </div>

                    <!-- Live Activity Feed -->
                    <div class="grotto-glass p-6 rounded-xl">
                        <h2 class="cinzel text-xl text-purple-300 tracking-widest mb-6 flex items-center gap-3">
                            CHRONICLE OF BATTLES
                            <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse shadow-lg shadow-green-500/50"></span>
                        </h2>
                        <div id="activity-feed" class="activity-feed space-y-3"></div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Continue in part 3 with Marketplace, Challenges, etc. -->
    </main>
<!-- PART 3: MARKETPLACE + CHALLENGES + OTHER PAGES - Continue from part 2 -->

        <!-- MARKETPLACE PAGE -->
        <div id="page-marketplace" class="page-section">
            <div class="max-w-6xl mx-auto">
                <div class="grotto-glass p-8 rounded-xl mb-8">
                    <h2 class="cinzel text-3xl text-purple-400 mb-4 flex items-center gap-4 tracking-wider">
                        <span class="w-4 h-4 bg-yellow-500 rounded-full animate-pulse shadow-lg shadow-yellow-500/50"></span>
                        MYSTIC BAZAAR
                    </h2>
                    <p class="text-purple-300/70 text-sm mb-6">Acquire mystical enhancements for your soul's journey</p>

                    <!-- HERESY Items -->
                    <div class="mb-10">
                        <h3 class="cinzel text-xl text-yellow-400 mb-6 flex items-center gap-2">
                            üí∞ HERESY TREASURES
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Premium Profile (Arcane Ascendance) -->
                            <div class="marketplace-item p-6 rounded-xl">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="text-5xl">‚ú®</div>
                                    <div id="premium-status-badge" class="text-xs text-purple-400/70 uppercase">Premium</div>
                                </div>
                                <h4 class="cinzel text-xl text-yellow-400 mb-2">Arcane Ascendance</h4>
                                <p class="text-sm text-purple-300/70 mb-4">Ascend beyond mortal limits. Your name shimmers in gold, particles dance around your profile, and you radiate mystical power.</p>
                                
                                <div class="mb-4">
                                    <div class="text-xs text-purple-400/70 uppercase mb-1">Effects:</div>
                                    <ul class="text-xs text-purple-300 space-y-1">
                                        <li>üåü Gold shimmering username</li>
                                        <li>‚ú® Mystical particle effects</li>
                                        <li>üîÆ Animated profile border</li>
                                        <li>üëë Premium badge everywhere</li>
                                    </ul>
                                </div>

                                <div class="mb-4 pb-4 border-b border-purple-900/30">
                                    <div class="text-xs text-purple-400/70 uppercase mb-1">Duration:</div>
                                    <div class="text-sm text-yellow-400 cinzel">30 Days</div>
                                </div>

                                <div class="flex justify-between items-end">
                                    <div>
                                        <div class="text-xs text-purple-400/70 uppercase">Price</div>
                                        <div class="cinzel text-2xl text-yellow-400 font-bold">0.0001 $HERESY</div>
                                    </div>
                                    <button onclick="purchasePremiumProfile()" id="buy-premium-btn" class="btn-grotto px-6 py-3 text-xs rounded-lg cinzel bg-gradient-to-r from-yellow-600 to-yellow-800">
                                        Acquire
                                    </button>
                                </div>

                                <div id="premium-expires" class="mt-3 text-xs text-purple-400/70 italic hidden"></div>
                            </div>
                        </div>
                    </div>

                    <!-- BP Items -->
                    <div>
                        <h3 class="cinzel text-xl text-red-400 mb-6 flex items-center gap-2">
                            ü©∏ BLOOD POINT COSMETICS
                        </h3>
                        <div id="cosmetics-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Cosmetics will be populated via JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- BLOOD RITE PAGE -->
        <div id="page-bloodrite" class="page-section">
            <div class="grotto-glass p-8 rounded-xl max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="cinzel text-3xl text-purple-400 mb-2 flex items-center gap-4 tracking-wider">
                            <span class="w-4 h-4 bg-red-500 rounded-full animate-pulse shadow-lg shadow-red-500/50"></span>
                            BLOOD RITE SANCTUM
                        </h2>
                        <p class="text-purple-300/70 text-sm">Claim your blood points through daily rituals and achievements</p>
                    </div>
                    <div class="text-right">
                        <div class="text-[11px] text-purple-400/70 uppercase mb-1 tracking-widest cinzel">Your Blood Points</div>
                        <div id="blood-points-total" class="cinzel text-4xl text-red-400 font-bold">0</div>
                        <div class="text-[10px] text-purple-500/50 mt-1">Level <span id="blood-level">1</span></div>
                    </div>
                </div>

                <!-- Daily Reset Timer -->
                <div class="grotto-glass border-2 border-purple-500/30 p-6 rounded-xl mb-8">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="cinzel text-lg text-purple-300 mb-2">Daily Ritual Reset</h3>
                            <p class="text-sm text-purple-400/70">New challenges await at midnight UTC</p>
                        </div>
                        <div class="text-center">
                            <div class="text-[11px] text-purple-400/70 uppercase mb-2 tracking-widest cinzel">Time Remaining</div>
                            <div id="daily-timer" class="cinzel text-3xl text-purple-400 font-bold">--:--:--</div>
                        </div>
                    </div>
                </div>

                <!-- Daily Achievements -->
                <div class="mb-8">
                    <h3 class="cinzel text-xl text-purple-300 mb-4 flex items-center gap-2">
                        ‚ö° DAILY TRIALS
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="daily-achievements"></div>
                </div>

                <!-- Milestone Achievements -->
                <div>
                    <h3 class="cinzel text-xl text-purple-300 mb-4 flex items-center gap-2">
                        üèÜ ETERNAL ACHIEVEMENTS
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="milestone-achievements"></div>
                </div>

                <!-- Level Progress -->
                <div class="grotto-glass border-2 border-yellow-500/30 p-6 rounded-xl mt-8">
                    <h3 class="cinzel text-lg text-yellow-400 mb-4">Blood Ascension Progress</h3>
                    <div class="mb-4">
                        <div class="flex justify-between text-sm text-purple-300 mb-2">
                            <span>Level <span id="current-level">1</span></span>
                            <span><span id="current-bp">0</span> / <span id="next-level-bp">100</span> BP</span>
                        </div>
                        <div class="w-full bg-black/50 rounded-full h-4 overflow-hidden border border-purple-900/50">
                            <div id="level-progress-bar" class="h-full bg-gradient-to-r from-red-600 to-purple-600 transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                    <p class="text-xs text-purple-400/70 italic">Blood points unlock mystical powers and exclusive cosmetics</p>
                </div>
            </div>
        </div>

        <!-- LEADERBOARD PAGE -->
        <div id="page-leaderboard" class="page-section">
            <div class="grotto-glass p-8 rounded-xl">
                <h2 class="cinzel text-3xl text-purple-400 mb-8 flex items-center gap-4 tracking-wider">
                    <span class="w-4 h-4 bg-purple-500 rounded-full animate-pulse shadow-lg shadow-purple-500/50"></span>
                    HALL OF LEGENDS
                </h2>

                <!-- Global Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card p-6 text-center rounded-xl">
                        <div class="text-[11px] text-purple-400/70 uppercase mb-2 tracking-widest cinzel">Total Heresy</div>
                        <div id="global-wagered" class="cinzel text-3xl text-purple-400 font-bold">--</div>
                    </div>
                    <div class="stat-card p-6 text-center rounded-xl border-red-900/30">
                        <div class="text-[11px] text-red-400/70 uppercase mb-2 tracking-widest cinzel">Sacrificed</div>
                        <div id="global-burnt" class="cinzel text-3xl text-red-400 font-bold">--</div>
                    </div>
                    <div class="stat-card p-6 text-center rounded-xl border-blue-900/30">
                        <div class="text-[11px] text-blue-400/70 uppercase mb-2 tracking-widest cinzel">Vault</div>
                        <div id="global-treasury" class="cinzel text-3xl text-blue-400 font-bold">--</div>
                    </div>
                    <div class="stat-card p-6 text-center rounded-xl border-green-900/30">
                        <div class="text-[11px] text-green-400/70 uppercase mb-2 tracking-widest cinzel">Rituals</div>
                        <div id="global-games" class="cinzel text-3xl text-green-400 font-bold">--</div>
                    </div>
                </div>

                <!-- Hall of Fame & Shame -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="grotto-glass p-6 rounded-xl border-2 border-red-500/30">
                        <h3 class="cinzel text-lg text-red-400 mb-4 flex items-center gap-2">üíÄ Fallen Champion</h3>
                        <div id="biggest-loser" class="text-center">
                            <div class="text-sm text-red-300/70 mb-2">Most Lost</div>
                            <div class="cinzel text-2xl text-red-400 font-bold mb-1">--</div>
                            <div class="text-xs text-red-500/50">-- $HERESY Lost</div>
                        </div>
                    </div>

                    <div class="grotto-glass p-6 rounded-xl border-2 border-yellow-500/30">
                        <h3 class="cinzel text-lg text-yellow-400 mb-4 flex items-center gap-2">üî• Streak Master</h3>
                        <div id="streak-master" class="text-center">
                            <div class="text-sm text-yellow-300/70 mb-2">Longest Streak</div>
                            <div class="cinzel text-2xl text-yellow-400 font-bold mb-1">--</div>
                            <div class="text-xs text-yellow-500/50">-- Consecutive Wins</div>
                        </div>
                    </div>

                    <div class="grotto-glass p-6 rounded-xl border-2 border-blue-500/30">
                        <h3 class="cinzel text-lg text-blue-400 mb-4 flex items-center gap-2">‚ö° Dark Devotee</h3>
                        <div id="most-active" class="text-center">
                            <div class="text-sm text-blue-300/70 mb-2">Most Rituals</div>
                            <div class="cinzel text-2xl text-blue-400 font-bold mb-1">--</div>
                            <div class="text-xs text-blue-500/50">-- Total Games</div>
                        </div>
                    </div>
                </div>

                <!-- Leaderboard Table -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-purple-900/30">
                                <th class="text-left p-4 text-[11px] text-purple-400/70 uppercase tracking-widest cinzel">Rank</th>
                                <th class="text-left p-4 text-[11px] text-purple-400/70 uppercase tracking-widest cinzel">Soul</th>
                                <th class="text-right p-4 text-[11px] text-purple-400/70 uppercase tracking-widest cinzel">Heresy</th>
                                <th class="text-right p-4 text-[11px] text-purple-400/70 uppercase tracking-widest cinzel">Victory %</th>
                                <th class="text-right p-4 text-[11px] text-purple-400/70 uppercase tracking-widest cinzel">Greatest Pot</th>
                                <th class="text-right p-4 text-[11px] text-purple-400/70 uppercase tracking-widest cinzel">Streak</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PROFILE PAGE (with Challenges tab) -->
        <div id="page-profile" class="page-section">
            <div class="grotto-glass p-8 rounded-xl max-w-5xl mx-auto">
                <h2 class="cinzel text-3xl text-purple-400 mb-8 flex items-center gap-4 tracking-wider">
                    <span class="w-4 h-4 bg-purple-500 rounded-full animate-pulse shadow-lg shadow-purple-500/50"></span>
                    SOUL CHRONICLE
                </h2>
                
                <!-- Profile Tabs -->
                <div class="flex gap-2 mb-6 border-b border-purple-900/30">
                    <button onclick="switchProfileTab('stats')" id="profile-tab-stats" class="tab-btn active px-6 py-3 text-sm cinzel">Statistics</button>
                    <button onclick="switchProfileTab('challenges')" id="profile-tab-challenges" class="tab-btn px-6 py-3 text-sm cinzel">Challenges</button>
                </div>

                <div id="profile-stats-content" class="profile-tab-content"></div>
                <div id="profile-challenges-content" class="profile-tab-content hidden"></div>
            </div>
        </div>

        <!-- HOW TO PLAY PAGE -->
        <div id="page-howto" class="page-section">
            <div class="grotto-glass p-8 rounded-xl max-w-4xl mx-auto">
                <h2 class="cinzel text-3xl text-purple-400 mb-8 tracking-wider">ANCIENT DOCTRINE</h2>
                
                <div class="space-y-8 text-purple-200/90 leading-relaxed">
                    <section>
                        <h3 class="cinzel text-xl text-purple-400 mb-4 flex items-center gap-2">üéØ THE FORBIDDEN RITUAL</h3>
                        <p class="text-base">The Grotto Gambit is a dark pact sealed in $HERESY tokens. Two souls enter the void with strategic intent‚Äîthree mystical forces clash in eternal balance. The victor claims the offering, while the defeated soul learns humility.</p>
                    </section>

                    <section>
                        <h3 class="cinzel text-xl text-purple-400 mb-4 flex items-center gap-2">‚öîÔ∏è THREE FORCES OF CHAOS</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="grotto-glass p-6 rounded-lg border border-purple-900/30 hover:border-purple-500/50 transition">
                                <img src="https://raw.githubusercontent.com/precidoboss/my-game-sprites/main/photo_3_2026-02-11_10-02-39.jpg" alt="Greg" class="w-24 h-24 mx-auto mb-3 object-contain">
                                <div class="cinzel text-purple-400 mb-2 text-center text-lg">GREG</div>
                                <div class="text-[12px] text-purple-300/60 text-center">Defeats Bob</div>
                            </div>
                            <div class="grotto-glass p-6 rounded-lg border border-purple-900/30 hover:border-purple-500/50 transition">
                                <img src="https://raw.githubusercontent.com/precidoboss/my-game-sprites/main/photo_2_2026-02-11_10-02-39.jpg" alt="Bob" class="w-24 h-24 mx-auto mb-3 object-contain">
                                <div class="cinzel text-purple-400 mb-2 text-center text-lg">BOB</div>
                                <div class="text-[12px] text-purple-300/60 text-center">Defeats Disco</div>
                            </div>
                            <div class="grotto-glass p-6 rounded-lg border border-purple-900/30 hover:border-purple-500/50 transition">
                                <img src="https://raw.githubusercontent.com/precidoboss/my-game-sprites/main/photo_1_2026-02-11_10-02-39.jpg" alt="Disco" class="w-24 h-24 mx-auto mb-3 object-contain">
                                <div class="cinzel text-purple-400 mb-2 text-center text-lg">DISCO</div>
                                <div class="text-[12px] text-purple-300/60 text-center">Defeats Greg</div>
                            </div>
                        </div>
                    </section>

                    <section class="grotto-glass border-2 border-purple-500/30 p-8 rounded-xl">
                        <h3 class="cinzel text-xl text-purple-400 mb-4 flex items-center gap-2">üí∞ TRIBUTE & REWARDS</h3>
                        <div class="space-y-3 text-[15px]">
                            <div class="flex justify-between py-2 border-b border-purple-900/20">
                                <span class="text-purple-200/70">Victor's Claim:</span>
                                <span class="text-purple-400 font-semibold cinzel">97% of pot</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-purple-900/20">
                                <span class="text-purple-200/70">Vault Tribute:</span>
                                <span class="text-purple-400 font-semibold cinzel">1.5%</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-purple-900/20">
                                <span class="text-purple-200/70">Dark Sacrifice:</span>
                                <span class="text-purple-400 font-semibold cinzel">1.5%</span>
                            </div>
                            <div class="flex justify-between py-2">
                                <span class="text-purple-200/70">Draw (each soul):</span>
                                <span class="text-purple-400 font-semibold cinzel">Stake - 3%</span>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </main>

    <!-- Player Profile Modal -->
    <div id="player-modal" class="modal">
        <div class="modal-content grotto-glass p-8 w-full rounded-xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="cinzel text-2xl text-purple-400 tracking-wider">SOUL ARCHIVE</h2>
                <button onclick="closePlayerModal()" class="text-3xl text-purple-500 hover:text-purple-300 transition">&times;</button>
            </div>
            <div id="player-modal-content"></div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 grotto-glass border-2 border-purple-500 px-8 py-4 text-purple-300 cinzel text-sm transform translate-y-32 transition-all duration-300 z-[200] rounded-lg shadow-2xl max-w-md text-center">
        SYSTEM MESSAGE
    </div>

<!-- Continue in part 4a with JavaScript -->
<!-- PART 4A: CORE JAVASCRIPT - Wallet, Config, Game Creation -->
<script>
    // ============================================
    // CONFIGURATION & GLOBALS
    // ============================================
    
    // The Grotto Chain Configuration
    const CHAIN_ID = "0x8E6F"; // 36463
    const RPC_URL = "https://subnets.avax.network/thegrotto/mainnet/rpc";
    const CORE_CONTRACT_ADDR = "0x41a2AFd8A11ddff4ecC234E3c6529eDC9D2848BC";
    const EXT_CONTRACT_ADDR = "0x12fe0DFc66DA66d2BA6a54D21210Dde6cB0c2603";
    const EXPLORER_URL = "https://subnets.avax.network/thegrotto";
    const CHAIN_NAME = "The Grotto";
    const CURRENCY_SYMBOL = "HERESY";
    
    // Supabase Configuration
    const SB_URL = "https://tvckbtgggsuwxtlgilcl.supabase.co"; 
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2Y2tidGdnZ3N1d3h0bGdpbGNsIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MDY2NDY0NSwiZXhwIjoyMDg2MjQwNjQ1fQ.DhvGNo3seKoRtDmeRod0gAP48yFZw_0-kAvY3eT_554"; 
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    // GrottoCore Contract ABI
    const CORE_ABI = [
        "function createGame(bytes32 _hash, uint256 _timeout) external payable",
        "function challengeGame(uint256 _gameId, uint8 _move) external payable",
        "function resolveGame(uint256 _gameId, uint8 _move, string calldata _salt) external",
        "function forceForfeit(uint256 _gameId) external",
        "function refundUnchallenged(uint256 _gameId) external",
        "function gameCounter() public view returns (uint256)",
        "function games(uint256) public view returns (address host, address challenger, bytes32 commitHash, uint8 hostMove, uint8 challengerMove, uint256 wager, uint256 timeout, uint256 timestamp, uint8 status)",
        "function getTimeRemaining(uint256 _gameId) external view returns (uint256)",
        "event GameCreated(uint256 indexed gameId, address indexed host, uint256 wager, uint256 timeout, bytes32 commitHash)",
        "event GameChallenged(uint256 indexed gameId, address indexed challenger)",
        "event GameResolved(uint256 indexed gameId, address winner, uint256 payout)",
        "event GameForfeited(uint256 indexed gameId, address winner)",
        "event GameRefunded(uint256 indexed gameId, address host)"
    ];

    // GrottoExtensions Contract ABI
    const EXT_ABI = [
        "function createCustomChallenge(address _target, string calldata _message, uint256 _timeout) external payable",
        "function acceptCustomChallenge(uint256 _challengeId) external payable",
        "function declineCustomChallenge(uint256 _challengeId) external",
        "function counterOfferChallenge(uint256 _challengeId, uint256 _newAmount) external",
        "function acceptCounterOffer(uint256 _challengeId) external payable",
        "function refundExpiredChallenge(uint256 _challengeId) external",
        "function purchasePremiumProfile() external payable",
        "function hasPremiumProfile(address _user) external view returns (bool)",
        "function challengeCounter() public view returns (uint256)",
        "function customChallenges(uint256) public view returns (uint256 challengeId, address challenger, address target, uint256 wagerAmount, uint256 counterOfferAmount, string message, uint256 timeout, uint256 timestamp, uint8 status, uint256 gameId, bool challengerCommitted)",
        "function getUserChallenges(address _user) external view returns (uint256[] memory)",
        "function getUserTargetedChallenges(address _user) external view returns (uint256[] memory)",
        "event CustomChallengeCreated(uint256 indexed challengeId, address indexed challenger, address indexed target, uint256 wager, string message)",
        "event ChallengeAccepted(uint256 indexed challengeId, uint256 indexed gameId)",
        "event ChallengeDeclined(uint256 indexed challengeId)",
        "event ChallengeCounterOffered(uint256 indexed challengeId, uint256 newAmount)",
        "event ChallengeRefunded(uint256 indexed challengeId, address recipient, uint256 amount)",
        "event PremiumProfilePurchased(address indexed user, uint256 expiresAt)"
    ];

    // Global State
    let provider, signer, coreContract, extContract, userAddress;
    let selectedMoveIdx = 0;
    let lobbyRefreshInterval, activityRefreshInterval, chatRefreshInterval, dailyTimerInterval;
    let currentLobbyFilter = 'all';
    let userNotifications = [];
    let lastLobbyData = null;
    let lobbyRefreshTimeout = null;

    // Move Configuration
    const moveNames = ['', 'Greg', 'Bob', 'Disco'];
    const moveImages = [
        '',
        'https://raw.githubusercontent.com/precidoboss/my-game-sprites/main/photo_3_2026-02-11_10-02-39.jpg',
        'https://raw.githubusercontent.com/precidoboss/my-game-sprites/main/photo_2_2026-02-11_10-02-39.jpg',
        'https://raw.githubusercontent.com/precidoboss/my-game-sprites/main/photo_1_2026-02-11_10-02-39.jpg'
    ];

    // Notification Messages
    const winMessages = [
        "Victory is yours! The void smiles upon you‚Äîstrike again while fortune favors! ‚ö°",
        "You won! Your enemies tremble. Don't waste this momentum! üî•",
        "Triumph! The dark forces align with you. Seize another victory! üåü",
        "Success! You're on a roll. The grotto demands more! üíÄ",
        "Victory claimed! Your power grows. Continue the conquest! ‚öîÔ∏è"
    ];

    const lossMessages = [
        "Defeat... but the night is young. Next time, darkness will be yours! üåô",
        "You fell this round. Every master has tasted defeat‚Äîrise again! üí™",
        "Not this time... but the grotto rewards persistence. Try again! üéØ",
        "Loss stings, but champions are forged in failure. Redeem yourself! ‚ö°",
        "Defeat is temporary. Your comeback story begins now! üîÆ"
    ];

    const drawMessages = [
        "A stalemate! The forces were balanced. Break the tie! ‚öñÔ∏è",
        "Draw! Neither victor nor vanquished. Seek another challenger! ü§ù",
        "Equilibrium achieved. The next ritual awaits! üåÄ"
    ];

    // ============================================
    // INITIALIZATION
    // ============================================
    
    async function init() {
        if (window.ethereum) {
            provider = new ethers.BrowserProvider(window.ethereum);
            document.getElementById('connect-btn').addEventListener('click', connectWallet);
            
            await debouncedRefreshLobby();
            await refreshActivityFeed();
            await refreshChat();
            loadNotifications();
            updateDailyTimer();
            
            lobbyRefreshInterval = setInterval(debouncedRefreshLobby, 15000); // Reduced frequency
            activityRefreshInterval = setInterval(refreshActivityFeed, 10000);
            chatRefreshInterval = setInterval(refreshChat, 5000);
            dailyTimerInterval = setInterval(updateDailyTimer, 1000);
            
            // Supabase Realtime
            _supabase.channel('grotto_game_updates')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'grotto_games' }, () => {
                    debouncedRefreshLobby();
                    refreshActivityFeed();
                })
                .subscribe();

            _supabase.channel('grotto_chat_updates')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'grotto_chat' }, refreshChat)
                .subscribe();

            _supabase.channel('grotto_challenges_updates')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'grotto_challenges' }, () => {
                    loadUserChallenges();
                    loadNotifications();
                })
                .subscribe();

            window.ethereum.on('accountsChanged', () => window.location.reload());
            window.ethereum.on('chainChanged', () => window.location.reload());
        }
    }

    // Debounced lobby refresh to prevent flickering
    function debouncedRefreshLobby() {
        if (lobbyRefreshTimeout) clearTimeout(lobbyRefreshTimeout);
        lobbyRefreshTimeout = setTimeout(refreshLobby, 300);
    }

    // ============================================
    // WALLET CONNECTION
    // ============================================
    
    async function checkNetwork() {
        const network = await provider.getNetwork();
        const currentChainIdHex = "0x" + network.chainId.toString(16).toUpperCase();
        
        if (currentChainIdHex !== CHAIN_ID.toUpperCase()) {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: CHAIN_ID }],
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: CHAIN_ID,
                                chainName: CHAIN_NAME,
                                nativeCurrency: { name: CURRENCY_SYMBOL, symbol: CURRENCY_SYMBOL, decimals: 18 },
                                rpcUrls: [RPC_URL],
                                blockExplorerUrls: [EXPLORER_URL]
                            }]
                        });
                    } catch (addError) {
                        showToast("Failed to add Grotto network");
                        return false;
                    }
                } else {
                    showToast("Switch to The Grotto");
                    return false;
                }
            }
        }
        return true;
    }

    async function connectWallet() {
        try {
            const accounts = await provider.send("eth_requestAccounts", []);
            userAddress = accounts[0];
            signer = await provider.getSigner();
            
            if (!(await checkNetwork())) return;

            // Initialize both contracts
            coreContract = new ethers.Contract(CORE_CONTRACT_ADDR, CORE_ABI, signer);
            extContract = new ethers.Contract(EXT_CONTRACT_ADDR, EXT_ABI, signer);
            
            document.getElementById('connect-btn').classList.add('hidden');
            document.getElementById('account-info').classList.remove('hidden');
            
            const username = await getUsernameOrAddress(userAddress);
            document.getElementById('user-address').innerText = username;
            
            await updateBalance();
            await debouncedRefreshLobby();
            await loadNotifications();
            await loadBloodRite();
            await checkPremiumStatus();
            await loadUserChallenges();
        } catch (err) { 
            console.error(err);
            showToast("Portal summoning failed"); 
        }
    }

    function copyAddress() {
        if (userAddress) {
            navigator.clipboard.writeText(userAddress).then(() => {
                showToast("Address copied to void");
            }).catch(() => {
                showToast("Copy failed");
            });
        }
    }

    async function updateBalance() {
        if (!userAddress || !provider) return;
        try {
            const balance = await provider.getBalance(userAddress);
            document.getElementById('user-balance').innerText = `${parseFloat(ethers.formatEther(balance)).toFixed(5)} $${CURRENCY_SYMBOL}`;
        } catch (e) { console.error("Balance error", e); }
    }

    // ============================================
    // USERNAME MANAGEMENT
    // ============================================
    
    async function getUsernameOrAddress(address) {
        if (!address) return 'Unknown';
        try {
            const { data, error } = await _supabase
                .from('grotto_usernames')
                .select('username')
                .eq('address', address.toLowerCase())
                .single();
            
            if (data && data.username) {
                return data.username;
            }
        } catch (e) {}
        return address.slice(0, 6) + '...' + address.slice(-4);
    }

    async function updateUsername() {
        if (!userAddress) {
            showToast("Connect wallet first");
            return;
        }

        const newUsername = prompt("Enter your new username (max 20 characters):");
        if (!newUsername || newUsername.trim() === '') return;
        
        if (newUsername.length > 20) {
            showToast("Username too long (max 20)");
            return;
        }

        try {
            const { error } = await _supabase
                .from('grotto_usernames')
                .upsert({ 
                    address: userAddress.toLowerCase(),
                    username: newUsername.trim()
                });

            if (error) throw error;

            showToast("‚úì Username updated");
            const username = await getUsernameOrAddress(userAddress);
            document.getElementById('user-address').innerText = username;
            debouncedRefreshLobby();
            refreshChat();
        } catch (err) {
            console.error("Username update error:", err);
            showToast("Update failed");
        }
    }

    // ============================================
    // GAME CREATION
    // ============================================
    
    function selectMove(idx) {
        selectedMoveIdx = idx;
        document.querySelectorAll('.move-select').forEach(btn => btn.classList.remove('selected'));
        document.getElementById(`move-${idx}`).classList.add('selected');
    }

    async function handleCreateGame() {
        if (!signer) return showToast("Summon portal first");
        if (selectedMoveIdx === 0) return showToast("Select your force");
        if (!(await checkNetwork())) return;
        
        const createBtn = document.getElementById('create-btn');
        createBtn.disabled = true;
        createBtn.classList.add('loading');
        
        const wagerInput = document.getElementById('wager-amount').value;
        const wagerValue = ethers.parseEther(wagerInput);
        const timeoutValue = document.getElementById('timeout-select').value;
        const salt = ethers.hexlify(ethers.randomBytes(32));
        
        try {
            // Use coreContract for game creation
            const nextGameId = (await coreContract.gameCounter()) + BigInt(1);
            
            const encoded = ethers.AbiCoder.defaultAbiCoder().encode(
                ["uint8", "string", "address", "uint256"],
                [selectedMoveIdx, salt, userAddress, nextGameId]
            );
            const hash = ethers.keccak256(encoded);

            showToast("Encrypting ritual...");
            const tx = await coreContract.createGame(hash, timeoutValue, { value: wagerValue });
            
            showToast("Awaiting the void...");
            const receipt = await tx.wait();
            
            const secrets = JSON.parse(localStorage.getItem('grotto_secrets') || '{}');
            secrets[hash] = { 
                move: selectedMoveIdx, 
                salt: salt,
                gameId: nextGameId.toString(),
                address: userAddress.toLowerCase()
            };
            localStorage.setItem('grotto_secrets', JSON.stringify(secrets));

            let gameId = Number(nextGameId);

            try {
                for (const log of receipt.logs) {
                    try {
                        if (log.address.toLowerCase() !== CORE_CONTRACT_ADDR.toLowerCase()) continue;
                        const parsed = coreContract.interface.parseLog({
                            topics: log.topics,
                            data: log.data
                        });
                        if (parsed && parsed.name === 'GameCreated') {
                            gameId = Number(parsed.args.gameId);
                            break;
                        }
                    } catch(e) { continue; }
                }
            } catch (e) { console.warn("Log parsing failed:", e); }

            const { error: sbError } = await _supabase.from('grotto_games')
                .insert([{
                    game_id: gameId,
                    host: userAddress.toLowerCase(),
                    wager: wagerInput,
                    timeout: parseInt(timeoutValue),
                    status: 0,
                    commit_hash: hash
                }]);

            if (sbError) {
                console.error("Supabase error:", sbError);
                showToast("‚ö†Ô∏è Ritual invoked but index failed");
            } else {
                showToast("‚úì Ritual sealed in darkness");
            }

            await updatePlayerStats('gameCreated', parseFloat(wagerInput));
            await updateBalance();

            setTimeout(async () => {
                await debouncedRefreshLobby();
                createBtn.disabled = false;
                createBtn.classList.remove('loading');
            }, 2000);
            
        } catch (err) { 
            console.error("Creation error:", err);
            showToast(err.reason || "Ritual invocation failed");
            createBtn.disabled = false;
            createBtn.classList.remove('loading');
        }
    }

    // Continue in part 4b with game interactions and challenges...
</script>
<!-- PART 4B: GAME INTERACTIONS & CUSTOM CHALLENGES -->
<script>
    // ============================================
    // LOBBY & GAME INTERACTIONS
    // ============================================
    
    async function refreshLobby() {
        const lobby = document.getElementById('lobby-list');
        if (!lobby) return;
        
        try {
            const { data: games, error } = await _supabase.from('grotto_games')
                .select('*')
                .order('game_id', { ascending: false })
                .limit(100);

            if (error) {
                lobby.innerHTML = `<div class="text-center py-20 text-red-400 uppercase">Archive corrupted</div>`;
                return;
            }

            // Compare with last data to prevent unnecessary re-renders
            const gamesJson = JSON.stringify(games);
            if (gamesJson === lastLobbyData) return;
            lastLobbyData = gamesJson;

            lobby.innerHTML = '';
            let displayedCount = 0;

            for (const game of games) {
                const status = Number(game.status);
                const isHost = userAddress && game.host === userAddress.toLowerCase();
                const isChallenger = userAddress && game.challenger === userAddress.toLowerCase();
                
                if (currentLobbyFilter === 'open' && status !== 0) continue;
                if (currentLobbyFilter === 'intercepted' && status !== 1) continue;
                if (currentLobbyFilter === 'resolved' && status !== 2) continue;
                
                if (status > 1 && !isHost && !isChallenger && currentLobbyFilter === 'all') continue;

                displayedCount++;

                const div = document.createElement('div');
                const borderColor = status == 0 ? '#9333ea' : status == 1 ? '#eab308' : status == 2 ? '#15803d' : '#374151';
                
                div.className = "p-5 grotto-glass rounded-lg border-l-4 flex flex-col md:flex-row justify-between items-center gap-4 transition hover:bg-purple-900/10";
                div.style.borderLeftColor = borderColor;
                
                let countdownHTML = '';
                if (status === 0 || status === 1) {
                    const createdAt = new Date(game.created_at).getTime() / 1000;
                    const timeout = game.timeout || 900;
                    const deadline = createdAt + timeout;
                    const now = Math.floor(Date.now() / 1000);
                    const remaining = deadline - now;
                    
                    if (remaining > 0) {
                        const hours = Math.floor(remaining / 3600);
                        const minutes = Math.floor((remaining % 3600) / 60);
                        const seconds = remaining % 60;
                        const timeColor = remaining < 60 ? '#ef4444' : '#9333ea';
                        const timeStr = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m ${seconds}s`;
                        countdownHTML = `<span class="text-[11px] ml-2 cinzel" style="color: ${timeColor}">‚è± ${timeStr}</span>`;
                    } else {
                        countdownHTML = `<span class="text-[11px] text-red-500 ml-2 animate-pulse cinzel">‚è± EXPIRED</span>`;
                    }
                }
                
                const hostName = await getUsernameOrAddress(game.host);
                const isPremium = userAddress && await checkIfPremium(game.host);
                const hostClass = isPremium ? 'premium-name' : '';
                
                let gameInfo = `
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2 flex-wrap">
                            <span class="text-[10px] px-3 py-1 border rounded-full uppercase cinzel tracking-wider" style="border-color: ${borderColor}; color: ${borderColor}">${getStatusText(status)}</span>
                            <span class="text-[10px] text-purple-500/50 cinzel">ID: ${game.game_id}</span>
                            ${countdownHTML}
                        </div>
                        <div class="cinzel text-purple-200 text-base">
                            <span class="text-purple-400 font-bold">${parseFloat(game.wager).toFixed(5)} $${CURRENCY_SYMBOL}</span> 
                            <span class="${hostClass} text-purple-600 text-[11px] ml-2">FROM ${hostName}</span>`;
                
                if (status == 2 && game.host_move && game.challenger_move) {
                    const hostMove = Number(game.host_move);
                    const challengerMove = Number(game.challenger_move);
                    
                    let winner = '';
                    if (hostMove === challengerMove) {
                        winner = '‚öñÔ∏è STALEMATE';
                    } else if (
                        (hostMove === 1 && challengerMove === 2) ||
                        (hostMove === 2 && challengerMove === 3) ||
                        (hostMove === 3 && challengerMove === 1)
                    ) {
                        winner = `üèÜ ${hostName} PREVAILS`;
                    } else {
                        const challengerName = await getUsernameOrAddress(game.challenger || 'Unknown');
                        winner = `üèÜ ${challengerName} PREVAILS`;
                    }
                    
                    gameInfo += `
                        <div class="text-[11px] mt-2 text-purple-300/60 flex gap-2 items-center">
                            <img src="${moveImages[hostMove]}" class="w-6 h-6 object-contain"> ${moveNames[hostMove]} vs 
                            <img src="${moveImages[challengerMove]}" class="w-6 h-6 object-contain"> ${moveNames[challengerMove]}
                        </div>
                        <div class="text-[12px] mt-1 font-bold ${hostMove === challengerMove ? 'text-yellow-400' : 'text-green-400'} cinzel">
                            ${winner}
                        </div>`;
                }
                
                gameInfo += `
                        </div>
                    </div>
                    <div class="flex gap-2">${await getActionButtons(game, isHost, isChallenger)}</div>`;
                
                div.innerHTML = gameInfo;
                lobby.appendChild(div);
            }
            
            if (displayedCount === 0) {
                lobby.innerHTML = '<div class="text-center py-20 text-purple-700/50 uppercase italic cinzel">The void is silent...</div>';
            }
        } catch (err) { 
            console.error("Lobby error:", err);
        }
    }

    function setLobbyFilter(filter) {
        currentLobbyFilter = filter;
        document.querySelectorAll('.lobby-filter').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`filter-${filter}`).classList.add('active');
        lastLobbyData = null; // Force refresh
        refreshLobby();
    }

    async function getActionButtons(game, isHost, isChallenger) {
        if (game.status == 0) {
            if (isHost) {
                return `<button onclick="handleRefund(${game.game_id})" class="text-[10px] border border-purple-700 px-5 py-2 hover:bg-purple-900/20 uppercase rounded cinzel transition">Retract</button>`;
            }
            return `<button onclick="handleChallenge(${game.game_id}, '${game.wager}')" class="btn-grotto text-[11px] px-7 py-3 rounded-lg cinzel">Challenge</button>`;
        }
        if (game.status == 1) {
            if (isHost) {
                return `<button onclick="handleResolve(${game.game_id}, '${game.commit_hash}')" class="btn-grotto text-[11px] px-7 py-3 rounded-lg animate-pulse cinzel">Reveal</button>`;
            }
            if (isChallenger) {
                const now = Math.floor(Date.now() / 1000);
                const createdAt = new Date(game.created_at).getTime() / 1000;
                const timeout = game.timeout || 900;
                const deadline = createdAt + timeout;
                
                if (now >= deadline) {
                    return `<button onclick="handleForceForfeit(${game.game_id})" class="btn-grotto text-[11px] px-7 py-3 rounded-lg animate-pulse cinzel">Claim Victory</button>`;
                }
                return `<span class="text-[10px] text-purple-400 uppercase italic cinzel">‚öîÔ∏è Awaiting reveal...</span>`;
            }
            return `<span class="text-[10px] text-purple-600 uppercase italic cinzel">Ritual active</span>`;
        }
        if (game.status == 2) return `<span class="text-[10px] text-green-400 uppercase cinzel">‚úì Sealed</span>`;
        if (game.status == 3) return `<span class="text-[10px] text-gray-600 uppercase cinzel">Retracted</span>`;
        if (game.status == 4) return `<span class="text-[10px] text-red-600 uppercase cinzel">‚ö° Forfeited</span>`;
        return `<span class="text-[10px] text-gray-700 uppercase cinzel">Dormant</span>`;
    }

    async function handleChallenge(id, wager) {
        if (!signer) return showToast("Summon portal first");
        if (!(await checkNetwork())) return;
        
        const move = prompt(`Select your force:\n1 - ${moveNames[1]}\n2 - ${moveNames[2]}\n3 - ${moveNames[3]}`);
        if (!move || move < 1 || move > 3) return showToast("Invalid force");
        
        try {
            showToast("Accepting challenge...");
            const gameData = await contract.games(id);
            const actualWager = gameData.wager;
            
            const tx = await contract.challengeGame(id, move, { value: actualWager });
            showToast("Sealing pact...");
            await tx.wait();
            
            await _supabase.from('grotto_games')
                .update({ 
                    status: 1, 
                    challenger: userAddress.toLowerCase(),
                    challenger_move: parseInt(move)
                })
                .eq('game_id', id);
            
            await updatePlayerStats('gameChallenged', parseFloat(wager));
            showToast("‚úì Challenge accepted");
            await updateBalance();
            setTimeout(debouncedRefreshLobby, 1500);
        } catch (err) { 
            console.error("Challenge error:", err);
            showToast(err.reason || "Challenge failed"); 
        }
    }

    async function handleResolve(id, hash) {
        if (!signer) return showToast("Summon portal first");
        if (!(await checkNetwork())) return;
        
        const secrets = JSON.parse(localStorage.getItem('grotto_secrets') || '{}');
        let secret = secrets[hash];
        
        if (!secret) {
            const manualReveal = confirm("Secret not found in this sanctum. Enter manually?");
            if (!manualReveal) {
                showToast("‚ö†Ô∏è Secret not found");
                return;
            }
            
            const move = prompt("Enter your force (1-3):");
            const salt = prompt("Enter your salt (hex):");
            
            if (!move || !salt) return showToast("Cancelled");
            
            const encoded = ethers.AbiCoder.defaultAbiCoder().encode(
                ["uint8", "string", "address", "uint256"],
                [parseInt(move), salt, userAddress, BigInt(id)]
            );
            const testHash = ethers.keccak256(encoded);
            
            if (testHash.toLowerCase() !== hash.toLowerCase()) {
                return showToast("‚ö†Ô∏è Hash mismatch");
            }
            
            secret = { move: parseInt(move), salt: salt };
        }
        
        try {
            showToast("Revealing truth...");
            const tx = await contract.resolveGame(id, secret.move, secret.salt);
            await tx.wait();
            
            const gameData = await contract.games(id);
            const hostMove = Number(gameData.hostMove);
            const challengerMove = Number(gameData.challengerMove);
            
            let resultMsg = "Ritual completed";
            let isWin = false;
            let isDraw = false;
            
            if (hostMove === challengerMove) {
                resultMsg = "‚öñÔ∏è STALEMATE";
                isDraw = true;
            } else if (
                (hostMove === 1 && challengerMove === 2) ||
                (hostMove === 2 && challengerMove === 3) ||
                (hostMove === 3 && challengerMove === 1)
            ) {
                resultMsg = "üèÜ VICTORY!";
                isWin = true;
            } else {
                resultMsg = "üíÄ DEFEAT";
                isWin = false;
            }
            
            addNotification({
                type: isDraw ? 'draw' : (isWin ? 'win' : 'loss'),
                gameId: id,
                message: resultMsg,
                timestamp: Date.now()
            });
            
            await _supabase.from('grotto_games').update({ 
                status: 2,
                host_move: hostMove,
                challenger_move: challengerMove
            }).eq('game_id', id);
            
            await updatePlayerStats(isWin ? 'gameWon' : (isDraw ? 'gameDraw' : 'gameLost'));
            
            setTimeout(debouncedRefreshLobby, 1000);
            await updateBalance();
            showToast(resultMsg);
        } catch (err) { 
            console.error("Resolve error:", err);
            showToast(err.reason || "Reveal failed"); 
        }
    }

    async function handleRefund(id) {
        if (!signer) return showToast("Summon portal first");
        if (!(await checkNetwork())) return;
        
        try {
            showToast("Retracting ritual...");
            const tx = await contract.refundUnchallenged(id);
            await tx.wait();
            
            await _supabase.from('grotto_games').update({ status: 3 }).eq('game_id', id);
            debouncedRefreshLobby();
            await updateBalance();
            showToast("Heresy returned");
        } catch (err) { 
            console.error(err);
            showToast(err.reason || "Refund failed"); 
        }
    }

    async function handleForceForfeit(gameId) {
        if (!signer) return showToast("Summon portal first");
        if (!(await checkNetwork())) return;
        
        try {
            showToast("Claiming victory...");
            const tx = await contract.forceForfeit(gameId);
            await tx.wait();
            
            addNotification({
                type: 'win',
                gameId: gameId,
                message: 'üèÜ Victory by forfeit',
                timestamp: Date.now()
            });
            
            await _supabase.from('grotto_games').update({ status: 4 }).eq('game_id', gameId);
            await updatePlayerStats('gameWon');
            debouncedRefreshLobby();
            await updateBalance();
            showToast("üèÜ Victory by forfeit!");
        } catch (err) {
            console.error("Forfeit error:", err);
            showToast(err.reason || "Forfeit failed");
        }
    }

    // ============================================
    // CUSTOM CHALLENGES
    // ============================================
    
    async function createCustomChallenge() {
        if (!signer) return showToast("Summon portal first");
        if (selectedMoveIdx === 0) return showToast("Select your force first");
        if (!(await checkNetwork())) return;
        
        const target = document.getElementById('challenge-target').value.trim();
        const message = document.getElementById('challenge-message').value.trim();
        const wagerInput = document.getElementById('wager-amount').value;
        const timeout = document.getElementById('timeout-select').value;
        
        if (!target || !ethers.isAddress(target)) {
            return showToast("Invalid target address");
        }
        
        if (!message) {
            return showToast("Enter a challenge message");
        }
        
        if (message.length > 200) {
            return showToast("Message too long (max 200)");
        }
        
        try {
            const wagerValue = ethers.parseEther(wagerInput);
            
            showToast("Sending challenge...");
            const tx = await contract.createCustomChallenge(target, message, timeout, { value: wagerValue });
            
            showToast("Awaiting confirmation...");
            const receipt = await tx.wait();
            
            let challengeId = 0;
            for (const log of receipt.logs) {
                try {
                    const parsed = contract.interface.parseLog({
                        topics: log.topics,
                        data: log.data
                    });
                    if (parsed && parsed.name === 'CustomChallengeCreated') {
                        challengeId = Number(parsed.args.challengeId);
                        break;
                    }
                } catch(e) { continue; }
            }
            
            if (challengeId > 0) {
                await _supabase.from('grotto_challenges').insert([{
                    challenge_id: challengeId,
                    challenger: userAddress.toLowerCase(),
                    target: target.toLowerCase(),
                    wager_amount: wagerInput,
                    message: message,
                    timeout: parseInt(timeout),
                    timestamp: Math.floor(Date.now() / 1000),
                    status: 0
                }]);
            }
            
            showToast("‚úì Challenge sent!");
            document.getElementById('challenge-target').value = '';
            document.getElementById('challenge-message').value = '';
            await updateBalance();
        } catch (err) {
            console.error("Challenge creation error:", err);
            showToast(err.reason || "Challenge failed");
        }
    }

    // Continue in part 4c...
</script>
<!-- PARTS 4C & 4D COMBINED: Marketplace, Blood Rite, Profile, All Helpers -->
<script>
    // ============================================
    // PART 4C: MARKETPLACE & PREMIUM PROFILES
    // ============================================
    
    async function checkPremiumStatus() {
        if (!userAddress || !contract) return;
        try {
            const isPremium = await contract.hasPremiumProfile(userAddress);
            if (isPremium) {
                document.getElementById('premium-status-badge').innerHTML = '<span class="premium-badge">ACTIVE</span>';
                // Show expiry if we can get it
            }
        } catch (e) {
            console.error("Premium check error:", e);
        }
    }

    async function checkIfPremium(address) {
        if (!contract) return false;
        try {
            return await contract.hasPremiumProfile(address);
        } catch {
            return false;
        }
    }

    async function purchasePremiumProfile() {
        if (!signer) return showToast("Connect wallet first");
        if (!(await checkNetwork())) return;
        
        const btn = document.getElementById('buy-premium-btn');
        btn.disabled = true;
        
        try {
            showToast("Purchasing Arcane Ascendance...");
            const tx = await contract.purchasePremiumProfile({ value: ethers.parseEther("0.0001") });
            
            showToast("Awaiting confirmation...");
            await tx.wait();
            
            await _supabase.from('grotto_marketplace_purchases').insert([{
                address: userAddress.toLowerCase(),
                item_type: 'premium_profile',
                item_name: 'Arcane Ascendance',
                price_heresy: '0.0001',
                expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
            }]);
            
            showToast("‚ú® Arcane Ascendance activated!");
            await checkPremiumStatus();
            await updateBalance();
        } catch (err) {
            console.error("Purchase error:", err);
            showToast(err.reason || "Purchase failed");
        } finally {
            btn.disabled = false;
        }
    }

    // ============================================
    // PART 4D: BLOOD RITE SYSTEM
    // ============================================
    
    const dailyAchievements = [
        { id: 'daily_win', name: 'First Blood', desc: 'Win your first game today', points: 50, icon: '‚öîÔ∏è', check: (s) => s.dailyWins >= 1 },
        { id: 'daily_3games', name: 'Ritual Devotee', desc: 'Play 3 games today', points: 30, icon: 'üéØ', check: (s) => s.dailyGames >= 3 },
        { id: 'daily_streak', name: 'Unbroken', desc: 'Win 2 games in a row', points: 75, icon: 'üî•', check: (s) => s.dailyStreak >= 2 },
        { id: 'daily_wager', name: 'High Roller', desc: 'Wager 10+ HERESY today', points: 40, icon: 'üí∞', check: (s) => s.dailyWagered >= 10 }
    ];

    const milestoneAchievements = [
        { id: 'total_10wins', name: 'Apprentice', desc: 'Win 10 total games', points: 100, icon: 'üåü', check: (s) => s.totalWins >= 10 },
        { id: 'total_50wins', name: 'Adept', desc: 'Win 50 total games', points: 250, icon: '‚≠ê', check: (s) => s.totalWins >= 50 },
        { id: 'total_100wins', name: 'Master', desc: 'Win 100 total games', points: 500, icon: '‚ú®', check: (s) => s.totalWins >= 100 },
        { id: 'total_wager100', name: 'Whale', desc: 'Wager 100+ HERESY total', points: 200, icon: 'üêã', check: (s) => s.totalWagered >= 100 },
        { id: 'streak_5', name: 'Unstoppable', desc: 'Get a 5 win streak', points: 150, icon: 'üî•', check: (s) => s.longestStreak >= 5 }
    ];

    function updateDailyTimer() {
        const now = new Date();
        const utcMidnight = new Date();
        utcMidnight.setUTCHours(24, 0, 0, 0);
        
        const diff = utcMidnight - now;
        const hours = Math.floor(diff / 3600000);
        const minutes = Math.floor((diff % 3600000) / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);
        
        const el = document.getElementById('daily-timer');
        if (el) el.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    async function updatePlayerStats(event, amount = 0) {
        if (!userAddress) return;
        
        try {
            const today = new Date().toISOString().split('T')[0];
            
            let { data: stats } = await _supabase
                .from('grotto_player_stats')
                .select('*')
                .eq('address', userAddress.toLowerCase())
                .single();
            
            if (!stats) {
                stats = {
                    address: userAddress.toLowerCase(),
                    total_games: 0, total_wins: 0, total_losses: 0, total_draws: 0,
                    total_wagered: '0', longest_streak: 0, current_streak: 0,
                    daily_games: 0, daily_wins: 0, daily_losses: 0, daily_wagered: '0',
                    daily_streak: 0, last_daily_reset: today
                };
            }
            
            if (stats.last_daily_reset !== today) {
                stats.daily_games = 0;
                stats.daily_wins = 0;
                stats.daily_losses = 0;
                stats.daily_wagered = '0';
                stats.daily_streak = 0;
                stats.last_daily_reset = today;
            }
            
            switch(event) {
                case 'gameCreated':
                case 'gameChallenged':
                    stats.daily_games++;
                    stats.total_games++;
                    stats.daily_wagered = (parseFloat(stats.daily_wagered) + amount).toString();
                    stats.total_wagered = (parseFloat(stats.total_wagered) + amount).toString();
                    break;
                case 'gameWon':
                    stats.daily_wins++;
                    stats.total_wins++;
                    stats.daily_streak++;
                    stats.current_streak++;
                    if (stats.current_streak > stats.longest_streak) {
                        stats.longest_streak = stats.current_streak;
                    }
                    break;
                case 'gameLost':
                    stats.daily_losses++;
                    stats.total_losses++;
                    stats.daily_streak = 0;
                    stats.current_streak = 0;
                    break;
                case 'gameDraw':
                    stats.total_draws++;
                    stats.daily_streak = 0;
                    stats.current_streak = 0;
                    break;
            }
            
            await _supabase.from('grotto_player_stats').upsert(stats);
            checkAchievements();
        } catch (e) {
            console.error("Stats update error:", e);
        }
    }

    async function checkAchievements() {
        if (!userAddress) return;
        
        const { data: stats } = await _supabase
            .from('grotto_player_stats')
            .select('*')
            .eq('address', userAddress.toLowerCase())
            .single();
        
        if (!stats) return;
        
        const today = new Date().toISOString().split('T')[0];
        
        const { data: claimed } = await _supabase
            .from('grotto_bp_achievements')
            .select('achievement_id, achievement_type')
            .eq('address', userAddress.toLowerCase());
        
        const claimedIds = claimed ? claimed.map(c => c.achievement_id) : [];
        const dailyClaimed = claimed ? claimed.filter(c => c.achievement_type === 'daily' && c.claim_date === today).map(c => c.achievement_id) : [];
        
        let newCount = 0;
        dailyAchievements.forEach(ach => {
            if (!dailyClaimed.includes(ach.id) && ach.check(stats)) newCount++;
        });
        milestoneAchievements.forEach(ach => {
            if (!claimedIds.includes(ach.id) && ach.check(stats)) newCount++;
        });
        
        if (newCount > 0) {
            showToast(`${newCount} achievement${newCount > 1 ? 's' : ''} ready!`);
        }
    }

    async function claimAchievement(achievementId, isDaily, points) {
        if (!userAddress) return;
        
        try {
            const { data: existing } = await _supabase
                .from('grotto_bp_achievements')
                .select('*')
                .eq('address', userAddress.toLowerCase())
                .eq('achievement_id', achievementId);
            
            if (existing && existing.length > 0) {
                if (isDaily) {
                    const today = new Date().toISOString().split('T')[0];
                    const todayClaim = existing.find(e => e.claim_date === today);
                    if (todayClaim) {
                        showToast("Already claimed today");
                        return;
                    }
                } else {
                    showToast("Already claimed");
                    return;
                }
            }
            
            await _supabase.from('grotto_bp_achievements').insert([{
                address: userAddress.toLowerCase(),
                achievement_id: achievementId,
                achievement_type: isDaily ? 'daily' : 'milestone',
                bp_awarded: points
            }]);
            
            const { data: bp } = await _supabase
                .from('grotto_blood_points')
                .select('*')
                .eq('address', userAddress.toLowerCase())
                .single();
            
            const currentBP = bp ? bp.total_bp : 0;
            const newBP = currentBP + points;
            const newLevel = Math.floor(newBP / 100) + 1;
            
            await _supabase.from('grotto_blood_points').upsert({
                address: userAddress.toLowerCase(),
                total_bp: newBP,
                level: newLevel,
                last_daily_reset: new Date().toISOString().split('T')[0]
            });
            
            showToast(`‚úì Claimed ${points} Blood Points!`);
            loadBloodRite();
        } catch (e) {
            console.error("Claim error:", e);
            showToast("Claim failed");
        }
    }

    async function loadBloodRite() {
        if (!userAddress) return;
        
        try {
            const { data: bp } = await _supabase
                .from('grotto_blood_points')
                .select('*')
                .eq('address', userAddress.toLowerCase())
                .single();
            
            const totalBP = bp ? bp.total_bp : 0;
            const level = bp ? bp.level : 1;
            
            document.getElementById('blood-points-total').textContent = totalBP;
            document.getElementById('blood-level').textContent = level;
            document.getElementById('current-level').textContent = level;
            document.getElementById('current-bp').textContent = totalBP % 100;
            document.getElementById('next-level-bp').textContent = 100;
            document.getElementById('level-progress-bar').style.width = ((totalBP % 100) / 100 * 100) + '%';
            
            const { data: stats } = await _supabase
                .from('grotto_player_stats')
                .select('*')
                .eq('address', userAddress.toLowerCase())
                .single();
            
            const { data: claimed } = await _supabase
                .from('grotto_bp_achievements')
                .select('*')
                .eq('address', userAddress.toLowerCase());
            
            const claimedIds = claimed ? claimed.map(c => c.achievement_id) : [];
            const today = new Date().toISOString().split('T')[0];
            const dailyClaimed = claimed ? claimed.filter(c => c.achievement_type === 'daily' && c.claim_date === today).map(c => c.achievement_id) : [];
            
            const dailyEl = document.getElementById('daily-achievements');
            if (dailyEl) {
                dailyEl.innerHTML = dailyAchievements.map(ach => {
                    const completed = stats && ach.check(stats);
                    const isClaimed = dailyClaimed.includes(ach.id);
                    const canClaim = completed && !isClaimed;
                    
                    return `
                        <div class="achievement-card ${isClaimed ? 'claimed' : completed ? 'completed' : ''} p-5 rounded-lg">
                            <div class="flex items-start gap-4">
                                <div class="text-4xl">${ach.icon}</div>
                                <div class="flex-1">
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <h4 class="cinzel text-purple-300 font-bold">${ach.name}</h4>
                                            <p class="text-sm text-purple-400/70">${ach.desc}</p>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-xs text-purple-400/70 uppercase cinzel">Reward</div>
                                            <div class="cinzel text-lg text-red-400 font-bold">${ach.points} BP</div>
                                        </div>
                                    </div>
                                    ${canClaim ? 
                                        `<button onclick="claimAchievement('${ach.id}', true, ${ach.points})" class="btn-grotto w-full py-2 text-xs rounded-lg cinzel mt-2">Claim</button>` :
                                        isClaimed ? 
                                            `<div class="text-xs text-gray-500 uppercase cinzel text-center mt-2">‚úì Claimed</div>` :
                                            `<div class="text-xs text-purple-600/50 uppercase cinzel text-center mt-2">In Progress</div>`
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            const milestoneEl = document.getElementById('milestone-achievements');
            if (milestoneEl) {
                milestoneEl.innerHTML = milestoneAchievements.map(ach => {
                    const completed = stats && ach.check(stats);
                    const isClaimed = claimedIds.includes(ach.id);
                    const canClaim = completed && !isClaimed;
                    
                    return `
                        <div class="achievement-card ${isClaimed ? 'claimed' : completed ? 'completed' : ''} p-5 rounded-lg">
                            <div class="flex items-start gap-4">
                                <div class="text-4xl">${ach.icon}</div>
                                <div class="flex-1">
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <h4 class="cinzel text-purple-300 font-bold">${ach.name}</h4>
                                            <p class="text-sm text-purple-400/70">${ach.desc}</p>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-xs text-purple-400/70 uppercase cinzel">Reward</div>
                                            <div class="cinzel text-lg text-red-400 font-bold">${ach.points} BP</div>
                                        </div>
                                    </div>
                                    ${canClaim ? 
                                        `<button onclick="claimAchievement('${ach.id}', false, ${ach.points})" class="btn-grotto w-full py-2 text-xs rounded-lg cinzel mt-2">Claim</button>` :
                                        isClaimed ? 
                                            `<div class="text-xs text-gray-500 uppercase cinzel text-center mt-2">‚úì Claimed</div>` :
                                            `<div class="text-xs text-purple-600/50 uppercase cinzel text-center mt-2">Locked</div>`
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        } catch (e) {
            console.error("Blood Rite load error:", e);
        }
    }

    // ============================================
    // PROFILE & CHALLENGES
    // ============================================
    
    async function loadProfile() {
        const content = document.getElementById('profile-stats-content');
        if (!content) return;
        
        if (!userAddress) {
            content.innerHTML = `
                <div class="text-center py-20">
                    <div class="text-7xl mb-4 text-purple-500/30">üîí</div>
                    <div class="cinzel text-xl mb-2 text-purple-400">PORTAL REQUIRED</div>
                    <div class="text-purple-500/70 text-sm">Summon portal to view your chronicle</div>
                </div>`;
            return;
        }

        try {
            const { data: stats } = await _supabase
                .from('grotto_player_stats')
                .select('*')
                .eq('address', userAddress.toLowerCase())
                .single();
            
            const { data: bp } = await _supabase
                .from('grotto_blood_points')
                .select('*')
                .eq('address', userAddress.toLowerCase())
                .single();
            
            const isPremium = await checkIfPremium(userAddress);
            const username = await getUsernameOrAddress(userAddress);
            const totalBP = bp ? bp.total_bp : 0;
            const level = bp ? bp.level : 1;

            content.innerHTML = `
                <div class="grotto-glass ${isPremium ? 'premium-profile' : ''} border-2 border-purple-500/30 p-8 rounded-xl mb-6 relative">
                    ${isPremium ? '<div class="arcane-particles"></div>' : ''}
                    <div class="flex justify-between items-start mb-6 relative z-10">
                        <div>
                            <h3 class="cinzel text-2xl ${isPremium ? 'premium-name' : 'text-purple-300'} mb-2">${username}</h3>
                            <div class="text-sm text-purple-400/70">${userAddress}</div>
                            ${isPremium ? '<div class="mt-2"><span class="premium-badge">‚ú® ARCANE ASCENDANCE</span></div>' : ''}
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-purple-400/70 uppercase mb-1">Blood Level</div>
                            <div class="cinzel text-3xl text-red-400 font-bold">${level}</div>
                            <div class="text-xs text-purple-500/50">${totalBP} BP</div>
                        </div>
                    </div>
                    <button onclick="updateUsername()" class="btn-grotto px-6 py-2 text-xs rounded-lg cinzel relative z-10">
                        Update Username
                    </button>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="stat-card p-6 rounded-xl text-center">
                        <div class="text-[11px] text-purple-400/70 uppercase mb-2 cinzel">Total Games</div>
                        <div class="cinzel text-3xl text-purple-400 font-bold">${stats?.total_games || 0}</div>
                    </div>
                    <div class="stat-card p-6 rounded-xl text-center border-green-900/30">
                        <div class="text-[11px] text-green-400/70 uppercase mb-2 cinzel">Wins</div>
                        <div class="cinzel text-3xl text-green-400 font-bold">${stats?.total_wins || 0}</div>
                    </div>
                    <div class="stat-card p-6 rounded-xl text-center border-red-900/30">
                        <div class="text-[11px] text-red-400/70 uppercase mb-2 cinzel">Losses</div>
                        <div class="cinzel text-3xl text-red-400 font-bold">${stats?.total_losses || 0}</div>
                    </div>
                    <div class="stat-card p-6 rounded-xl text-center border-yellow-900/30">
                        <div class="text-[11px] text-yellow-400/70 uppercase mb-2 cinzel">Best Streak</div>
                        <div class="cinzel text-3xl text-yellow-400 font-bold">${stats?.longest_streak || 0}</div>
                    </div>
                </div>

                <div class="grotto-glass p-6 rounded-xl">
                    <h3 class="cinzel text-lg text-purple-300 mb-4">Statistics</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between py-2 border-b border-purple-900/20">
                            <span class="text-purple-300">Total Wagered:</span>
                            <span class="cinzel text-purple-400 font-semibold">${parseFloat(stats?.total_wagered || 0).toFixed(5)} $HERESY</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-purple-900/20">
                            <span class="text-purple-300">Win Rate:</span>
                            <span class="cinzel font-semibold ${((stats?.total_wins || 0)/(stats?.total_games || 1)*100) >= 50 ? 'text-green-400' : 'text-red-400'}">${((stats?.total_wins || 0)/(stats?.total_games || 1)*100).toFixed(1)}%</span>
                        </div>
                        <div class="flex justify-between py-2">
                            <span class="text-purple-300">Current Streak:</span>
                            <span class="cinzel text-yellow-400 font-semibold">${stats?.current_streak || 0}</span>
                        </div>
                    </div>
                </div>
            `;
            
            if (isPremium) {
                createPremiumParticles();
            }
        } catch (e) {
            console.error("Profile load error:", e);
        }
    }

    function createPremiumParticles() {
        const container = document.querySelector('.arcane-particles');
        if (!container) return;
        
        for (let i = 0; i < 15; i++) {
            const particle = document.createElement('div');
            particle.className = 'arcane-particle';
            particle.style.left = Math.random() * 100 + '%';
            particle.style.animationDuration = (Math.random() * 3 + 2) + 's';
            particle.style.animationDelay = Math.random() * 2 + 's';
            container.appendChild(particle);
        }
    }

    async function loadUserChallenges() {
        const content = document.getElementById('profile-challenges-content');
        if (!content || !userAddress) return;
        
        try {
            const { data: incoming } = await _supabase
                .from('grotto_challenges')
                .select('*')
                .eq('target', userAddress.toLowerCase())
                .order('created_at', { ascending: false });
            
            const { data: outgoing } = await _supabase
                .from('grotto_challenges')
                .select('*')
                .eq('challenger', userAddress.toLowerCase())
                .order('created_at', { ascending: false });
            
            content.innerHTML = `
                <div class="mb-6">
                    <h3 class="cinzel text-xl text-purple-300 mb-4">Incoming Challenges</h3>
                    <div class="space-y-3">
                        ${incoming && incoming.length > 0 ? incoming.map(c => renderChallenge(c, true)).join('') : '<div class="text-center text-purple-700/50 py-8">No incoming challenges</div>'}
                    </div>
                </div>
                <div>
                    <h3 class="cinzel text-xl text-purple-300 mb-4">Sent Challenges</h3>
                    <div class="space-y-3">
                        ${outgoing && outgoing.length > 0 ? outgoing.map(c => renderChallenge(c, false)).join('') : '<div class="text-center text-purple-700/50 py-8">No sent challenges</div>'}
                    </div>
                </div>
            `;
        } catch (e) {
            console.error("Challenges load error:", e);
        }
    }

    function renderChallenge(c, isIncoming) {
        const statusColors = ['#f59e0b', '#22c55e', '#6b7280', '#f59e0b', '#6b7280', '#15803d'];
        const statusTexts = ['Pending', 'Accepted', 'Declined', 'Counter-Offered', 'Expired', 'Resolved'];
        
        return `
            <div class="challenge-card p-4 rounded-lg" style="border-left: 3px solid ${statusColors[c.status]}">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <div class="text-sm font-semibold text-purple-300">${isIncoming ? 'From' : 'To'}: ${c[isIncoming ? 'challenger' : 'target'].slice(0,10)}...</div>
                        <div class="text-xs text-purple-400/70">${parseFloat(c.wager_amount).toFixed(5)} $HERESY</div>
                    </div>
                    <div class="text-xs px-2 py-1 rounded" style="background: ${statusColors[c.status]}22; color: ${statusColors[c.status]}">${statusTexts[c.status]}</div>
                </div>
                <div class="text-sm text-purple-200 mb-2 italic">"${c.message}"</div>
                ${c.status === 0 && isIncoming ? '<div class="flex gap-2"><button class="btn-grotto flex-1 py-2 text-xs rounded cinzel">Accept</button><button class="border border-purple-700 flex-1 py-2 text-xs rounded cinzel">Decline</button></div>' : ''}
            </div>
        `;
    }

    function switchProfileTab(tab) {
        document.querySelectorAll('[id^="profile-tab-"]').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`profile-tab-${tab}`).classList.add('active');
        
        document.querySelectorAll('.profile-tab-content').forEach(content => content.classList.add('hidden'));
        document.getElementById(`profile-${tab}-content`).classList.remove('hidden');
        
        if (tab === 'challenges') loadUserChallenges();
    }

    // ============================================
    // CHAT, ACTIVITY, NOTIFICATIONS, HELPERS
    // ============================================
    
    async function refreshChat() {
        const chatMessages = document.getElementById('chat-messages');
        if (!chatMessages) return;
        
        try {
            const { data: messages } = await _supabase
                .from('grotto_chat')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(50);

            if (!messages) return;

            const shouldScroll = chatMessages.scrollHeight - chatMessages.scrollTop === chatMessages.clientHeight;

            const items = await Promise.all(messages.reverse().map(async msg => {
                const isOwn = userAddress && msg.sender.toLowerCase() === userAddress.toLowerCase();
                const senderName = await getUsernameOrAddress(msg.sender);
                return `
                    <div class="${isOwn ? 'text-right' : 'text-left'}">
                        <div class="inline-block max-w-[80%] px-4 py-3 rounded-lg" style="background: ${isOwn ? 'rgba(147, 51, 234, 0.3)' : 'rgba(76, 29, 149, 0.3)'}">
                            <div class="text-[10px] text-purple-400/70 mb-1 cinzel">${senderName}</div>
                            <div class="text-sm text-purple-100">${escapeHtml(msg.message)}</div>
                        </div>
                    </div>
                `;
            }));

            chatMessages.innerHTML = items.join('');

            if (shouldScroll) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        } catch (err) {
            console.error("Chat error:", err);
        }
    }

    async function sendMessage() {
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        
        if (!message || !userAddress) return;
        
        try {
            await _supabase.from('grotto_chat').insert([{
                sender: userAddress.toLowerCase(),
                message: message
            }]);
            input.value = '';
            refreshChat();
        } catch (err) {
            console.error("Send error:", err);
            showToast("Message failed");
        }
    }

    async function refreshActivityFeed() {
        const feed = document.getElementById('activity-feed');
        if (!feed) return;
        
        try {
            const { data: games } = await _supabase
                .from('grotto_games')
                .select('*')
                .eq('status', 2)
                .order('updated_at', { ascending: false })
                .limit(50);

            if (!games) return;

            const items = await Promise.all(games.map(async game => {
                const hostMove = Number(game.host_move);
                const challengerMove = Number(game.challenger_move);
                
                let result = '', resultColor = '';
                const hostName = await getUsernameOrAddress(game.host);
                const challengerName = await getUsernameOrAddress(game.challenger || 'Unknown');
                
                if (hostMove === challengerMove) {
                    result = 'STALEMATE';
                    resultColor = 'text-yellow-400';
                } else if (
                    (hostMove === 1 && challengerMove === 2) ||
                    (hostMove === 2 && challengerMove === 3) ||
                    (hostMove === 3 && challengerMove === 1)
                ) {
                    result = `${hostName} PREVAILS`;
                    resultColor = 'text-green-400';
                } else {
                    result = `${challengerName} PREVAILS`;
                    resultColor = 'text-green-400';
                }
                
                const timeAgo = getTimeAgo(new Date(game.updated_at || game.created_at));
                
                return `
                    <div class="grotto-glass border-l-4 border-purple-600 p-4 rounded-lg flex justify-between items-center hover:bg-purple-900/10 transition">
                        <div class="flex-1">
                            <div class="text-sm ${resultColor} font-bold cinzel">${result}</div>
                            <div class="text-[11px] text-purple-500/60 mt-1 flex items-center gap-2">
                                <img src="${moveImages[hostMove]}" class="w-5 h-5 object-contain"> ${moveNames[hostMove]} vs 
                                <img src="${moveImages[challengerMove]}" class="w-5 h-5 object-contain"> ${moveNames[challengerMove]} ‚Ä¢ 
                                ${parseFloat(game.wager).toFixed(5)} $HERESY ‚Ä¢ ${timeAgo}
                            </div>
                        </div>
                        <div class="text-3xl">${result.includes('STALEMATE') ? '‚öñÔ∏è' : 'üèÜ'}</div>
                    </div>
                `;
            }));

            feed.innerHTML = items.join('') || '<div class="text-center text-purple-700/50 py-8 italic">No recent battles...</div>';
        } catch (err) {
            console.error("Activity error:", err);
        }
    }

    async function loadLeaderboard() {
        try {
            const { data: allStats } = await _supabase
                .from('grotto_player_stats')
                .select('*')
                .order('total_wagered', { ascending: false })
                .limit(100);

            if (!allStats) return;

            const tbody = document.getElementById('leaderboard-body');
            const rows = await Promise.all(allStats.map(async (player, index) => {
                const winRate = player.total_games > 0 ? ((player.total_wins / player.total_games) * 100).toFixed(1) : 0;
                const playerName = await getUsernameOrAddress(player.address);
                const isPremium = await checkIfPremium(player.address);
                
                return `
                    <tr class="border-b border-purple-900/20 hover:bg-purple-900/10 cursor-pointer transition">
                        <td class="p-4 text-purple-400 cinzel font-bold">#${index + 1}</td>
                        <td class="p-4">
                            <div class="text-sm ${isPremium ? 'premium-name' : 'text-purple-200'}">${playerName}</div>
                            <div class="text-[11px] text-purple-600/60">${player.total_games} rituals</div>
                        </td>
                        <td class="p-4 text-right cinzel text-purple-400 font-semibold">${parseFloat(player.total_wagered).toFixed(5)}</td>
                        <td class="p-4 text-right cinzel font-semibold ${winRate >= 50 ? 'text-green-400' : 'text-red-400'}">${winRate}%</td>
                        <td class="p-4 text-right cinzel text-purple-400">${parseFloat(player.total_wagered).toFixed(5)}</td>
                        <td class="p-4 text-right cinzel text-yellow-400">${player.longest_streak}</td>
                    </tr>
                `;
            }));
            
            tbody.innerHTML = rows.join('');
        } catch (err) {
            console.error("Leaderboard error:", err);
        }
    }

    function addNotification(notif) {
        if (!userAddress) return;
        
        const notifications = JSON.parse(localStorage.getItem(`grotto_notifs_${userAddress}`) || '[]');
        
        let message = '';
        if (notif.type === 'win') {
            message = winMessages[Math.floor(Math.random() * winMessages.length)];
        } else if (notif.type === 'loss') {
            message = lossMessages[Math.floor(Math.random() * lossMessages.length)];
        } else {
            message = drawMessages[Math.floor(Math.random() * drawMessages.length)];
        }
        
        const newNotif = {
            ...notif,
            motivationalMessage: message,
            read: false
        };
        
        notifications.unshift(newNotif);
        localStorage.setItem(`grotto_notifs_${userAddress}`, JSON.stringify(notifications.slice(0, 50)));
        
        loadNotifications();
    }

    function loadNotifications() {
        if (!userAddress) return;
        
        const notifications = JSON.parse(localStorage.getItem(`grotto_notifs_${userAddress}`) || '[]');
        userNotifications = notifications;
        
        const unreadCount = notifications.filter(n => !n.read).length;
        const badge = document.getElementById('notification-badge');
        
        if (unreadCount > 0) {
            badge.textContent = unreadCount;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
        
        renderNotifications();
    }

    function renderNotifications() {
        const list = document.getElementById('notification-list');
        
        if (userNotifications.length === 0) {
            list.innerHTML = '<div class="p-8 text-center text-purple-700/50 italic">No omens...</div>';
            return;
        }
        
        list.innerHTML = userNotifications.map(notif => {
            const bgClass = notif.type === 'win' ? 'bg-green-900/10' : notif.type === 'loss' ? 'bg-red-900/10' : 'bg-yellow-900/10';
            const borderClass = notif.type === 'win' ? 'win' : notif.type === 'loss' ? 'loss' : '';
            
            return `
                <div class="notification-item ${borderClass} p-4 ${bgClass} ${notif.read ? 'opacity-50' : ''}">
                    <div class="flex items-start justify-between gap-3">
                        <div class="flex-1">
                            <div class="text-sm font-semibold text-purple-300 mb-1">${notif.message}</div>
                            <div class="text-xs text-purple-400/70 mb-2">Game #${notif.gameId} ‚Ä¢ ${getTimeAgo(new Date(notif.timestamp))}</div>
                            <div class="text-sm text-purple-200/80 italic">${notif.motivationalMessage}</div>
                        </div>
                        ${!notif.read ? '<div class="w-2 h-2 bg-purple-500 rounded-full"></div>' : ''}
                    </div>
                </div>
            `;
        }).join('');
    }

    function toggleNotifications() {
        document.getElementById('notification-panel').classList.toggle('active');
    }

    function markAllRead() {
        if (!userAddress) return;
        userNotifications = userNotifications.map(n => ({ ...n, read: true }));
        localStorage.setItem(`grotto_notifs_${userAddress}`, JSON.stringify(userNotifications));
        loadNotifications();
    }

    document.addEventListener('click', (e) => {
        const panel = document.getElementById('notification-panel');
        const btn = document.getElementById('notification-btn');
        if (!panel.contains(e.target) && !btn.contains(e.target)) {
            panel.classList.remove('active');
        }
    });

    function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        if (seconds < 60) return `${seconds}s ago`;
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes}m ago`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}h ago`;
        const days = Math.floor(hours / 24);
        return `${days}d ago`;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function getStatusText(s) { 
        return ["Open", "Active", "Sealed", "Retracted", "Forfeited"][s]; 
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.add('active');
        
        document.querySelectorAll('.page-section').forEach(section => section.classList.remove('active'));
        document.getElementById(`page-${tab}`).classList.add('active');
        
        if (tab === 'profile') {
            loadProfile();
            loadUserChallenges();
        }
        if (tab === 'leaderboard') loadLeaderboard();
        if (tab === 'bloodrite') loadBloodRite();
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.remove('translate-y-32');
        setTimeout(() => t.classList.add('translate-y-32'), 4000);
    }

    window.onload = init;

    window.onbeforeunload = () => {
        if (lobbyRefreshInterval) clearInterval(lobbyRefreshInterval);
        if (activityRefreshInterval) clearInterval(activityRefreshInterval);
        if (chatRefreshInterval) clearInterval(chatRefreshInterval);
        if (dailyTimerInterval) clearInterval(dailyTimerInterval);
    };
</script>
</body>
</html>
