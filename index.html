<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Erol's Martian Gambit | Martian Chain</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --mars-red: #ff4d00;
            --habitat-bg: #060608;
            --panel-bg: rgba(15, 15, 20, 0.98);
        }

        body {
            background-color: var(--habitat-bg);
            color: #e0e0e0;
            font-family: 'Share Tech Mono', monospace;
            overflow-x: hidden;
            margin: 0;
            background-image: radial-gradient(circle at 2px 2px, rgba(255, 77, 0, 0.05) 1px, transparent 0);
            background-size: 40px 40px;
        }

        .orbitron { font-family: 'Orbitron', sans-serif; }
        
        .mars-glass {
            background: var(--panel-bg);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 77, 0, 0.2);
            box-shadow: 0 0 25px rgba(0,0,0,0.7);
        }

        .btn-mars {
            background: var(--mars-red);
            color: black;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
        }

        .btn-mars:hover:not(:disabled) {
            background: transparent;
            color: var(--mars-red);
            border-color: var(--mars-red);
            box-shadow: 0 0 20px rgba(255, 77, 0, 0.4);
            transform: scale(1.02);
        }

        .btn-mars:disabled { opacity: 0.3; cursor: not-allowed; }

        .input-mars {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 77, 0, 0.3);
            color: #fff;
            font-family: 'Share Tech Mono', monospace;
        }

        .scanline {
            width: 100%; height: 2px;
            background: rgba(255, 77, 0, 0.05);
            position: fixed;
            top: 0; left: 0;
            animation: scan 10s linear infinite;
            z-index: 100; pointer-events: none;
        }

        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }

        .move-card {
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid rgba(255, 77, 0, 0.1);
        }

        .move-card:hover:not(.locked) {
            border-color: var(--mars-red);
            background: rgba(255, 77, 0, 0.05);
            transform: translateY(-8px);
        }

        .move-card.selected {
            border-color: var(--mars-red);
            background: rgba(255, 77, 0, 0.2);
            box-shadow: 0 0 40px rgba(255, 77, 0, 0.3);
        }

        .nav-link {
            font-size: 10px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: rgba(255, 77, 0, 0.5);
            transition: 0.3s;
            cursor: pointer;
        }

        .nav-link:hover, .nav-link.active {
            color: var(--mars-red);
        }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: var(--mars-red); }
    </style>
</head>
<body class="min-h-screen">
    <div class="scanline"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 z-[200] flex flex-col items-center justify-center hidden bg-black/90 backdrop-blur-md">
        <div class="w-16 h-16 border-4 border-orange-900 border-t-orange-500 rounded-full animate-spin mb-6"></div>
        <p id="loadingText" class="orbitron text-xs tracking-[0.5em] text-orange-500 uppercase">Synchronizing Systems</p>
    </div>

    <!-- Navigation -->
    <nav class="mars-glass border-b border-orange-500/20 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 h-20 flex justify-between items-center">
            <div class="flex items-center gap-8">
                <div class="flex items-center gap-3 cursor-pointer" onclick="switchView('lobby')">
                    <div class="w-10 h-10 bg-orange-600 flex items-center justify-center rounded-sm shadow-[0_0_15px_rgba(255,77,0,0.4)]">
                        <i class="fas fa-radiation text-black text-lg"></i>
                    </div>
                    <span class="orbitron font-bold text-xl tracking-tighter text-white uppercase italic">EROL<span class="text-orange-500 font-normal">GAMBIT</span></span>
                </div>
                
                <div class="hidden md:flex gap-6">
                    <span onclick="switchView('lobby')" class="nav-link orbitron active" id="nav-lobby">Lobby</span>
                    <span onclick="switchView('leaderboard')" class="nav-link orbitron" id="nav-leaderboard">Leaderboard</span>
                    <span onclick="switchView('profile')" class="nav-link orbitron" id="nav-profile">Profile</span>
                </div>
            </div>
            
            <div class="flex items-center gap-6">
                <div id="walletDisplay" class="hidden flex flex-col items-end">
                    <p id="navBalance" class="orbitron text-orange-500 text-sm font-bold">0.00 EROL</p>
                    <p id="navAddr" class="text-[9px] opacity-40 font-mono"></p>
                </div>
                <button id="connectBtn" class="btn-mars px-6 py-2 text-xs rounded-sm orbitron">
                    Uplink_Wallet
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-6 mt-10 grid grid-cols-1 lg:grid-cols-12 gap-8 mb-20">
        
        <!-- Sidebar: Comms -->
        <div class="lg:col-span-3 space-y-6">
            <div class="mars-glass p-5 flex flex-col h-[500px]">
                <div class="flex justify-between items-center mb-4 border-b border-orange-500/20 pb-2">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-satellite-dish text-[10px] text-orange-500"></i>
                        <span class="text-[10px] orbitron uppercase text-orange-500">Comms_Feed</span>
                    </div>
                    <span class="text-[8px] opacity-30 animate-pulse">LIVE_FREQ</span>
                </div>
                <div id="chatBox" class="flex-grow overflow-y-auto space-y-3 mb-4 pr-2 text-[11px] font-mono scroll-smooth"></div>
                <div class="flex gap-2">
                    <input type="text" id="chatInput" placeholder="TRANSMIT..." class="flex-grow input-mars px-3 py-2 text-xs uppercase" maxlength="100" />
                    <button id="sendChat" class="bg-orange-500/10 hover:bg-orange-500 border border-orange-500/30 px-3 text-orange-500 hover:text-black transition-all">
                        <i class="fas fa-chevron-right text-xs"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="lg:col-span-9">
            
            <!-- VIEW: LOBBY -->
            <div id="view-lobby" class="space-y-8 animate-in fade-in duration-500">
                <div class="mars-glass p-10 relative overflow-hidden group">
                    <div class="relative z-10">
                        <h2 class="orbitron text-4xl font-bold text-white mb-2 uppercase tracking-tighter italic">Initiate_Gambit</h2>
                        <p class="text-orange-500/60 text-xs mb-8 max-w-md uppercase tracking-[0.2em] font-bold">Staked 1v1 on Martian Chain Layer 1.</p>
                        
                        <div class="flex flex-wrap gap-6 items-end">
                            <div class="flex flex-col gap-2">
                                <label class="text-[10px] text-orange-500/40 uppercase orbitron tracking-widest">Wager_Amount (EROL)</label>
                                <div class="flex items-center bg-black/80 border border-orange-500/30 px-5 py-3 group-hover:border-orange-500/60 transition-all">
                                    <input type="number" id="wagerInput" value="100" min="1" class="bg-transparent text-2xl font-bold w-32 outline-none text-orange-500" />
                                    <span class="text-xs opacity-40 ml-2 orbitron">EROL</span>
                                </div>
                            </div>
                            <button onclick="hostGame()" class="btn-mars px-10 py-4 orbitron text-sm shadow-lg shadow-orange-500/10">
                                Deploy_Signal
                            </button>
                        </div>
                    </div>
                    <div class="absolute -right-10 -bottom-10 opacity-[0.03] pointer-events-none transition-transform group-hover:scale-110 duration-1000">
                        <i class="fas fa-globe-africa text-[20rem]"></i>
                    </div>
                </div>

                <div id="hostingStatus" class="hidden mars-glass p-6 border-orange-500/50 animate-pulse flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <div class="w-2 h-2 bg-orange-500 rounded-full"></div>
                        <span class="orbitron text-xs text-orange-500 uppercase tracking-widest">Broadcasting Active... Awaiting Challenger</span>
                    </div>
                    <button onclick="cancelMatch()" class="text-[10px] text-red-500 hover:text-white transition-colors border border-red-500/20 px-3 py-1 rounded">CANCEL_SIGNAL</button>
                </div>

                <div class="space-y-6">
                    <div class="flex items-center justify-between">
                        <h3 class="orbitron text-xs font-bold text-orange-500 uppercase tracking-[0.4em]">Broadcasts_In_Sector</h3>
                        <span id="matchCount" class="text-[9px] opacity-30 uppercase font-mono">Scanning...</span>
                    </div>
                    <div id="matchGrid" class="grid grid-cols-1 md:grid-cols-2 gap-5"></div>
                </div>
            </div>

            <!-- VIEW: ACTIVE GAME -->
            <div id="view-game" class="space-y-6 hidden">
                <div class="mars-glass p-8 flex justify-between items-center border-b-4 border-orange-500">
                    <div class="flex items-center gap-6">
                        <div class="w-14 h-14 bg-orange-500/10 flex items-center justify-center border border-orange-500/30">
                            <i class="fas fa-shield-virus text-2xl text-orange-500 animate-pulse"></i>
                        </div>
                        <div>
                            <p class="text-[10px] text-orange-500/40 uppercase orbitron tracking-widest">Tactical_Engagement</p>
                            <h2 id="matchTitle" class="orbitron text-xl font-bold text-white uppercase tracking-tighter">Active Protocol</h2>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] text-orange-500/40 uppercase orbitron">Escrow_Pot</p>
                        <p id="matchPool" class="orbitron text-3xl font-bold text-orange-500">0.00 EROL</p>
                    </div>
                </div>

                <div id="resolutionDisplay" class="hidden mars-glass p-12 text-center space-y-6 border-2">
                    <h2 id="resultTitle" class="orbitron text-6xl font-black italic uppercase">RESULT</h2>
                    <p id="resultDesc" class="text-sm tracking-[0.8em] text-orange-500 uppercase"></p>
                    <div class="flex justify-center gap-10 py-6">
                        <div class="text-center">
                            <p class="text-[10px] opacity-40 uppercase mb-2">Your Move</p>
                            <div id="myFinalMove" class="w-16 h-16 border border-orange-500/30 rounded-full flex items-center justify-center bg-orange-500/5"></div>
                        </div>
                        <div class="text-center">
                            <p class="text-[10px] opacity-40 uppercase mb-2">Enemy Move</p>
                            <div id="enemyFinalMove" class="w-16 h-16 border border-orange-500/30 rounded-full flex items-center justify-center bg-orange-500/5"></div>
                        </div>
                    </div>
                    <button onclick="switchView('lobby')" class="btn-mars px-12 py-3 text-sm orbitron">Dismiss_Record</button>
                </div>

                <div id="gameplayInterface" class="space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Moves -->
                        <div class="move-card mars-glass p-10 text-center flex flex-col items-center gap-5 group" onclick="selectMove(1)">
                            <div class="w-24 h-24 rounded-full flex items-center justify-center bg-orange-500/10 border-2 border-orange-500/20 group-hover:scale-110 transition-all duration-500">
                                <i class="fas fa-sun text-5xl text-orange-500"></i>
                            </div>
                            <h3 class="orbitron font-bold text-white text-lg tracking-widest">Solar_Flare</h3>
                            <p class="text-[9px] text-orange-500/40 uppercase leading-loose">Destroys O2_Siphon</p>
                        </div>

                        <div class="move-card mars-glass p-10 text-center flex flex-col items-center gap-5 group" onclick="selectMove(2)">
                            <div class="w-24 h-24 rounded-full flex items-center justify-center bg-blue-500/10 border-2 border-blue-500/20 group-hover:scale-110 transition-all duration-500">
                                <i class="fas fa-wind text-5xl text-blue-500"></i>
                            </div>
                            <h3 class="orbitron font-bold text-white text-lg tracking-widest">O2_Siphon</h3>
                            <p class="text-[9px] text-blue-500/40 uppercase leading-loose">Clears Dust_Storm</p>
                        </div>

                        <div class="move-card mars-glass p-10 text-center flex flex-col items-center gap-5 group" onclick="selectMove(3)">
                            <div class="w-24 h-24 rounded-full flex items-center justify-center bg-yellow-500/10 border-2 border-yellow-500/20 group-hover:scale-110 transition-all duration-500">
                                <i class="fas fa-cloud-showers-heavy text-5xl text-yellow-500"></i>
                            </div>
                            <h3 class="orbitron font-bold text-white text-lg tracking-widest">Dust_Storm</h3>
                            <p class="text-[9px] text-yellow-500/40 uppercase leading-loose">Blocks Solar_Flare</p>
                        </div>
                    </div>

                    <div class="mars-glass p-8 flex flex-col items-center gap-6">
                        <div class="text-center">
                            <p id="moveStatus" class="orbitron text-xs text-orange-500 uppercase tracking-[0.4em] animate-pulse">Awaiting Tactical Selection</p>
                            <p id="moveWaitMsg" class="hidden text-[10px] opacity-30 mt-2 italic">Waiting for opponent to reveal their hand...</p>
                        </div>
                        <button id="lockMoveBtn" disabled onclick="handleMoveSubmission()" class="btn-mars px-16 py-4 orbitron text-sm w-full md:w-auto shadow-2xl">
                            Commit_Tactical_Move
                        </button>
                    </div>
                </div>
            </div>

            <!-- VIEW: LEADERBOARD -->
            <div id="view-leaderboard" class="space-y-6 hidden">
                <div class="mars-glass p-8">
                    <h2 class="orbitron text-2xl font-bold text-white uppercase italic border-b border-orange-500/20 pb-4 mb-6">Sector_Rankings</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm font-mono">
                            <thead>
                                <tr class="text-orange-500/40 uppercase text-[10px] orbitron tracking-widest">
                                    <th class="py-4 px-2">Rank</th>
                                    <th class="py-4 px-2">Pilot</th>
                                    <th class="py-4 px-2">Victories</th>
                                    <th class="py-4 px-2">Vol_EROL</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboardList"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW: PROFILE -->
            <div id="view-profile" class="space-y-8 hidden">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-8">
                    <div class="md:col-span-4 mars-glass p-10 text-center flex flex-col items-center">
                        <div class="w-32 h-32 border-2 border-orange-500/30 flex items-center justify-center bg-orange-500/5 mb-8 relative">
                            <i class="fas fa-user-astronaut text-5xl text-orange-500"></i>
                            <div class="absolute -bottom-2 -right-2 bg-orange-500 text-black px-2 py-1 text-[8px] orbitron font-bold">L1_PILOT</div>
                        </div>
                        <div class="space-y-6 w-full">
                            <div>
                                <label class="text-[9px] text-orange-500/40 uppercase tracking-widest block mb-2">Call_Sign</label>
                                <input id="editUsername" type="text" class="w-full input-mars text-center py-3 text-lg font-bold uppercase tracking-widest" placeholder="PILOT_ID" />
                            </div>
                            <button onclick="updateProfile()" class="w-full btn-mars py-3 text-xs orbitron">Sync_Identity</button>
                        </div>
                    </div>
                    
                    <div class="md:col-span-8 space-y-6">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <div class="mars-glass p-8 border-l-4 border-orange-500">
                                <p class="text-[10px] text-orange-500/40 uppercase mb-4 tracking-[0.2em]">Live_Liquidity</p>
                                <p id="profBalance" class="orbitron text-4xl font-bold text-white">0.00</p>
                                <p class="text-[10px] text-orange-500 mt-3 italic font-mono uppercase">Currency: EROL</p>
                            </div>
                            <div class="mars-glass p-8 border-l-4 border-orange-500">
                                <p class="text-[10px] text-orange-500/40 uppercase mb-4 tracking-[0.2em]">Engagements_Won</p>
                                <p id="profWins" class="orbitron text-4xl font-bold text-white">0</p>
                                <p class="text-[10px] text-orange-500 mt-3 italic font-mono uppercase">Verified_on_Chain</p>
                            </div>
                        </div>
                        <div class="mars-glass p-8">
                            <h4 class="orbitron text-[10px] text-orange-500/40 uppercase tracking-widest mb-4">Uplink_Identity_Data</h4>
                            <div class="bg-black/50 p-4 border border-orange-500/20 font-mono text-[10px] break-all opacity-60" id="profAddress"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <div id="toast" class="fixed bottom-10 right-10 px-8 py-4 border-l-4 font-bold text-xs uppercase orbitron hidden z-[250] bg-black/95 backdrop-blur-xl shadow-[0_0_50px_rgba(0,0,0,1)]"></div>

    <script>
        // CONFIGURATION
        const CHAIN_ID = "0x7EB"; 
        const RPC_URL = "https://martian-rpc1.amichain.org/";
        const EROL_TOKEN_ADDR = "0xcac4904e1db1589aa17a2ec742f5a6bcf4c4d037";
        const GAMBIT_CONTRACT_ADDR = "0x0b912a321801B2f6062b4BdC3d9763e643584074";

        const SUPABASE_URL = "https://pcbrvtldeqhqllsilonl.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBjYnJ2dGxkZXFocWxsc2lsb25sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NTMyODUsImV4cCI6MjA4NjIyOTI4NX0.XtRbmbVqPT-7IrtsxmyMKbn_Ii_M1t_aGfCMnTVXu18";
        
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let provider, signer, userWallet, userProfile, currentMatchId, selectedMoveIdx;

        function toChecksum(addr) { return ethers.getAddress(addr); }

        async function init() {
            if (window.ethereum) {
                provider = new ethers.BrowserProvider(window.ethereum);
                setupRealtime();
                refreshLobby();
                fetchLeaderboard();
                
                window.ethereum.on('accountsChanged', (acc) => acc.length > 0 ? connect() : location.reload());
                window.ethereum.on('chainChanged', () => location.reload());
            }
        }

        async function connect() {
            if (!window.ethereum) return showToast("METAMASK_NOT_FOUND", true);
            showLoading("LINKING_UPLINK...");
            try {
                const network = await provider.getNetwork();
                if (network.chainId !== BigInt(2027)) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: CHAIN_ID }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: CHAIN_ID,
                                    chainName: 'Martian Chain',
                                    nativeCurrency: { name: 'Martian', symbol: 'MARS', decimals: 18 },
                                    rpcUrls: [RPC_URL],
                                    blockExplorerUrls: ['https://explorer.martianchain.com/']
                                }],
                            });
                        }
                    }
                }

                const accounts = await provider.send("eth_requestAccounts", []);
                userWallet = toChecksum(accounts[0]);
                signer = await provider.getSigner();
                
                await syncProfile();
                await fetchErolBalance();
                updateNavUI();
                showToast("UPLINK_SECURE");
            } catch (err) {
                console.error(err);
                showToast("UPLINK_FAILED: " + err.message, true);
            } finally {
                hideLoading();
            }
        }

        async function syncProfile() {
            if (!userWallet) return;
            const addr = userWallet.toLowerCase();
            
            try {
                // Force a selection to check if profile exists
                let { data, error } = await sb.from('profiles').select('*').eq('wallet_address', addr).maybeSingle();
                
                if (error) throw error;

                if (!data) {
                    const fallbackName = `PILOT_${addr.slice(2, 6).toUpperCase()}`;
                    const { data: newUser, error: upsertErr } = await sb.from('profiles').upsert({
                        wallet_address: addr,
                        username: fallbackName
                    }, { onConflict: 'wallet_address' }).select().single();
                    
                    if (upsertErr) throw upsertErr;
                    data = newUser;
                }
                
                userProfile = data;
                updateProfileUI();
                return data;
            } catch (e) {
                console.error("Sync Profile Error:", e);
                userProfile = { wallet_address: addr, username: 'RECON_PILOT', id: null };
                updateProfileUI();
                return null;
            }
        }

        async function fetchErolBalance() {
            if (!userWallet) return;
            try {
                const abi = ["function balanceOf(address) view returns (uint256)", "function decimals() view returns (uint8)"];
                const contract = new ethers.Contract(toChecksum(EROL_TOKEN_ADDR), abi, provider);
                const bal = await contract.balanceOf(userWallet);
                const dec = await contract.decimals();
                const formatted = ethers.formatUnits(bal, dec);
                
                const display = parseFloat(formatted).toLocaleString(undefined, { minimumFractionDigits: 2 });
                document.getElementById('navBalance').innerText = `${display} EROL`;
                document.getElementById('profBalance').innerText = display;
            } catch (e) { console.error("Balance Fetch Err:", e); }
        }

        async function hostGame() {
            if (!userWallet) return connect();
            
            // Re-sync profile to ensure host_id is valid for RLS
            showLoading("VERIFYING_IDENT...");
            const profile = await syncProfile();
            
            if (!profile || !profile.id) {
                hideLoading();
                return showToast("PROFILE_SYNC_FAILED", true);
            }

            const wager = parseFloat(document.getElementById('wagerInput').value);
            if (isNaN(wager) || wager <= 0) {
                hideLoading();
                return showToast("INVALID_WAGER", true);
            }

            showLoading("PREPARING_SIGNAL...");
            try {
                const { data, error } = await sb.from('matches').insert({
                    host_id: profile.id,
                    wager_amount: wager,
                    status: 'waiting'
                }).select().single();

                if (error) throw error;
                currentMatchId = data.id;
                document.getElementById('hostingStatus').classList.remove('hidden');
                showToast("SIGNAL_DEPLOYED");
                subscribeToMatch(data.id);
            } catch (e) {
                console.error("Deploy Error:", e);
                showToast("DEPLOY_ERR: Check RLS or Balance", true);
            } finally {
                hideLoading();
            }
        }

        async function joinGame(matchId, wager) {
            if (!userWallet) return connect();
            const profile = await syncProfile();
            
            if (!profile || !profile.id) return showToast("PROFILE_SYNC_FAILED", true);

            showLoading("JOINING_ENGAGEMENT...");
            try {
                const { error } = await sb.from('matches').update({
                    opponent_id: profile.id,
                    status: 'in_progress'
                }).eq('id', matchId);

                if (error) throw error;
                
                enterGameView(matchId, wager, 'challenger');
                subscribeToMatch(matchId);
            } catch (e) {
                showToast("ENGAGE_ERR: " + e.message, true);
            } finally { hideLoading(); }
        }

        function enterGameView(matchId, wager, role) {
            currentMatchId = matchId;
            switchView('game');
            document.getElementById('matchPool').innerText = (wager * 2).toFixed(2) + " EROL";
            document.getElementById('gameplayInterface').classList.remove('hidden');
            document.getElementById('resolutionDisplay').classList.add('hidden');
            document.getElementById('lockMoveBtn').disabled = true;
            document.getElementById('moveStatus').innerText = "Select Tactical Gambit";
            selectedMoveIdx = null;
            document.querySelectorAll('.move-card').forEach(c => c.classList.remove('selected', 'locked', 'opacity-50'));
        }

        function selectMove(idx) {
            if (document.getElementById('lockMoveBtn').disabled && selectedMoveIdx !== null) return;
            selectedMoveIdx = idx;
            document.querySelectorAll('.move-card').forEach((c, i) => {
                c.classList.remove('selected');
                if (i + 1 === idx) c.classList.add('selected');
            });
            const names = ["SOLAR_FLARE", "O2_SIPHON", "DUST_STORM"];
            document.getElementById('moveStatus').innerText = `READY: ${names[idx-1]}`;
            document.getElementById('lockMoveBtn').disabled = false;
        }

        async function handleMoveSubmission() {
            if (!userProfile?.id) return showToast("PROFILE_SYNC_REQ", true);
            showLoading("COMMITTING_MOVE...");
            try {
                const match = await getMatch(currentMatchId);
                const roleKey = userProfile.id === match.host_id ? 'host_move' : 'challenger_move';
                
                const { error } = await sb.from('matches').update({ [roleKey]: selectedMoveIdx }).eq('id', currentMatchId);
                if (error) throw error;

                document.getElementById('lockMoveBtn').disabled = true;
                document.querySelectorAll('.move-card').forEach(c => c.classList.add('locked', 'opacity-50'));
                document.getElementById('moveStatus').innerText = "Move Locked. Waiting for Revelation...";
                document.getElementById('moveWaitMsg').classList.remove('hidden');
            } catch (e) {
                showToast("COMMIT_ERR", true);
            } finally { hideLoading(); }
        }

        async function getMatch(id) {
            const { data } = await sb.from('matches').select('*').eq('id', id).single();
            return data;
        }

        function resolveLocal(match) {
            const h = parseInt(match.host_move);
            const c = parseInt(match.challenger_move);
            if (!h || !c) return;

            let result = "DRAW";
            if (h !== c) {
                if ((h === 1 && c === 2) || (h === 2 && c === 3) || (h === 3 && c === 1)) result = "HOST_WINS";
                else result = "CHALLENGER_WINS";
            }

            const iAmHost = userProfile?.id === match.host_id;
            let finalState = "draw";
            if (result === "HOST_WINS") finalState = iAmHost ? "win" : "lose";
            else if (result === "CHALLENGER_WINS") finalState = iAmHost ? "lose" : "win";

            displayResolution(finalState, h, c);
        }

        function displayResolution(state, hMove, cMove) {
            document.getElementById('gameplayInterface').classList.add('hidden');
            const res = document.getElementById('resolutionDisplay');
            const title = document.getElementById('resultTitle');
            const desc = document.getElementById('resultDesc');
            res.classList.remove('hidden');

            const icons = [
                '<i class="fas fa-sun text-2xl text-orange-500"></i>',
                '<i class="fas fa-wind text-2xl text-blue-500"></i>',
                '<i class="fas fa-cloud-showers-heavy text-2xl text-yellow-500"></i>'
            ];

            const iAmHost = userProfile && currentMatchId && (userProfile.id === currentMatchId.host_id);
            
            document.getElementById('myFinalMove').innerHTML = icons[(iAmHost ? hMove : cMove) - 1] || "?";
            document.getElementById('enemyFinalMove').innerHTML = icons[(iAmHost ? cMove : hMove) - 1] || "?";

            if (state === 'win') {
                title.innerText = "VICTORY";
                title.className = "orbitron text-6xl font-black italic uppercase text-green-500";
                desc.innerText = "Pool Captured. Credits Transferred.";
                res.style.borderColor = "#22c55e";
            } else if (state === 'lose') {
                title.innerText = "DEFEAT";
                title.className = "orbitron text-6xl font-black italic uppercase text-red-600";
                desc.innerText = "Liquidity Lost. System Rebooting.";
                res.style.borderColor = "#dc2626";
            } else {
                title.innerText = "STALEMATE";
                title.className = "orbitron text-6xl font-black italic uppercase text-yellow-500";
                desc.innerText = "Equal Strategy. Stakes Returned.";
                res.style.borderColor = "#eab308";
            }
        }

        function switchView(view) {
            ['lobby', 'game', 'leaderboard', 'profile'].forEach(v => {
                document.getElementById('view-' + v).classList.add('hidden');
                document.getElementById('nav-' + v)?.classList.remove('active');
            });
            document.getElementById('view-' + view).classList.remove('hidden');
            document.getElementById('nav-' + view)?.classList.add('active');
            
            if (view === 'leaderboard') fetchLeaderboard();
            if (view === 'profile') fetchErolBalance();
        }

        async function fetchLeaderboard() {
            const { data } = await sb.from('leaderboard').select('*');
            const list = document.getElementById('leaderboardList');
            if (!data) return;
            list.innerHTML = data.map((row, i) => `
                <tr class="border-b border-orange-500/10 hover:bg-orange-500/5 transition-colors">
                    <td class="py-4 px-2 opacity-40">#${i+1}</td>
                    <td class="py-4 px-2 font-bold text-white">${row.username || 'UNKNOWN'}</td>
                    <td class="py-4 px-2 text-orange-500">${row.games_won || 0}</td>
                    <td class="py-4 px-2 text-xs opacity-60">${row.total_erol_gambled || 0} EROL</td>
                </tr>
            `).join('');
        }

        async function refreshLobby() {
            const { data, count } = await sb.from('matches').select('*, profiles!host_id(username)', { count: 'exact' }).eq('status', 'waiting').order('created_at', { ascending: false });
            const grid = document.getElementById('matchGrid');
            document.getElementById('matchCount').innerText = `${count || 0} SIGNALS_FOUND`;
            
            if (!data?.length) {
                grid.innerHTML = `<div class="col-span-full py-20 text-center opacity-20 orbitron text-xs tracking-[0.5em]">No Broadcasts Detected</div>`;
                return;
            }

            grid.innerHTML = data.map(m => `
                <div class="mars-glass p-6 flex flex-col justify-between group hover:border-orange-500 transition-all duration-300">
                    <div class="flex justify-between items-start mb-8">
                        <div>
                            <p class="text-[9px] text-orange-500/40 uppercase orbitron tracking-widest mb-1">Commander</p>
                            <p class="orbitron font-bold text-white text-sm tracking-widest">${(m.profiles?.username || 'PILOT').toUpperCase()}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-[9px] text-orange-500/40 uppercase orbitron tracking-widest mb-1">Stake</p>
                            <p class="orbitron font-bold text-orange-500 text-lg">${m.wager_amount} <span class="text-[10px] opacity-40">EROL</span></p>
                        </div>
                    </div>
                    <button onclick="joinGame('${m.id}', ${m.wager_amount})" class="w-full py-3 bg-orange-500/5 border border-orange-500/20 hover:bg-orange-500 hover:text-black orbitron text-[10px] transition-all uppercase tracking-[0.2em] font-bold">
                        Intercept_Signal
                    </button>
                </div>
            `).join('');
        }

        function setupRealtime() {
            sb.channel('lobby').on('postgres_changes', { event: '*', schema: 'public', table: 'matches' }, () => refreshLobby()).subscribe();
            sb.channel('chat').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'chat_messages' }, p => appendChat(p.new)).subscribe();
            
            sb.from('chat_messages').select('*').order('created_at', { ascending: false }).limit(30).then(({ data }) => {
                if (data) data.reverse().forEach(appendChat);
            });
        }

        function subscribeToMatch(id) {
            sb.channel(`match_${id}`).on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'matches', filter: `id=eq.${id}` }, payload => {
                const match = payload.new;
                if (match.status === 'in_progress' && userProfile?.id === match.host_id && document.getElementById('view-game').classList.contains('hidden')) {
                    enterGameView(match.id, match.wager_amount, 'host');
                }
                if (match.host_move && match.challenger_move) {
                    resolveLocal(match);
                }
            }).subscribe();
        }

        function appendChat(m) {
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = "group border-l border-orange-500/10 pl-3 py-1 mb-1 hover:border-orange-500/40 transition-colors";
            div.innerHTML = `<span class="text-[9px] orbitron text-orange-500/50 uppercase group-hover:text-orange-500">${m.username || 'ANON'}</span><br><span class="opacity-80">${m.message}</span>`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        async function sendChat() {
            const input = document.getElementById('chatInput');
            if (!input.value || !userProfile) return;
            const msg = input.value;
            input.value = "";
            await sb.from('chat_messages').insert({ 
                user_id: userProfile?.id, 
                username: userProfile?.username || 'PILOT', 
                message: msg 
            });
        }

        function updateNavUI() {
            if (!userWallet) return;
            document.getElementById('walletDisplay').classList.remove('hidden');
            document.getElementById('navAddr').innerText = `${userWallet.slice(0, 6)}...${userWallet.slice(-4)}`;
            document.getElementById('connectBtn').classList.add('hidden');
        }

        function updateProfileUI() {
            if (!userProfile) return;
            document.getElementById('editUsername').value = userProfile.username || '';
            document.getElementById('profWins').innerText = userProfile.games_won || 0;
            document.getElementById('profAddress').innerText = userWallet || 'NOT_CONNECTED';
        }

        async function updateProfile() {
            if (!userProfile?.id) return showToast("SYNC_REQUIRED", true);
            const newName = document.getElementById('editUsername').value.trim();
            if (newName.length < 3) return showToast("NAME_TOO_SHORT", true);
            showLoading("SYNCING_PROFILE...");
            const { error } = await sb.from('profiles').update({ username: newName }).eq('id', userProfile.id);
            if (error) showToast("SYNC_FAILED: " + error.message, true);
            else {
                userProfile.username = newName;
                showToast("PROFILE_UPDATED");
            }
            hideLoading();
        }

        function showLoading(text) {
            document.getElementById('loadingText').innerText = text;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }
        function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }
        
        function showToast(msg, isErr = false) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.className = `fixed bottom-10 right-10 px-8 py-4 border-l-4 font-bold text-xs uppercase orbitron z-[250] bg-black/95 backdrop-blur-xl shadow-2xl ${isErr ? 'border-red-600 text-red-500' : 'border-orange-500 text-orange-500'}`;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 5000);
        }

        document.getElementById('connectBtn').addEventListener('click', connect);
        document.getElementById('sendChat').addEventListener('click', sendChat);
        document.getElementById('chatInput').addEventListener('keypress', e => e.key === 'Enter' && sendChat());

        init();
    </script>
</body>
</html>
