<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Chain Gambit | Mission Control</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #ff4d00;
            --habitat-bg: #060608;
            --panel-bg: rgba(20, 20, 25, 0.95);
            --glow: rgba(255, 77, 0, 0.3);
        }

        body {
            background-color: var(--habitat-bg);
            color: #e0e0e0;
            font-family: 'Share Tech Mono', monospace;
            background-image: 
                linear-gradient(rgba(255, 77, 0, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 77, 0, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
            margin: 0;
        }

        body.grotto-theme {
            --primary-color: #9333ea;
            --glow: rgba(147, 51, 234, 0.3);
            background-image: 
                linear-gradient(rgba(147, 51, 234, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(147, 51, 234, 0.03) 1px, transparent 1px);
        }

        .orbitron { font-family: 'Orbitron', sans-serif; }
        
        .mars-glass {
            background: var(--panel-bg);
            border: 1px solid rgba(255, 77, 0, 0.2);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        body.grotto-theme .mars-glass {
            border: 1px solid rgba(147, 51, 234, 0.2);
        }

        .mars-border-glow {
            border: 1px solid var(--primary-color);
            box-shadow: 0 0 10px var(--glow);
        }

        .btn-mars {
            background: var(--primary-color);
            color: black;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.2s;
            clip-path: polygon(10% 0, 100% 0, 90% 100%, 0 100%);
        }

        .btn-mars:hover:not(:disabled) {
            filter: brightness(1.2);
            box-shadow: 0 0 15px var(--glow);
            transform: scale(1.02);
        }

        .btn-mars:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .move-select {
            border: 1px solid #333;
            filter: grayscale(1);
            transition: all 0.3s;
        }

        .move-select.selected {
            border-color: var(--primary-color);
            filter: grayscale(0);
            background: var(--glow);
            box-shadow: inset 0 0 10px var(--glow);
        }

        .scanline {
            width: 100%;
            height: 2px;
            background: var(--glow);
            position: fixed;
            top: 0;
            z-index: 100;
            pointer-events: none;
            animation: scan 4s linear infinite;
        }

        @keyframes scan {
            from { top: 0; }
            to { top: 100%; }
        }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: var(--habitat-bg); }
        ::-webkit-scrollbar-thumb { background: var(--primary-color); }

        .tab-btn {
            color: #666;
            background: transparent;
        }

        .tab-btn:hover {
            color: var(--primary-color);
        }

        .tab-btn.active {
            color: var(--primary-color);
            background: var(--glow);
            border-bottom: 2px solid var(--primary-color);
        }

        .lobby-filter {
            color: #666;
            background: transparent;
        }

        .lobby-filter:hover {
            color: var(--primary-color);
        }

        .lobby-filter.active {
            color: var(--primary-color);
            background: var(--glow);
        }

        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        .copy-btn {
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }

        .header-banner {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-bottom: 2px solid var(--primary-color);
        }

        .game-logo {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px;
        }

        .chat-messages {
            height: 400px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .activity-feed {
            height: 500px;
            overflow-y: auto;
        }

        .chain-switch-btn {
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 11px;
            text-transform: uppercase;
        }

        .chain-switch-btn:hover {
            background: var(--glow);
            transform: scale(1.05);
        }

        .chain-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary-color);
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @media (max-width: 768px) {
            .header-banner {
                height: 120px;
            }
            .game-logo {
                width: 45px;
                height: 45px;
            }
            .chat-messages {
                height: 300px;
            }
        }
    </style>
</head>
<body class="min-h-screen p-4">
    <div class="scanline"></div>

    <!-- Header Banner -->
    <div class="max-w-7xl mx-auto mb-4">
        <img src="https://raw.githubusercontent.com/precidoboss/my-game-sprites/main/photo_2026-02-01_14-21-55.jpg" 
             alt="Multi-Chain Gambit Header" 
             class="header-banner"
             onerror="this.style.display='none'">
    </div>

    <nav class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center mb-8 py-4 border-b border-orange-900/30">
        <div class="flex items-center gap-4">
            <img src="https://raw.githubusercontent.com/precidoboss/my-game-sprites/main/photo_2026-02-01_14-13-33.jpg" 
                 alt="Gambit Logo" 
                 class="game-logo"
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="w-12 h-12 mars-border-glow hidden items-center justify-center bg-black">
                <span class="text-2xl font-bold" id="logo-letter">M</span>
            </div>
            <div>
                <h1 class="orbitron text-2xl font-bold tracking-widest" id="game-title" style="color: var(--primary-color)">MARTIAN GAMBIT</h1>
                <p class="text-[10px] uppercase tracking-[0.2em]" id="game-subtitle" style="color: var(--primary-color); opacity: 0.5;">Sector 2027 // EROL Protocol</p>
            </div>
        </div>

        <div class="flex items-center gap-6 mt-4 md:mt-0 flex-wrap">
            <!-- Chain Switcher -->
            <div class="flex gap-2">
                <button onclick="switchToMartian()" id="chain-martian" class="chain-switch-btn">
                    <span class="chain-indicator"></span>Martian
                </button>
                <button onclick="switchToGrotto()" id="chain-grotto" class="chain-switch-btn" style="opacity: 0.5;">
                    <span class="chain-indicator" style="background: #9333ea;"></span>Grotto
                </button>
            </div>

            <!-- Navigation Tabs -->
            <div class="flex gap-1 bg-black/40 p-1 border flex-wrap" style="border-color: var(--primary-color); opacity: 0.3;">
                <button onclick="switchTab('lobby')" id="tab-lobby" class="tab-btn active px-4 py-2 text-[10px] uppercase transition">Lobby</button>
                <button onclick="switchTab('leaderboard')" id="tab-leaderboard" class="tab-btn px-4 py-2 text-[10px] uppercase transition">Leaderboard</button>
                <button onclick="switchTab('profile')" id="tab-profile" class="tab-btn px-4 py-2 text-[10px] uppercase transition">Profile</button>
                <button onclick="switchTab('bridge')" id="tab-bridge" class="tab-btn px-4 py-2 text-[10px] uppercase transition">Bridge</button>
                <button onclick="switchTab('howto')" id="tab-howto" class="tab-btn px-4 py-2 text-[10px] uppercase transition">How to Play</button>
            </div>

            <div id="connection-interface">
                <button id="connect-btn" class="btn-mars px-8 py-2">Initialize Uplink</button>
                <div id="account-info" class="hidden flex items-center gap-3">
                    <div class="text-right">
                        <div class="flex items-center gap-2">
                            <span id="user-address" class="text-[10px] opacity-70" style="color: var(--primary-color)"></span>
                            <button id="copy-address" class="copy-btn text-xs" onclick="copyAddress()" title="Copy Address" style="color: var(--primary-color)">
                                üìã
                            </button>
                        </div>
                        <div id="user-balance" class="orbitron font-bold text-sm" style="color: var(--primary-color)">0.00 $EROL</div>
                    </div>
                    <div class="h-10 w-1" style="background: var(--primary-color)"></div>
                </div>
            </div>
        </div>
    </nav>
<main class="max-w-7xl mx-auto">
        <!-- LOBBY PAGE -->
        <div id="page-lobby" class="page-section active">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <aside class="lg:col-span-4 space-y-6">
                    <div class="mars-glass p-6">
                        <h2 class="orbitron text-sm mb-6 flex items-center gap-2" style="color: var(--primary-color)">
                            <span class="w-2 h-2 animate-pulse" style="background: var(--primary-color)"></span>
                            COMMENCE SIGNAL DEPLOYMENT
                        </h2>

                        <div class="grid grid-cols-3 gap-3 mb-6">
                            <button onclick="selectMove(1)" id="move-1" class="move-select p-4 bg-black flex flex-col items-center">
                                <span class="text-3xl mb-2">‚òÄÔ∏è</span>
                                <span class="text-[9px] uppercase">Solar</span>
                            </button>
                            <button onclick="selectMove(2)" id="move-2" class="move-select p-4 bg-black flex flex-col items-center">
                                <span class="text-3xl mb-2">üå¨Ô∏è</span>
                                <span class="text-[9px] uppercase">Oxygen</span>
                            </button>
                            <button onclick="selectMove(3)" id="move-3" class="move-select p-4 bg-black flex flex-col items-center">
                                <span class="text-3xl mb-2">üå™Ô∏è</span>
                                <span class="text-[9px] uppercase">Dust</span>
                            </button>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="text-[10px] uppercase mb-2 block" id="wager-label" style="color: var(--primary-color); opacity: 0.5;">Energy Stake ($EROL)</label>
                                <input id="wager-amount" type="number" step="0.1" value="1.0" class="w-full bg-black border p-3 focus:outline-none orbitron" style="color: var(--primary-color); border-color: rgba(255, 77, 0, 0.5);">
                            </div>
                            <div>
                                <label class="text-[10px] uppercase mb-2 block" style="color: var(--primary-color); opacity: 0.5;">Interception Timeout</label>
                                <select id="timeout-select" class="w-full bg-black border p-3 focus:outline-none orbitron text-sm" style="color: var(--primary-color); border-color: rgba(255, 77, 0, 0.5);">
                                    <option value="300">5 Minutes</option>
                                    <option value="600">10 Minutes</option>
                                    <option value="900" selected>15 Minutes</option>
                                </select>
                            </div>
                            <button id="create-btn" onclick="handleCreateGame()" class="btn-mars w-full py-4 text-lg">Deploy Signal</button>
                            <button onclick="debugInfo()" class="w-full py-2 text-[9px] border uppercase hover:brightness-110" style="border-color: rgba(255, 77, 0, 0.3); color: var(--primary-color); opacity: 0.7;">Debug Info</button>
                        </div>
                    </div>

                    <!-- Global Chat -->
                    <div class="mars-glass p-6">
                        <h2 class="orbitron text-sm mb-4 flex items-center gap-2" style="color: var(--primary-color)">
                            <span class="w-2 h-2 animate-pulse" style="background: var(--primary-color)"></span>
                            GLOBAL COMMS
                        </h2>
                        <div id="chat-messages" class="chat-messages mb-4 bg-black/40 border p-3 space-y-2" style="border-color: rgba(255, 77, 0, 0.3);"></div>
                        <div class="flex gap-2">
                            <input id="chat-input" type="text" placeholder="Type message..." maxlength="200" class="flex-1 bg-black border p-2 text-sm focus:outline-none" style="color: var(--primary-color); border-color: rgba(255, 77, 0, 0.5);" onkeypress="if(event.key==='Enter') sendMessage()">
                            <button onclick="sendMessage()" class="btn-mars px-4 py-2 text-xs">Send</button>
                        </div>
                    </div>
                </aside>

                <section class="lg:col-span-8 space-y-6">
                    <!-- Game Lobby -->
                    <div class="mars-glass p-6 min-h-[500px] relative overflow-hidden">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 border-b pb-4 gap-4" style="border-color: rgba(255, 77, 0, 0.2);">
                            <h2 class="orbitron text-lg text-white tracking-widest flex items-center gap-3">
                                LOBBY_FREQUENCIES
                                <span class="text-[10px] px-2 py-1" style="background: rgba(255, 77, 0, 0.3); color: var(--primary-color);">FAST INDEX</span>
                            </h2>
                            
                            <div class="flex items-center gap-2 flex-wrap">
                                <div class="flex gap-1 bg-black/40 p-1 border" style="border-color: rgba(255, 77, 0, 0.3);">
                                    <button onclick="setLobbyFilter('all')" id="filter-all" class="lobby-filter active px-3 py-1 text-[9px] uppercase transition">All</button>
                                    <button onclick="setLobbyFilter('open')" id="filter-open" class="lobby-filter px-3 py-1 text-[9px] uppercase transition">Open</button>
                                    <button onclick="setLobbyFilter('intercepted')" id="filter-intercepted" class="lobby-filter px-3 py-1 text-[9px] uppercase transition">Intercepted</button>
                                    <button onclick="setLobbyFilter('resolved')" id="filter-resolved" class="lobby-filter px-3 py-1 text-[9px] uppercase transition">Resolved</button>
                                </div>
                                
                                <button onclick="refreshLobby()" class="text-[10px] hover:text-white border px-3 py-1 uppercase transition" style="color: var(--primary-color); border-color: rgba(255, 77, 0, 0.3);">Sync Data</button>
                            </div>
                        </div>
                        <div id="lobby-list" class="space-y-4"></div>
                    </div>

                    <!-- Live Activity Feed -->
                    <div class="mars-glass p-6">
                        <h2 class="orbitron text-lg text-white tracking-widest mb-6 flex items-center gap-3">
                            LIVE ACTIVITY FEED
                            <span class="w-2 h-2 bg-green-500 animate-pulse"></span>
                        </h2>
                        <div id="activity-feed" class="activity-feed space-y-2"></div>
                    </div>
                </section>
            </div>
        </div>

        <!-- LEADERBOARD PAGE -->
        <div id="page-leaderboard" class="page-section">
            <div class="mars-glass p-8">
                <h2 class="orbitron text-2xl mb-8 flex items-center gap-3" style="color: var(--primary-color)">
                    <span class="w-3 h-3 animate-pulse" style="background: var(--primary-color)"></span>
                    PILOT RANKINGS
                </h2>

                <!-- Global Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-black/40 border p-4 text-center" style="border-color: rgba(255, 77, 0, 0.3);">
                        <div class="text-[10px] uppercase mb-2" style="color: var(--primary-color); opacity: 0.5;">Total Wagered</div>
                        <div id="global-wagered" class="orbitron text-2xl" style="color: var(--primary-color)">--</div>
                    </div>
                    <div class="bg-black/40 border border-red-900/30 p-4 text-center">
                        <div class="text-[10px] text-red-800 uppercase mb-2">Burnt</div>
                        <div id="global-burnt" class="orbitron text-2xl text-red-500">--</div>
                    </div>
                    <div class="bg-black/40 border border-blue-900/30 p-4 text-center">
                        <div class="text-[10px] text-blue-800 uppercase mb-2">Treasury</div>
                        <div id="global-treasury" class="orbitron text-2xl text-blue-500">--</div>
                    </div>
                    <div class="bg-black/40 border border-green-900/30 p-4 text-center">
                        <div class="text-[10px] text-green-800 uppercase mb-2">Games Played</div>
                        <div id="global-games" class="orbitron text-2xl text-green-500">--</div>
                    </div>
                </div>

                <!-- Leaderboard Table -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b" style="border-color: rgba(255, 77, 0, 0.3);">
                                <th class="text-left p-3 text-[10px] uppercase" style="color: var(--primary-color); opacity: 0.5;">Rank</th>
                                <th class="text-left p-3 text-[10px] uppercase" style="color: var(--primary-color); opacity: 0.5;">Pilot</th>
                                <th class="text-right p-3 text-[10px] uppercase" style="color: var(--primary-color); opacity: 0.5;">Wagered</th>
                                <th class="text-right p-3 text-[10px] uppercase" style="color: var(--primary-color); opacity: 0.5;">Win Rate</th>
                                <th class="text-right p-3 text-[10px] uppercase" style="color: var(--primary-color); opacity: 0.5;">Biggest Pot</th>
                                <th class="text-right p-3 text-[10px] uppercase" style="color: var(--primary-color); opacity: 0.5;">Win Streak</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PROFILE PAGE -->
        <div id="page-profile" class="page-section">
            <div class="mars-glass p-8 max-w-5xl mx-auto">
                <h2 class="orbitron text-2xl mb-8 flex items-center gap-3" style="color: var(--primary-color)">
                    <span class="w-3 h-3 animate-pulse" style="background: var(--primary-color)"></span>
                    PILOT STATISTICS
                </h2>
                <div id="profile-content" class="space-y-6"></div>
            </div>
        </div>
<!-- HOW TO PLAY PAGE -->
        <div id="page-howto" class="page-section">
            <div class="mars-glass p-8 max-w-4xl mx-auto">
                <h2 class="orbitron text-2xl mb-8" style="color: var(--primary-color)">MISSION BRIEFING</h2>
                
                <div class="space-y-8 text-gray-300">
                    <section>
                        <h3 class="orbitron text-lg mb-3" style="color: var(--primary-color)">üéØ OBJECTIVE</h3>
                        <p class="leading-relaxed">Multi-Chain Gambit is a high-stakes Rock-Paper-Scissors style game on Martian Chain & The Grotto. Players bet native tokens and compete using three strategic moves. The winner takes the pot (minus a small fee).</p>
                    </section>

                    <section>
                        <h3 class="orbitron text-lg mb-3" style="color: var(--primary-color)">‚öîÔ∏è THE THREE MOVES</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-black/40 p-4 border" style="border-color: rgba(255, 77, 0, 0.3);">
                                <div class="text-4xl mb-2">‚òÄÔ∏è</div>
                                <div class="orbitron mb-1" style="color: var(--primary-color)">SOLAR FLARE</div>
                                <div class="text-[11px] text-gray-400">Beats Oxygen Siphon</div>
                            </div>
                            <div class="bg-black/40 p-4 border" style="border-color: rgba(255, 77, 0, 0.3);">
                                <div class="text-4xl mb-2">üå¨Ô∏è</div>
                                <div class="orbitron mb-1" style="color: var(--primary-color)">OXYGEN SIPHON</div>
                                <div class="text-[11px] text-gray-400">Beats Dust Storm</div>
                            </div>
                            <div class="bg-black/40 p-4 border" style="border-color: rgba(255, 77, 0, 0.3);">
                                <div class="text-4xl mb-2">üå™Ô∏è</div>
                                <div class="orbitron mb-1" style="color: var(--primary-color)">DUST STORM</div>
                                <div class="text-[11px] text-gray-400">Beats Solar Flare</div>
                            </div>
                        </div>
                    </section>

                    <section>
                        <h3 class="orbitron text-lg mb-3" style="color: var(--primary-color)">üìã HOW TO PLAY</h3>
                        <div class="space-y-4">
                            <div class="flex gap-4">
                                <div class="orbitron text-xl" style="color: var(--primary-color)">1.</div>
                                <div>
                                    <div class="font-bold text-white mb-1">Deploy Signal (Host)</div>
                                    <p class="text-sm text-gray-400">Select your move, wager amount, and timeout. Your move is encrypted and stored locally. Click "Deploy Signal" to create the game.</p>
                                </div>
                            </div>
                            <div class="flex gap-4">
                                <div class="orbitron text-xl" style="color: var(--primary-color)">2.</div>
                                <div>
                                    <div class="font-bold text-white mb-1">Intercept (Challenger)</div>
                                    <p class="text-sm text-gray-400">Find an open game in the lobby and click "Intercept". Choose your move and match the wager amount.</p>
                                </div>
                            </div>
                            <div class="flex gap-4">
                                <div class="orbitron text-xl" style="color: var(--primary-color)">3.</div>
                                <div>
                                    <div class="font-bold text-white mb-1">Broadcast Reveal (Host)</div>
                                    <p class="text-sm text-gray-400">Once intercepted, click "Broadcast Reveal" to reveal your move. The smart contract determines the winner automatically.</p>
                                </div>
                            </div>
                            <div class="flex gap-4">
                                <div class="orbitron text-xl" style="color: var(--primary-color)">4.</div>
                                <div>
                                    <div class="font-bold text-white mb-1">Victory or Defeat</div>
                                    <p class="text-sm text-gray-400">Winner takes 97% of the pot. 1.5% goes to treasury, 1.5% is burned. In case of a draw, both players get their wager back minus fees.</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section>
                        <h3 class="orbitron text-lg mb-3" style="color: var(--primary-color)">‚ö†Ô∏è IMPORTANT NOTES</h3>
                        <ul class="space-y-2 text-sm text-gray-400">
                            <li class="flex gap-2"><span style="color: var(--primary-color)">‚Üí</span> You must use the same browser/device to reveal your move (secret is stored locally)</li>
                            <li class="flex gap-2"><span style="color: var(--primary-color)">‚Üí</span> If host doesn't reveal within the timeout, challenger can force forfeit to claim victory</li>
                            <li class="flex gap-2"><span style="color: var(--primary-color)">‚Üí</span> If no one intercepts within the timeout, host can retract their wager</li>
                            <li class="flex gap-2"><span style="color: var(--primary-color)">‚Üí</span> All games are on-chain and provably fair via cryptographic commitments</li>
                            <li class="flex gap-2"><span style="color: var(--primary-color)">‚Üí</span> Switch between Martian Chain ($EROL) and The Grotto ($HERESY) anytime</li>
                        </ul>
                    </section>

                    <section class="bg-black/20 border p-6" style="border-color: rgba(255, 77, 0, 0.3);">
                        <h3 class="orbitron text-lg mb-3" style="color: var(--primary-color)">üí∞ FEES & PAYOUTS</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between"><span>Winner Payout:</span><span style="color: var(--primary-color)">97% of pot</span></div>
                            <div class="flex justify-between"><span>Treasury Fee:</span><span style="color: var(--primary-color)">1.5%</span></div>
                            <div class="flex justify-between"><span>Burn Amount:</span><span style="color: var(--primary-color)">1.5%</span></div>
                            <div class="flex justify-between"><span>Draw (each player):</span><span style="color: var(--primary-color)">Wager - 3%</span></div>
                        </div>
                    </section>
                </div>
            </div>
        </div>

        <!-- BRIDGE PAGE -->
        <div id="page-bridge" class="page-section">
            <div class="mars-glass p-8 max-w-3xl mx-auto">
                <h2 class="orbitron text-2xl mb-2 flex items-center gap-3" style="color: var(--primary-color)">
                    <span class="w-3 h-3 animate-pulse" style="background: var(--primary-color)"></span>
                    CROSS-CHAIN BRIDGE
                </h2>
                <p class="text-gray-500 text-sm mb-8">Transfer $EROL from Avalanche C-Chain to Martian Chain (1:1 ratio)</p>
                
                <div id="bridge-content" class="space-y-6">
                    <!-- Bridge Interface -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <!-- From Chain -->
                        <div class="bg-black/40 border p-6" style="border-color: rgba(255, 77, 0, 0.3);">
                            <div class="text-[10px] uppercase mb-3" style="color: var(--primary-color); opacity: 0.5;">From</div>
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-10 h-10 bg-red-600 rounded-full flex items-center justify-center text-white font-bold">
                                    A
                                </div>
                                <div>
                                    <div class="orbitron text-white">Avalanche C-Chain</div>
                                    <div class="text-[10px] text-gray-500">Chain ID: 43114</div>
                                </div>
                            </div>
                            <div>
                                <label class="text-[10px] text-gray-500 uppercase mb-2 block">Available Balance</label>
                                <div id="avax-erol-balance" class="orbitron text-lg" style="color: var(--primary-color)">-- $EROL</div>
                            </div>
                        </div>
                        
                        <!-- To Chain -->
                        <div class="bg-black/40 border p-6" style="border-color: rgba(255, 77, 0, 0.3);">
                            <div class="text-[10px] uppercase mb-3" style="color: var(--primary-color); opacity: 0.5;">To</div>
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold" style="background: var(--primary-color)">
                                    M
                                </div>
                                <div>
                                    <div class="orbitron text-white">Martian Chain</div>
                                    <div class="text-[10px] text-gray-500">Chain ID: 2027</div>
                                </div>
                            </div>
                            <div>
                                <label class="text-[10px] text-gray-500 uppercase mb-2 block">You'll Receive</label>
                                <div id="martian-erol-receive" class="orbitron text-lg" style="color: var(--primary-color)">-- $EROL</div>
                            </div>
                        </div>
                    </div>

                    <!-- Amount Input -->
                    <div>
                        <label class="text-[10px] uppercase mb-2 block" style="color: var(--primary-color); opacity: 0.5;">Amount to Bridge</label>
                        <div class="relative">
                            <input 
                                id="bridge-amount" 
                                type="number" 
                                step="0.01" 
                                min="1"
                                placeholder="0.0"
                                class="w-full bg-black border p-4 pr-20 focus:outline-none orbitron text-xl"
                                style="color: var(--primary-color); border-color: rgba(255, 77, 0, 0.5);"
                                oninput="updateBridgeEstimate()"
                            >
                            <button 
                                onclick="setMaxBridge()" 
                                class="absolute right-3 top-1/2 -translate-y-1/2 text-[10px] px-3 py-1 border uppercase transition hover:brightness-110"
                                style="border-color: rgba(255, 77, 0, 0.5); color: var(--primary-color);"
                            >
                                Max
                            </button>
                        </div>
                    </div>

                    <!-- Bridge Info -->
                    <div class="bg-black/20 border p-4 space-y-2 text-sm" style="border-color: rgba(255, 77, 0, 0.3);">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Exchange Rate:</span>
                            <span style="color: var(--primary-color)">1 $EROL = 1 $EROL</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Bridge Fee:</span>
                            <span style="color: var(--primary-color)">0 $EROL (gas only)</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Min Amount:</span>
                            <span style="color: var(--primary-color)">1 $EROL</span>
                        </div>
                    </div>

                    <!-- Bridge Button -->
                    <button 
                        id="bridge-btn" 
                        onclick="handleBridge()" 
                        class="btn-mars w-full py-4 text-lg disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                    >
                        Initialize Bridge Transfer
                    </button>

                    <!-- Bridge Status -->
                    <div id="bridge-status" class="hidden bg-black/40 border p-4" style="border-color: rgba(255, 77, 0, 0.3);">
                        <div class="flex items-center gap-3">
                            <div class="w-6 h-6 border-2 border-t-transparent rounded-full animate-spin" style="border-color: var(--primary-color); border-top-color: transparent;"></div>
                            <div>
                                <div class="font-bold" style="color: var(--primary-color)">Processing Bridge Transaction</div>
                                <div class="text-[11px] text-gray-500" id="bridge-status-text">Initiating transfer...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Player Profile Modal -->
    <div id="player-modal" class="modal">
        <div class="modal-content mars-glass p-8 w-full">
            <div class="flex justify-between items-center mb-6">
                <h2 class="orbitron text-xl" style="color: var(--primary-color)">PILOT PROFILE</h2>
                <button onclick="closePlayerModal()" class="text-2xl text-gray-500 hover:brightness-150" style="color: var(--primary-color)">&times;</button>
            </div>
            <div id="player-modal-content"></div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 mars-glass px-8 py-4 orbitron text-sm transform translate-y-32 transition-all duration-300 z-[200]" style="border: 1px solid var(--primary-color); color: var(--primary-color)">
        SYSTEM MESSAGE
    </div>
<script>
        // Multi-Chain Configuration
        const CHAINS = {
            martian: {
                chainId: "0x7EB",
                name: "Martian Chain",
                rpc: "https://martian-rpc1.amichain.org/",
                contract: "0x395E368045315062b26AC950690f384c98fDEEe2",
                currency: { name: "EROL", symbol: "EROL", decimals: 18 },
                explorer: "https://explorer.martian.com",
                color: "#ff4d00",
                theme: "martian",
                title: "MARTIAN GAMBIT",
                subtitle: "Sector 2027 // EROL Protocol",
                logo: "M"
            },
            grotto: {
                chainId: "0x8E6F",
                name: "The Grotto",
                rpc: "https://subnets.avax.network/thegrotto/mainnet/rpc",
                contract: "0x62cF10284C9b4a5B3b68B2cCBB1EBaec3f86320c",
                currency: { name: "HERESY", symbol: "HERESY", decimals: 18 },
                explorer: "https://subnets.avax.network/thegrotto",
                color: "#9333ea",
                theme: "grotto",
                title: "GROTTO GAMBIT",
                subtitle: "Dark Realm // HERESY Protocol",
                logo: "G"
            }
        };

        let currentChain = 'martian';
        let CHAIN_ID, RPC_URL, CONTRACT_ADDR, CURRENCY_SYMBOL;
        
        // Supabase Configuration
        const SB_URL = "https://tvckbtgggsuwxtlgilcl.supabase.co"; 
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2Y2tidGdnZ3N1d3h0bGdpbGNsIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MDY2NDY0NSwiZXhwIjoyMDg2MjQwNjQ1fQ.DhvGNo3seKoRtDmeRod0gAP48yFZw_0-kAvY3eT_554"; 
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        // Bridge Configuration
        const BRIDGE_CONTRACT_ADDR = "0x87260775905e83689958a1491bc0c47396b2b21c";
        const EROL_TOKEN_ADDR = "0xCaC4904E1DB1589Aa17A2Ec742F5a6bCF4c4D037";
        const AVAX_CHAIN_ID = "0xa86a";

        const ERC20_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)"
        ];

        const BRIDGE_ABI = [
            "function bridgeToMartian(uint256 amount) external",
            "event BridgeInitiated(address indexed sender, uint256 amount, uint256 timestamp)"
        ];

        const ABI = [
            "function createGame(bytes32 _hash, uint256 _timeout) external payable",
            "function challengeGame(uint256 _gameId, uint8 _move) external payable",
            "function resolveGame(uint256 _gameId, uint8 _move, string calldata _salt) external",
            "function forceForfeit(uint256 _gameId) external",
            "function refundUnchallenged(uint256 _gameId) external",
            "function gameCounter() public view returns (uint256)",
            "function games(uint256) public view returns (address host, address challenger, bytes32 commitHash, uint8 hostMove, uint8 challengerMove, uint256 wager, uint256 timeout, uint256 timestamp, uint8 status)",
            "function getTimeRemaining(uint256 _gameId) external view returns (uint256)",
            "function canForfeit(uint256 _gameId) external view returns (bool)",
            "function canRefund(uint256 _gameId) external view returns (bool)",
            "event GameCreated(uint256 indexed gameId, address indexed host, uint256 wager, uint256 timeout, bytes32 commitHash)",
            "event GameChallenged(uint256 indexed gameId, address indexed challenger)",
            "event GameResolved(uint256 indexed gameId, address winner, uint256 payout)"
        ];

        let provider, signer, contract, userAddress;
        let selectedMoveIdx = 0;
        let avaxProvider, avaxErolBalance = 0;
        let lobbyRefreshInterval, activityRefreshInterval, chatRefreshInterval;
        let currentLobbyFilter = 'all';

        function setChainConfig(chain) {
            currentChain = chain;
            const config = CHAINS[chain];
            CHAIN_ID = config.chainId;
            RPC_URL = config.rpc;
            CONTRACT_ADDR = config.contract;
            CURRENCY_SYMBOL = config.currency.symbol;

            // Update CSS variables
            document.documentElement.style.setProperty('--primary-color', config.color);
            
            // Update theme
            if (chain === 'grotto') {
                document.body.classList.add('grotto-theme');
            } else {
                document.body.classList.remove('grotto-theme');
            }

            // Update UI text
            document.getElementById('game-title').textContent = config.title;
            document.getElementById('game-subtitle').textContent = config.subtitle;
            document.getElementById('logo-letter').textContent = config.logo;
            document.getElementById('wager-label').textContent = `Energy Stake ($${CURRENCY_SYMBOL})`;
            
            // Update balance display
            if (userAddress) {
                updateBalance();
            }
        }

        async function switchToMartian() {
            setChainConfig('martian');
            document.getElementById('chain-martian').style.opacity = '1';
            document.getElementById('chain-grotto').style.opacity = '0.5';
            
            if (userAddress) {
                await checkNetwork();
                await refreshLobby();
            }
        }

        async function switchToGrotto() {
            setChainConfig('grotto');
            document.getElementById('chain-grotto').style.opacity = '1';
            document.getElementById('chain-martian').style.opacity = '0.5';
            
            if (userAddress) {
                await checkNetwork();
                await refreshLobby();
            }
        }

        async function init() {
            setChainConfig('martian'); // Default to Martian
            
            if (window.ethereum) {
                provider = new ethers.BrowserProvider(window.ethereum);
                document.getElementById('connect-btn').addEventListener('click', connectWallet);
                
                await refreshLobby();
                await refreshActivityFeed();
                await refreshChat();
                
                lobbyRefreshInterval = setInterval(refreshLobby, 10000);
                activityRefreshInterval = setInterval(refreshActivityFeed, 5000);
                chatRefreshInterval = setInterval(refreshChat, 3000);
                
                _supabase.channel('game_updates')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'games' }, () => {
                        refreshLobby();
                        refreshActivityFeed();
                    })
                    .subscribe();

                _supabase.channel('chat_updates')
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'chat_messages' }, () => {
                        refreshChat();
                    })
                    .subscribe();

                window.ethereum.on('accountsChanged', () => window.location.reload());
                window.ethereum.on('chainChanged', () => window.location.reload());
            }
        }

        async function checkNetwork() {
            const network = await provider.getNetwork();
            const currentChainIdHex = "0x" + network.chainId.toString(16).toUpperCase();
            
            if (currentChainIdHex !== CHAIN_ID.toUpperCase()) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: CHAIN_ID }],
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        const config = CHAINS[currentChain];
                        try {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: CHAIN_ID,
                                    chainName: config.name,
                                    nativeCurrency: config.currency,
                                    rpcUrls: [RPC_URL],
                                    blockExplorerUrls: [config.explorer]
                                }]
                            });
                        } catch (addError) {
                            showToast("FAILED TO ADD NETWORK");
                            return false;
                        }
                    } else {
                        showToast("SWITCH TO " + CHAINS[currentChain].name.toUpperCase());
                        return false;
                    }
                }
            }
            return true;
        }

        async function connectWallet() {
            try {
                const accounts = await provider.send("eth_requestAccounts", []);
                userAddress = accounts[0];
                signer = await provider.getSigner();
                
                if (!(await checkNetwork())) return;

                contract = new ethers.Contract(CONTRACT_ADDR, ABI, signer);
                document.getElementById('connect-btn').classList.add('hidden');
                document.getElementById('account-info').classList.remove('hidden');
                
                const shortened = userAddress.slice(0, 6) + '...' + userAddress.slice(-4);
                document.getElementById('user-address').innerText = shortened;
                
                updateBalance();
                refreshLobby();
            } catch (err) { 
                console.error(err);
                showToast("UPLINK FAILED"); 
            }
        }

        function copyAddress() {
            if (userAddress) {
                navigator.clipboard.writeText(userAddress).then(() => {
                    showToast("ADDRESS COPIED");
                }).catch(err => {
                    console.error('Copy failed:', err);
                    showToast("COPY FAILED");
                });
            }
        }

        async function updateBalance() {
            if (!userAddress || !provider) return;
            try {
                const balance = await provider.getBalance(userAddress);
                document.getElementById('user-balance').innerText = `${parseFloat(ethers.formatEther(balance)).toFixed(2)} $${CURRENCY_SYMBOL}`;
            } catch (e) { console.error("Balance fetch error", e); }
        }

        function selectMove(idx) {
            selectedMoveIdx = idx;
            document.querySelectorAll('.move-select').forEach(btn => btn.classList.remove('selected'));
            document.getElementById(`move-${idx}`).classList.add('selected');
        }

        async function handleCreateGame() {
            if (!signer) return showToast("CONNECT UPLINK FIRST");
            if (selectedMoveIdx === 0) return showToast("SELECT TACTICAL MOVE");
            if (!(await checkNetwork())) return;
            
            const createBtn = document.getElementById('create-btn');
            createBtn.disabled = true;
            
            const wagerInput = document.getElementById('wager-amount').value;
            const wagerValue = ethers.parseEther(wagerInput);
            const timeoutValue = document.getElementById('timeout-select').value;
            const salt = ethers.hexlify(ethers.randomBytes(32));
            
            try {
                const nextGameId = (await contract.gameCounter()) + BigInt(1);
                
                const encoded = ethers.AbiCoder.defaultAbiCoder().encode(
                    ["uint8", "string", "address", "uint256"],
                    [selectedMoveIdx, salt, userAddress, nextGameId]
                );
                const hash = ethers.keccak256(encoded);

                console.log("=== CREATING GAME ===");
                console.log("Chain:", currentChain);
                console.log("Move:", selectedMoveIdx);
                console.log("Game ID:", nextGameId.toString());

                showToast("ENCRYPTING SIGNAL...");
                const tx = await contract.createGame(hash, timeoutValue, { value: wagerValue });
                
                showToast("WAITING FOR CONFIRMATION...");
                const receipt = await tx.wait();
                
                const secrets = JSON.parse(localStorage.getItem(`${currentChain}_gambits`) || '{}');
                secrets[hash] = { 
                    move: selectedMoveIdx, 
                    salt: salt,
                    gameId: nextGameId.toString(),
                    address: userAddress.toLowerCase(),
                    chain: currentChain
                };
                localStorage.setItem(`${currentChain}_gambits`, JSON.stringify(secrets));

                let gameId = Number(nextGameId);

                try {
                    for (const log of receipt.logs) {
                        try {
                            if (log.address.toLowerCase() !== CONTRACT_ADDR.toLowerCase()) continue;
                            
                            const parsed = contract.interface.parseLog({
                                topics: log.topics,
                                data: log.data
                            });
                            
                            if (parsed && parsed.name === 'GameCreated') {
                                gameId = Number(parsed.args.gameId);
                                break;
                            }
                        } catch(e) { continue; }
                    }
                } catch (e) { 
                    console.warn("Log parsing failed:", e); 
                }

                const { error: sbError } = await _supabase.from('games')
                    .upsert([{
                        game_id: gameId,
                        host: userAddress.toLowerCase(),
                        wager: wagerInput,
                        timeout: parseInt(timeoutValue),
                        status: 0,
                        commit_hash: hash,
                        chain: currentChain
                    }], {
                        onConflict: 'game_id,chain'
                    });

                if (sbError) {
                    console.error("Supabase error:", sbError);
                    showToast("‚ö†Ô∏è GAME CREATED BUT INDEX FAILED");
                } else {
                    showToast("‚úì SIGNAL DEPLOYED");
                }

                setTimeout(async () => {
                    await refreshLobby();
                    createBtn.disabled = false;
                }, 2000);
                
            } catch (err) { 
                console.error("Game Creation Error:", err);
                showToast("DEPLOYMENT ABORTED");
                createBtn.disabled = false;
            }
        }

        async function refreshLobby() {
            const lobby = document.getElementById('lobby-list');
            try {
                const { data: games, error } = await _supabase.from('games')
                    .select('*')
                    .eq('chain', currentChain)
                    .order('game_id', { ascending: false })
                    .limit(100);

                if (error) {
                    console.error("Supabase Error:", error);
                    lobby.innerHTML = `<div class="text-center py-20 text-red-500 uppercase">Indexing Error</div>`;
                    return;
                }

                lobby.innerHTML = '';
                let displayedCount = 0;

                games.forEach(game => {
                    const status = Number(game.status);
                    const isHost = userAddress && game.host === userAddress.toLowerCase();
                    const isChallenger = userAddress && game.challenger === userAddress.toLowerCase();
                    
                    if (currentLobbyFilter === 'open' && status !== 0) return;
                    if (currentLobbyFilter === 'intercepted' && status !== 1) return;
                    if (currentLobbyFilter === 'resolved' && status !== 2) return;
                    
                    if (status > 1 && !isHost && !isChallenger && currentLobbyFilter === 'all') {
                        return;
                    }

                    displayedCount++;

                    const div = document.createElement('div');
                    const borderColor = status == 0 ? 'var(--primary-color)' : 
                                       status == 1 ? '#eab308' : 
                                       status == 2 ? '#15803d' : '#374151';
                    
                    div.className = "p-4 bg-black/40 border-l-2 flex flex-col md:flex-row justify-between items-center gap-4 transition hover:bg-black/60";
                    div.style.borderLeftColor = borderColor;
                    
                    let countdownHTML = '';
                    if (status === 0 || status === 1) {
                        const createdAt = new Date(game.created_at).getTime() / 1000;
                        const timeout = game.timeout || 900;
                        const deadline = createdAt + timeout;
                        const now = Math.floor(Date.now() / 1000);
                        const remaining = deadline - now;
                        
                        if (remaining > 0) {
                            const minutes = Math.floor(remaining / 60);
                            const seconds = remaining % 60;
                            const timeColor = remaining < 60 ? 'text-red-500' : 'var(--primary-color)';
                            countdownHTML = `<span class="text-[10px] ml-2" style="color: ${timeColor}">‚è± ${minutes}m ${seconds}s</span>`;
                        } else {
                            countdownHTML = `<span class="text-[10px] text-red-500 ml-2 animate-pulse">‚è± TIMEOUT</span>`;
                        }
                    }
                    
                    let gameInfo = `
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1 flex-wrap">
                                <span class="text-[9px] px-2 py-0.5 border uppercase" style="border-color: ${borderColor}; color: ${borderColor}">${getStatusText(status)}</span>
                                <span class="text-[9px] text-gray-500">ID: ${game.game_id}</span>
                                ${countdownHTML}
                            </div>
                            <div class="orbitron text-white text-sm">
                                <span style="color: var(--primary-color)">${game.wager} $${CURRENCY_SYMBOL}</span> 
                                <span class="text-gray-600 text-[10px] ml-2">FROM ${game.host.slice(0,6)}...</span>`;
                    
                    if (status == 2 && game.host_move && game.challenger_move) {
                        const moves = ['', '‚òÄÔ∏è Solar', 'üå¨Ô∏è Oxygen', 'üå™Ô∏è Dust'];
                        const hostMove = Number(game.host_move);
                        const challengerMove = Number(game.challenger_move);
                        
                        let winner = '';
                        if (hostMove === challengerMove) {
                            winner = '‚öñÔ∏è DRAW';
                        } else if (
                            (hostMove === 1 && challengerMove === 2) ||
                            (hostMove === 2 && challengerMove === 3) ||
                            (hostMove === 3 && challengerMove === 1)
                        ) {
                            winner = `üèÜ ${game.host.slice(0,6)}... WINS`;
                        } else {
                            winner = `üèÜ ${(game.challenger || 'Unknown').slice(0,6)}... WINS`;
                        }
                        
                        gameInfo += `
                            <div class="text-[10px] mt-1 text-gray-400">
                                Host: ${moves[hostMove]} vs Challenger: ${moves[challengerMove]}
                            </div>
                            <div class="text-[11px] mt-1 font-bold ${hostMove === challengerMove ? 'text-yellow-500' : 'text-green-500'}">
                                ${winner}
                            </div>`;
                    }
                    
                    gameInfo += `
                            </div>
                        </div>
                        <div class="flex gap-2">${getActionButtons(game, isHost, isChallenger)}</div>`;
                    
                    div.innerHTML = gameInfo;
                    lobby.appendChild(div);
                });
                
                if (displayedCount === 0) {
                    lobby.innerHTML = '<div class="text-center py-20 opacity-30 uppercase italic">No signals detected...</div>';
                }
            } catch (err) { 
                console.error("Lobby Error:", err);
                lobby.innerHTML = `<div class="text-center py-20 text-red-500">Error loading lobby</div>`;
            }
        }

        function setLobbyFilter(filter) {
            currentLobbyFilter = filter;
            document.querySelectorAll('.lobby-filter').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`filter-${filter}`).classList.add('active');
            refreshLobby();
        }

        function getActionButtons(game, isHost, isChallenger) {
            if (game.status == 0) {
                if (isHost) {
                    return `<button onclick="handleRefund(${game.game_id})" class="text-[9px] border border-gray-700 px-4 py-2 hover:bg-white/5 uppercase">Retract</button>`;
                }
                if (userAddress && game.host === userAddress.toLowerCase()) {
                    return `<span class="text-[9px] text-gray-500 uppercase italic">Your Signal</span>`;
                }
                return `<button onclick="handleChallenge(${game.game_id}, '${game.wager}')" class="btn-mars text-[10px] px-6 py-2">Intercept</button>`;
            }
            if (game.status == 1) {
                if (isHost) {
                    return `<button onclick="handleResolve(${game.game_id}, '${game.commit_hash}')" class="btn-mars text-[10px] px-6 py-2 animate-pulse">Broadcast Reveal</button>`;
                }
                if (isChallenger) {
                    const now = Math.floor(Date.now() / 1000);
                    const createdAt = new Date(game.created_at).getTime() / 1000;
                    const timeout = game.timeout || 900;
                    const deadline = createdAt + timeout;
                    
                    if (now >= deadline) {
                        return `<button onclick="handleForceForfeit(${game.game_id})" class="btn-mars text-[10px] px-6 py-2 animate-pulse">Claim Victory</button>`;
                    }
                    return `<span class="text-[9px] uppercase italic" style="color: var(--primary-color)">‚öîÔ∏è Awaiting Host Reveal...</span>`;
                }
                return `<span class="text-[9px] text-gray-600 uppercase italic">Combat Active</span>`;
            }
            if (game.status == 2) return `<span class="text-[9px] text-green-500 uppercase">‚úì Resolved</span>`;
            if (game.status == 3) return `<span class="text-[9px] text-gray-600 uppercase">Refunded</span>`;
            if (game.status == 4) return `<span class="text-[9px] text-red-600 uppercase">‚ö° Forfeited</span>`;
            return `<span class="text-[9px] text-gray-700 uppercase">Inactive</span>`;
        }

        async function handleChallenge(id, wager) {
            if (!signer) return showToast("CONNECT UPLINK FIRST");
            if (!(await checkNetwork())) return;
            
            const move = prompt("Select your move:\n1 - Solar Flare ‚òÄÔ∏è\n2 - Oxygen Siphon üå¨Ô∏è\n3 - Dust Storm üå™Ô∏è");
            if (!move || move < 1 || move > 3) return showToast("INVALID MOVE");
            
            try {
                showToast("INTERCEPTING...");
                const gameData = await contract.games(id);
                const actualWager = gameData.wager;
                
                const tx = await contract.challengeGame(id, move, { value: actualWager });
                showToast("CONFIRMING...");
                await tx.wait();
                
                await _supabase.from('games')
                    .update({ 
                        status: 1, 
                        challenger: userAddress.toLowerCase(),
                        challenger_move: parseInt(move)
                    })
                    .eq('game_id', id)
                    .eq('chain', currentChain);
                
                showToast("‚úì SIGNAL INTERCEPTED");
                setTimeout(refreshLobby, 1500);
            } catch (err) { 
                console.error("Challenge error:", err);
                showToast("INTERCEPTION FAILED"); 
            }
        }

        async function handleResolve(id, hash) {
            if (!signer) return showToast("CONNECT UPLINK FIRST");
            if (!(await checkNetwork())) return;
            
            const secrets = JSON.parse(localStorage.getItem(`${currentChain}_gambits`) || '{}');
            let secret = secrets[hash];
            
            if (!secret) {
                const manualReveal = confirm("Secret not found. Enter manually?");
                if (!manualReveal) {
                    showToast("‚ö†Ô∏è SECRET NOT FOUND");
                    return;
                }
                
                const move = prompt("Enter your move (1-3):");
                const salt = prompt("Enter your salt (hex string):");
                
                if (!move || !salt) return showToast("CANCELLED");
                
                const encoded = ethers.AbiCoder.defaultAbiCoder().encode(
                    ["uint8", "string", "address", "uint256"],
                    [parseInt(move), salt, userAddress, BigInt(id)]
                );
                const testHash = ethers.keccak256(encoded);
                
                if (testHash.toLowerCase() !== hash.toLowerCase()) {
                    return showToast("‚ö†Ô∏è HASH MISMATCH");
                }
                
                secret = { move: parseInt(move), salt: salt, gameId: id.toString() };
            }
            
            try {
                showToast("BROADCASTING REVEAL...");
                const tx = await contract.resolveGame(id, secret.move, secret.salt);
                await tx.wait();
                
                const gameData = await contract.games(id);
                const hostMove = Number(gameData.hostMove);
                const challengerMove = Number(gameData.challengerMove);
                
                let resultMsg = "COMBAT RESOLVED";
                if (hostMove === challengerMove) {
                    resultMsg = "‚öñÔ∏è DRAW";
                } else if (
                    (hostMove === 1 && challengerMove === 2) ||
                    (hostMove === 2 && challengerMove === 3) ||
                    (hostMove === 3 && challengerMove === 1)
                ) {
                    resultMsg = "üèÜ VICTORY!";
                } else {
                    resultMsg = "üí• DEFEAT";
                }
                
                await _supabase.from('games').update({ 
                    status: 2,
                    host_move: hostMove,
                    challenger_move: challengerMove
                }).eq('game_id', id).eq('chain', currentChain);
                
                setTimeout(refreshLobby, 1000);
                updateBalance();
                showToast(resultMsg);
            } catch (err) { 
                console.error("Resolve error:", err);
                showToast("RESOLVE FAILED"); 
            }
        }

        async function handleRefund(id) {
            if (!signer) return showToast("CONNECT UPLINK FIRST");
            if (!(await checkNetwork())) return;
            
            try {
                showToast("RETRACTING...");
                const tx = await contract.refundUnchallenged(id);
                await tx.wait();
                
                await _supabase.from('games').update({ status: 3 }).eq('game_id', id).eq('chain', currentChain);
                refreshLobby();
                updateBalance();
                showToast("FUNDS RETRACTED");
            } catch (err) { 
                console.error(err);
                showToast("REFUND FAILED"); 
            }
        }

        async function handleForceForfeit(gameId) {
            if (!signer) return showToast("CONNECT UPLINK FIRST");
            if (!(await checkNetwork())) return;
            
            try {
                showToast("CLAIMING VICTORY...");
                const tx = await contract.forceForfeit(gameId);
                await tx.wait();
                
                await _supabase.from('games').update({ status: 4 }).eq('game_id', gameId).eq('chain', currentChain);
                refreshLobby();
                updateBalance();
                showToast("üèÜ VICTORY BY FORFEIT!");
            } catch (err) {
                console.error("Forfeit error:", err);
                showToast("FORFEIT FAILED");
            }
        }

        async function refreshActivityFeed() {
            const feed = document.getElementById('activity-feed');
            try {
                const { data: games, error } = await _supabase
                    .from('games')
                    .select('*')
                    .eq('status', 2)
                    .eq('chain', currentChain)
                    .order('updated_at', { ascending: false })
                    .limit(50);

                if (error) {
                    console.error("Activity error:", error);
                    return;
                }

                feed.innerHTML = games.map(game => {
                    const moves = ['', '‚òÄÔ∏è', 'üå¨Ô∏è', 'üå™Ô∏è'];
                    const hostMove = Number(game.host_move);
                    const challengerMove = Number(game.challenger_move);
                    
                    let result = '', resultColor = '';
                    if (hostMove === challengerMove) {
                        result = 'DRAW';
                        resultColor = 'text-yellow-500';
                    } else if (
                        (hostMove === 1 && challengerMove === 2) ||
                        (hostMove === 2 && challengerMove === 3) ||
                        (hostMove === 3 && challengerMove === 1)
                    ) {
                        result = `${game.host.slice(0,6)}... WINS`;
                        resultColor = 'text-green-500';
                    } else {
                        result = `${(game.challenger || 'Unknown').slice(0,6)}... WINS`;
                        resultColor = 'text-green-500';
                    }
                    
                    const timeAgo = getTimeAgo(new Date(game.updated_at || game.created_at));
                    
                    return `
                        <div class="bg-black/40 border-l-2 border-green-700 p-3 flex justify-between items-center hover:bg-black/60 transition">
                            <div class="flex-1">
                                <div class="text-sm ${resultColor} font-bold">${result}</div>
                                <div class="text-[10px] text-gray-500 mt-1">
                                    ${moves[hostMove]} vs ${moves[challengerMove]} ‚Ä¢ ${game.wager} $${CURRENCY_SYMBOL} ‚Ä¢ ${timeAgo}
                                </div>
                            </div>
                            <div class="text-2xl">${result.includes('DRAW') ? '‚öñÔ∏è' : 'üèÜ'}</div>
                        </div>
                    `;
                }).join('') || '<div class="text-center text-gray-600 py-8">No recent activity</div>';
            } catch (err) {
                console.error("Activity error:", err);
            }
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return `${seconds}s ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        }

        async function refreshChat() {
            const chatMessages = document.getElementById('chat-messages');
            try {
                const { data: messages, error } = await _supabase
                    .from('chat_messages')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) return;

                const shouldScroll = chatMessages.scrollHeight - chatMessages.scrollTop === chatMessages.clientHeight;

                chatMessages.innerHTML = messages.reverse().map(msg => {
                    const isOwn = userAddress && msg.sender.toLowerCase() === userAddress.toLowerCase();
                    return `
                        <div class="${isOwn ? 'text-right' : 'text-left'}">
                            <div class="inline-block max-w-[80%] px-3 py-2 rounded" style="background: ${isOwn ? 'rgba(255, 77, 0, 0.3)' : 'rgba(128, 128, 128, 0.3)'}">
                                <div class="text-[9px] mb-1" style="color: var(--primary-color); opacity: 0.7;">${msg.sender.slice(0,6)}...${msg.sender.slice(-4)}</div>
                                <div class="text-sm text-gray-200">${escapeHtml(msg.message)}</div>
                            </div>
                        </div>
                    `;
                }).join('');

                if (shouldScroll) {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            } catch (err) {
                console.error("Chat error:", err);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message || !userAddress) return;
            
            try {
                await _supabase.from('chat_messages').insert([{
                    sender: userAddress.toLowerCase(),
                    message: message
                }]);
                input.value = '';
                refreshChat();
            } catch (err) {
                console.error("Send error:", err);
                showToast("MESSAGE FAILED");
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function loadLeaderboard() {
            try {
                const { data: games, error } = await _supabase
                    .from('games')
                    .select('*')
                    .eq('status', 2)
                    .eq('chain', currentChain);

                if (error) return;

                const playerStats = {};
                let totalWagered = 0, totalBurnt = 0, totalTreasury = 0;

                games.forEach(game => {
                    const wager = parseFloat(game.wager);
                    totalWagered += wager * 2;
                    const pot = wager * 2;
                    totalBurnt += pot * 0.015;
                    totalTreasury += pot * 0.015;

                    [game.host, game.challenger].forEach(addr => {
                        if (!addr) return;
                        if (!playerStats[addr]) {
                            playerStats[addr] = {
                                address: addr,
                                totalWagered: 0,
                                wins: 0,
                                losses: 0,
                                draws: 0,
                                games: 0,
                                biggestPot: 0,
                                longestStreak: 0
                            };
                        }
                        playerStats[addr].totalWagered += wager;
                        playerStats[addr].games++;
                        if (wager * 2 > playerStats[addr].biggestPot) {
                            playerStats[addr].biggestPot = wager * 2;
                        }
                    });

                    const hostMove = Number(game.host_move);
                    const challengerMove = Number(game.challenger_move);

                    if (hostMove === challengerMove) {
                        playerStats[game.host].draws++;
                        if (game.challenger) playerStats[game.challenger].draws++;
                    } else {
                        const hostWins = (
                            (hostMove === 1 && challengerMove === 2) ||
                            (hostMove === 2 && challengerMove === 3) ||
                            (hostMove === 3 && challengerMove === 1)
                        );
                        if (hostWins) {
                            playerStats[game.host].wins++;
                            if (game.challenger) playerStats[game.challenger].losses++;
                        } else if (game.challenger) {
                            playerStats[game.challenger].wins++;
                            playerStats[game.host].losses++;
                        }
                    }
                });

                document.getElementById('global-wagered').textContent = totalWagered.toFixed(2);
                document.getElementById('global-burnt').textContent = totalBurnt.toFixed(2);
                document.getElementById('global-treasury').textContent = totalTreasury.toFixed(2);
                document.getElementById('global-games').textContent = games.length;

                const leaderboard = Object.values(playerStats)
                    .sort((a, b) => b.totalWagered - a.totalWagered)
                    .slice(0, 50);

                const tbody = document.getElementById('leaderboard-body');
                tbody.innerHTML = leaderboard.map((player, index) => {
                    const winRate = player.games > 0 ? ((player.wins / player.games) * 100).toFixed(1) : 0;
                    return `
                        <tr class="border-b border-gray-900/30 hover:brightness-110 cursor-pointer transition" onclick="showPlayerProfile('${player.address}')">
                            <td class="p-3 orbitron" style="color: var(--primary-color)">#${index + 1}</td>
                            <td class="p-3">
                                <div class="text-sm text-white">${player.address.slice(0,8)}...${player.address.slice(-6)}</div>
                                <div class="text-[10px] text-gray-600">${player.games} games</div>
                            </td>
                            <td class="p-3 text-right orbitron" style="color: var(--primary-color)">${player.totalWagered.toFixed(2)}</td>
                            <td class="p-3 text-right orbitron ${winRate >= 50 ? 'text-green-500' : 'text-red-500'}">${winRate}%</td>
                            <td class="p-3 text-right orbitron" style="color: var(--primary-color)">${player.biggestPot.toFixed(2)}</td>
                            <td class="p-3 text-right orbitron text-yellow-500">${player.longestStreak || 0}</td>
                        </tr>
                    `;
                }).join('');
            } catch (err) {
                console.error("Leaderboard error:", err);
            }
        }

        async function showPlayerProfile(address) {
            const modal = document.getElementById('player-modal');
            const content = document.getElementById('player-modal-content');
            
            modal.classList.add('active');
            content.innerHTML = '<div class="text-center py-8" style="color: var(--primary-color)">Loading...</div>';

            try {
                const { data: games, error } = await _supabase
                    .from('games')
                    .select('*')
                    .eq('status', 2)
                    .eq('chain', currentChain)
                    .or(`host.eq.${address.toLowerCase()},challenger.eq.${address.toLowerCase()}`)
                    .order('game_id', { ascending: false });

                if (error) throw error;

                let wins = 0, losses = 0, draws = 0;
                let totalWagered = 0, biggestPot = 0, longestStreak = 0, currentStreak = 0;
                const recentGames = [];

                games.forEach(game => {
                    const isHost = game.host === address.toLowerCase();
                    const wager = parseFloat(game.wager);
                    totalWagered += wager;
                    if (wager * 2 > biggestPot) biggestPot = wager * 2;

                    const hostMove = Number(game.host_move);
                    const challengerMove = Number(game.challenger_move);

                    let result = '';
                    if (hostMove === challengerMove) {
                        draws++;
                        result = 'DRAW';
                        currentStreak = 0;
                    } else {
                        const hostWins = (
                            (hostMove === 1 && challengerMove === 2) ||
                            (hostMove === 2 && challengerMove === 3) ||
                            (hostMove === 3 && challengerMove === 1)
                        );
                        
                        if ((isHost && hostWins) || (!isHost && !hostWins)) {
                            wins++;
                            result = 'WIN';
                            currentStreak++;
                            if (currentStreak > longestStreak) longestStreak = currentStreak;
                        } else {
                            losses++;
                            result = 'LOSS';
                            currentStreak = 0;
                        }
                    }

                    recentGames.push({ ...game, result, isHost });
                });

                const totalGames = games.length;
                const winRate = totalGames > 0 ? ((wins / totalGames) * 100).toFixed(1) : 0;

                content.innerHTML = `
                    <div class="space-y-6">
                        <div class="text-center pb-4 border-b" style="border-color: rgba(255, 77, 0, 0.3);">
                            <div class="text-sm text-gray-500 mb-2">ADDRESS</div>
                            <div class="orbitron text-lg" style="color: var(--primary-color)">${address.slice(0,12)}...${address.slice(-10)}</div>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div class="bg-black/40 border p-4 text-center" style="border-color: rgba(255, 77, 0, 0.3);">
                                <div class="text-[10px] uppercase mb-2" style="color: var(--primary-color); opacity: 0.5;">Games</div>
                                <div class="orbitron text-2xl" style="color: var(--primary-color)">${totalGames}</div>
                            </div>
                            <div class="bg-black/40 border border-green-900/30 p-4 text-center">
                                <div class="text-[10px] text-green-800 uppercase mb-2">Wins</div>
                                <div class="orbitron text-2xl text-green-500">${wins}</div>
                            </div>
                            <div class="bg-black/40 border border-red-900/30 p-4 text-center">
                                <div class="text-[10px] text-red-800 uppercase mb-2">Losses</div>
                                <div class="orbitron text-2xl text-red-500">${losses}</div>
                            </div>
                            <div class="bg-black/40 border border-yellow-900/30 p-4 text-center">
                                <div class="text-[10px] text-yellow-800 uppercase mb-2">Draws</div>
                                <div class="orbitron text-2xl text-yellow-500">${draws}</div>
                            </div>
                            <div class="bg-black/40 border p-4 text-center" style="border-color: rgba(255, 77, 0, 0.3);">
                                <div class="text-[10px] uppercase mb-2" style="color: var(--primary-color); opacity: 0.5;">Win Rate</div>
                                <div class="orbitron text-2xl" style="color: var(--primary-color)">${winRate}%</div>
                            </div>
                            <div class="bg-black/40 border p-4 text-center" style="border-color: rgba(255, 77, 0, 0.3);">
                                <div class="text-[10px] uppercase mb-2" style="color: var(--primary-color); opacity: 0.5;">Wagered</div>
                                <div class="orbitron text-xl" style="color: var(--primary-color)">${totalWagered.toFixed(2)}</div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-black/40 border p-4 text-center" style="border-color: rgba(255, 77, 0, 0.3);">
                                <div class="text-[10px] uppercase mb-2" style="color: var(--primary-color); opacity: 0.5;">Biggest Pot</div>
                                <div class="orbitron text-xl" style="color: var(--primary-color)">${biggestPot.toFixed(2)}</div>
                            </div>
                            <div class="bg-black/40 border border-yellow-900/30 p-4 text-center">
                                <div class="text-[10px] text-yellow-800 uppercase mb-2">Longest Streak</div>
                                <div class="orbitron text-xl text-yellow-500">${longestStreak}</div>
                            </div>
                        </div>

                        <div>
                            <h3 class="orbitron mb-3" style="color: var(--primary-color)">RECENT BATTLES</h3>
                            <div class="space-y-2 max-h-60 overflow-y-auto">
                                ${recentGames.slice(0, 10).map(game => {
                                    const moves = ['', '‚òÄÔ∏è', 'üå¨Ô∏è', 'üå™Ô∏è'];
                                    return `
                                        <div class="bg-black/40 border-l-2 border-${game.result === 'WIN' ? 'green' : game.result === 'LOSS' ? 'red' : 'yellow'}-700 p-3 flex justify-between items-center">
                                            <div>
                                                <span class="text-[10px] px-2 py-0.5 border border-${game.result === 'WIN' ? 'green' : game.result === 'LOSS' ? 'red' : 'yellow'}-500 text-${game.result === 'WIN' ? 'green' : game.result === 'LOSS' ? 'red' : 'yellow'}-500">${game.result}</span>
                                                <div class="text-sm mt-1">
                                                    <span style="color: var(--primary-color)">${game.wager} $${CURRENCY_SYMBOL}</span>
                                                    <span class="text-gray-600 text-[10px] ml-2">Game #${game.game_id}</span>
                                                </div>
                                            </div>
                                            <div class="text-2xl">${game.isHost ? moves[game.host_move] : moves[game.challenger_move]}</div>
                                        </div>
                                    `;
                                }).join('') || '<div class="text-center text-gray-600 py-4">No battles yet</div>'}
                            </div>
                        </div>
                    </div>
                `;
            } catch (err) {
                console.error("Profile error:", err);
                content.innerHTML = '<div class="text-center text-red-500 py-8">Error loading profile</div>';
            }
        }

        function closePlayerModal() {
            document.getElementById('player-modal').classList.remove('active');
        }

        async function loadBridge() {
            if (userAddress) {
                await updateAvaxErolBalance();
            }
        }

        async function updateAvaxErolBalance() {
            try {
                avaxProvider = new ethers.JsonRpcProvider('https://api.avax.network/ext/bc/C/rpc');
                const erolContract = new ethers.Contract(EROL_TOKEN_ADDR, ERC20_ABI, avaxProvider);
                const balance = await erolContract.balanceOf(userAddress);
                avaxErolBalance = parseFloat(ethers.formatEther(balance));
                document.getElementById('avax-erol-balance').textContent = avaxErolBalance.toFixed(4) + ' $EROL';
            } catch (err) {
                console.error("AVAX balance error:", err);
                document.getElementById('avax-erol-balance').textContent = '-- $EROL';
            }
        }

        function updateBridgeEstimate() {
            const amount = parseFloat(document.getElementById('bridge-amount').value) || 0;
            const bridgeBtn = document.getElementById('bridge-btn');
            
            if (amount >= 1 && amount <= avaxErolBalance) {
                bridgeBtn.disabled = false;
                document.getElementById('martian-erol-receive').textContent = amount.toFixed(4) + ' $EROL';
            } else {
                bridgeBtn.disabled = true;
                document.getElementById('martian-erol-receive').textContent = '-- $EROL';
            }
        }

        function setMaxBridge() {
            if (avaxErolBalance > 0) {
                document.getElementById('bridge-amount').value = avaxErolBalance.toFixed(4);
                updateBridgeEstimate();
            } else {
                showToast("INSUFFICIENT BALANCE");
            }
        }

        async function handleBridge() {
            if (!userAddress) {
                showToast("CONNECT WALLET FIRST");
                return;
            }
            
            const amount = parseFloat(document.getElementById('bridge-amount').value);
            
            if (!amount || amount < 1) {
                showToast("MINIMUM 1 $EROL");
                return;
            }
            
            if (amount > avaxErolBalance) {
                showToast("INSUFFICIENT BALANCE");
                return;
            }
            
            document.getElementById('bridge-status').classList.remove('hidden');
            document.getElementById('bridge-btn').disabled = true;
            
            try {
                updateBridgeStatus('Switching to Avalanche C-Chain...');
                
                const currentChainId = await window.ethereum.request({ method: 'eth_chainId' });
                
                if (currentChainId !== AVAX_CHAIN_ID) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: AVAX_CHAIN_ID }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: AVAX_CHAIN_ID,
                                    chainName: 'Avalanche Network',
                                    nativeCurrency: { name: 'AVAX', symbol: 'AVAX', decimals: 18 },
                                    rpcUrls: ['https://api.avax.network/ext/bc/C/rpc'],
                                    blockExplorerUrls: ['https://snowtrace.io/']
                                }]
                            });
                        } else {
                            throw switchError;
                        }
                    }
                }
                
                updateBridgeStatus('Approving $EROL for bridge...');
                
                const avaxSigner = await (new ethers.BrowserProvider(window.ethereum)).getSigner();
                const erolContract = new ethers.Contract(EROL_TOKEN_ADDR, ERC20_ABI, avaxSigner);
                const bridgeContract = new ethers.Contract(BRIDGE_CONTRACT_ADDR, BRIDGE_ABI, avaxSigner);
                
                const amountWei = ethers.parseEther(amount.toString());
                
                const allowance = await erolContract.allowance(userAddress, BRIDGE_CONTRACT_ADDR);
                
                if (allowance < amountWei) {
                    updateBridgeStatus('Confirm approval in wallet...');
                    const approveTx = await erolContract.approve(BRIDGE_CONTRACT_ADDR, amountWei);
                    updateBridgeStatus('Waiting for approval confirmation...');
                    await approveTx.wait();
                }
                
                updateBridgeStatus('Initiating bridge transfer...');
                updateBridgeStatus('Confirm transaction in wallet...');
                
                const bridgeTx = await bridgeContract.bridgeToMartian(amountWei);
                
                updateBridgeStatus('Processing bridge transaction...');
                await bridgeTx.wait();
                
                updateBridgeStatus('Bridge completed! ‚úì');
                
                setTimeout(() => {
                    document.getElementById('bridge-status').classList.add('hidden');
                    document.getElementById('bridge-btn').disabled = false;
                    showToast('üåâ BRIDGE SUCCESSFUL');
                    checkNetwork();
                }, 2000);
                
            } catch (error) {
                console.error("Bridge error:", error);
                
                let errorMsg = "BRIDGE FAILED";
                if (error.message && error.message.includes('user rejected')) {
                    errorMsg = "TRANSACTION REJECTED";
                } else if (error.message && error.message.includes('insufficient funds')) {
                    errorMsg = "INSUFFICIENT FUNDS";
                }
                
                showToast(errorMsg);
                document.getElementById('bridge-status').classList.add('hidden');
                document.getElementById('bridge-btn').disabled = false;
            }
        }

        function updateBridgeStatus(message) {
            document.getElementById('bridge-status-text').textContent = message;
        }

        async function loadProfile() {
            const profileContent = document.getElementById('profile-content');
            
            if (!userAddress) {
                profileContent.innerHTML = `
                    <div class="text-center py-20">
                        <div class="text-6xl mb-4" style="color: var(--primary-color); opacity: 0.3;">üîí</div>
                        <div class="orbitron text-lg mb-2" style="color: var(--primary-color)">UPLINK REQUIRED</div>
                        <div class="text-gray-500 text-sm">Connect your wallet to view pilot statistics</div>
                    </div>`;
                return;
            }
            
            profileContent.innerHTML = `
                <div class="text-center py-20">
                    <div class="animate-pulse" style="color: var(--primary-color)">Loading pilot data...</div>
                </div>`;
            
            try {
                const { data: games, error } = await _supabase
                    .from('games')
                    .select('*')
                    .eq('chain', currentChain)
                    .or(`host.eq.${userAddress.toLowerCase()},challenger.eq.${userAddress.toLowerCase()}`)
                    .order('game_id', { ascending: false });
                
                if (error) {
                    console.error("Profile error:", error);
                    profileContent.innerHTML = `<div class="text-red-500">Error loading profile</div>`;
                    return;
                }
                
                let totalGames = 0, wins = 0, losses = 0, draws = 0;
                let totalWagered = 0, totalWon = 0;
                const recentGames = [];
                
                games.forEach(game => {
                    const isHost = game.host === userAddress.toLowerCase();
                    const wager = parseFloat(game.wager);
                    
                    if (game.status === 2 && game.host_move && game.challenger_move) {
                        totalGames++;
                        totalWagered += wager;
                        
                        const hostMove = Number(game.host_move);
                        const challengerMove = Number(game.challenger_move);
                        
                        let result = '';
                        if (hostMove === challengerMove) {
                            draws++;
                            result = 'DRAW';
                            totalWon += wager * 0.97;
                        } else {
                            const hostWins = (
                                (hostMove === 1 && challengerMove === 2) ||
                                (hostMove === 2 && challengerMove === 3) ||
                                (hostMove === 3 && challengerMove === 1)
                            );
                            
                            if ((isHost && hostWins) || (!isHost && !hostWins)) {
                                wins++;
                                result = 'WIN';
                                totalWon += wager * 2 * 0.97;
                            } else {
                                losses++;
                                result = 'LOSS';
                            }
                        }
                        
                        recentGames.push({ ...game, result, isHost });
                    }
                });
                
                const netPnL = totalWon - totalWagered;
                const winRate = totalGames > 0 ? ((wins / totalGames) * 100).toFixed(1) : 0;
                
                profileContent.innerHTML = `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-black/40 border p-6 text-center" style="border-color: rgba(255, 77, 0, 0.3);">
                            <div class="text-[10px] uppercase mb-2" style="color: var(--primary-color); opacity: 0.5;">Games</div>
                            <div class="orbitron text-3xl" style="color: var(--primary-color)">${totalGames}</div>
                        </div>
                        <div class="bg-black/40 border border-green-900/30 p-6 text-center">
                            <div class="text-[10px] text-green-800 uppercase mb-2">Wins</div>
                            <div class="orbitron text-3xl text-green-500">${wins}</div>
                        </div>
                        <div class="bg-black/40 border border-red-900/30 p-6 text-center">
                            <div class="text-[10px] text-red-800 uppercase mb-2">Losses</div>
                            <div class="orbitron text-3xl text-red-500">${losses}</div>
                        </div>
                        <div class="bg-black/40 border border-yellow-900/30 p-6 text-center">
                            <div class="text-[10px] text-yellow-800 uppercase mb-2">Draws</div>
                            <div class="orbitron text-3xl text-yellow-500">${draws}</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <div class="bg-black/40 border p-6" style="border-color: rgba(255, 77, 0, 0.3);">
                            <div class="text-[10px] uppercase mb-2" style="color: var(--primary-color); opacity: 0.5;">Win Rate</div>
                            <div class="orbitron text-2xl" style="color: var(--primary-color)">${winRate}%</div>
                        </div>
                        <div class="bg-black/40 border p-6" style="border-color: rgba(255, 77, 0, 0.3);">
                            <div class="text-[10px] uppercase mb-2" style="color: var(--primary-color); opacity: 0.5;">Wagered</div>
                            <div class="orbitron text-2xl" style="color: var(--primary-color)">${totalWagered.toFixed(2)}</div>
                        </div>
                        <div class="bg-black/40 border p-6" style="border-color: ${netPnL >= 0 ? 'rgba(34, 197, 94, 0.3)' : 'rgba(239, 68, 68, 0.3)'};">
                            <div class="text-[10px] uppercase mb-2" style="color: ${netPnL >= 0 ? '#22c55e' : '#ef4444'}; opacity: 0.5;">Net P&L</div>
                            <div class="orbitron text-2xl" style="color: ${netPnL >= 0 ? '#22c55e' : '#ef4444'}">${netPnL >= 0 ? '+' : ''}${netPnL.toFixed(2)}</div>
                        </div>
                    </div>
                    
                    <h3 class="orbitron mb-4" style="color: var(--primary-color)">RECENT BATTLES</h3>
                    <div class="space-y-3">
                        ${recentGames.slice(0, 10).map(game => {
                            const moves = ['', '‚òÄÔ∏è', 'üå¨Ô∏è', 'üå™Ô∏è'];
                            return `
                                <div class="bg-black/40 border-l-2 border-${game.result === 'WIN' ? 'green' : game.result === 'LOSS' ? 'red' : 'yellow'}-700 p-4 flex justify-between">
                                    <div>
                                        <span class="text-[10px] px-2 py-0.5 border border-${game.result === 'WIN' ? 'green' : game.result === 'LOSS' ? 'red' : 'yellow'}-500 text-${game.result === 'WIN' ? 'green' : game.result === 'LOSS' ? 'red' : 'yellow'}-500">${game.result}</span>
                                        <div class="text-sm mt-1">
                                            <span style="color: var(--primary-color)">${game.wager} $${CURRENCY_SYMBOL}</span>
                                            <span class="text-gray-600 text-[10px] ml-2">Game #${game.game_id}</span>
                                        </div>
                                    </div>
                                    <div class="text-2xl">${game.isHost ? moves[game.host_move] : moves[game.challenger_move]}</div>
                                </div>
                            `;
                        }).join('') || '<div class="text-center text-gray-600 py-8">No battles yet</div>'}
                    </div>
                `;
            } catch (err) {
                console.error("Profile error:", err);
                profileContent.innerHTML = `<div class="text-red-500">Error: ${err.message}</div>`;
            }
        }
        
        function getStatusText(s) { 
            return ["Open", "Intercepted", "Resolved", "Refunded", "Forfeited"][s]; 
        }
        
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            document.querySelectorAll('.page-section').forEach(section => section.classList.remove('active'));
            document.getElementById(`page-${tab}`).classList.add('active');
            
            if (tab === 'profile') loadProfile();
            if (tab === 'bridge') loadBridge();
            if (tab === 'leaderboard') loadLeaderboard();
        }
        
        function debugInfo() {
            const secrets = JSON.parse(localStorage.getItem(`${currentChain}_gambits`) || '{}');
            console.log("=== DEBUG INFO ===");
            console.log("Chain:", currentChain);
            console.log("Address:", userAddress);
            console.log("Contract:", CONTRACT_ADDR);
            console.log("Secrets:", Object.keys(secrets).length);
            alert("Debug info in console (F12)");
        }
        
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('translate-y-32');
            setTimeout(() => t.classList.add('translate-y-32'), 4000);
        }
        
        window.onload = init;
        
        window.onbeforeunload = () => {
            if (lobbyRefreshInterval) clearInterval(lobbyRefreshInterval);
            if (activityRefreshInterval) clearInterval(activityRefreshInterval);
            if (chatRefreshInterval) clearInterval(chatRefreshInterval);
        };
    </script>
</body>
</html>
